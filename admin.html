<!DOCTYPE html>
<html lang="de">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin - EisFavorit Builder</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #000000;
      --primary-hover: #1f2937;
      --primary-light: #f1f5f9;
      --bg-body: #ffffff;
      --bg-card: #ffffff;
      --white: #ffffff;
      --text-main: #000000;
      --text-muted: #1f2937;
      --border: #e2e8f0;
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 20px;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 20px 25px -5px rgb(0 0 0 / 0.1);
      --glass: #ffffff;
      --glass-border: #e2e8f0;
      --accent-success: #10b981;
      --accent-warning: #f59e0b;
      --accent-danger: #ef4444;
      --sidebar-width: 300px;
    }

    body.dark-mode {
      --bg-body: #0f172a;
      --bg-card: #1e293b;
      --text-main: #f1f5f9;
      --text-muted: #94a3b8;
      --border: #334155;
      --sidebar-bg: #1e293b;
      --text-primary: #f8fafc;
      --text-secondary: #cbd5e1;
      --border-color: #334155;
      --item-hover: #334155;
    }

    /* --- COMPACT REDESIGN --- */
    :root {
      --sidebar-bg: #ffffff;
      --sidebar-width: 220px;
      /* Smaller sidebar */
      --item-hover: #f3f4f6;
      --text-primary: #111827;
      --text-secondary: #6b7280;
      --border-color: #e5e7eb;
      --blue-action: #2563eb;
    }

    * {
      box-sizing: border-box;
      font-family: 'Plus Jakarta Sans', sans-serif;
      scrollbar-width: thin;
      scrollbar-color: var(--primary) transparent;
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background-color: var(--primary);
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background-color: var(--primary-hover);
    }

    body {
      margin: 0;
      background: var(--bg-body);
      color: var(--text-main);
      display: flex;
      height: 100vh;
      overflow: hidden;
      letter-spacing: -0.01em;
    }

    .hidden {
      display: none !important;
    }

    /* Login Screen */
    #loginCard {
      position: fixed;
      inset: 0;
      background: #f8fafc;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .login-box {
      background: #ffffff;
      padding: 3.5rem;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-lg);
      width: 100%;
      max-width: 440px;
      text-align: center;
      animation: fadeIn 0.5s ease-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Main Dashboard Layout */
    #dashboard {
      display: flex;
      width: 100%;
      height: 100vh;
      background: var(--bg-body);
    }

    /* Sidebar */
    .sidebar {
      width: var(--sidebar-width);
      background: var(--sidebar-bg);
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      height: 100vh;
      position: relative;
      z-index: 100;
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @media (max-width: 900px) {
      body {
        flex-direction: column;
        height: auto;
        overflow-y: auto;
      }

      #dashboard {
        flex-direction: column;
        height: auto;
      }

      .sidebar {
        width: 100%;
        height: auto;
        max-height: 300px;
        /* Allow content to be seen below */
        border-right: none;
        border-bottom: 1px solid var(--border-color);
        flex-shrink: 0;
      }

      .content-area {
        height: auto;
        min-height: 100vh;
        width: 100%;
      }

      #bookingsList {
        overflow-x: auto;
      }
    }

    body.sidebar-collapsed .sidebar {
      width: 0;
      overflow: hidden;
      border-right: none;
    }

    .sidebar-header {
      padding: 0.75rem 1rem;
      /* Compact header */
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: #fff;
    }

    .sidebar-header-back {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 0.7rem;
    }

    .sidebar-header .sidebar-toggle-btn {
      margin-left: auto;
    }

    .sidebar-header-title {
      display: flex;
      flex-direction: column;
    }

    .sidebar-header h2 {
      font-size: 0.85rem;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0;
    }

    .sidebar-header span {
      font-size: 0.65rem;
      color: var(--text-secondary);
    }

    .sidebar-nav-title {
      padding: 1.5rem 1.25rem 0.5rem;
      font-size: 0.7rem;
      font-weight: 800;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    .sidebar-sections-list {
      margin-top: 1rem;
      padding: 0 0.75rem;
    }

    .sidebar-section-list-container {
      padding: 1rem;
      flex: 1;
      overflow-y: auto;
    }

    .sidebar-label {
      font-size: 0.75rem;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 0.75rem;
      padding-left: 0.5rem;
    }

    .sidebar-section-item {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      padding: 0.4rem 0.6rem;
      margin-bottom: 3px;
      border-radius: 6px;
      cursor: pointer;
      background: transparent;
      border: none;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      color: var(--text-primary);
      width: 100%;
      text-align: left;
    }

    .sidebar-section-item:hover {
      background: var(--item-hover);
    }

    .sidebar-section-item.active {
      background: #eff6ff;
      color: var(--blue-action);
    }

    .section-number {
      width: 18px;
      height: 18px;
      background: #f3f4f6;
      border-radius: 3px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.65rem;
      font-weight: 600;
      color: var(--text-secondary);
    }

    .sidebar-section-item.active .section-number {
      background: #dbeafe;
      color: var(--blue-action);
    }

    .section-name {
      font-size: 0.75rem;
      font-weight: 500;
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      transition: opacity 0.2s;
    }

    .section-more {
      color: var(--text-secondary);
      opacity: 0;
      font-size: 0.9rem;
      padding: 4px;
      border-radius: 4px;
    }

    .sidebar-section-item:hover .section-more {
      opacity: 1;
    }

    .section-more:hover {
      background: rgba(0, 0, 0, 0.05);
      color: var(--text-primary);
    }

    .add-section-btn {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      color: var(--text-secondary);
      padding: 0.5rem 0.75rem;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      border-radius: 6px;
      margin-top: 0.5rem;
    }

    .add-section-btn:hover {
      background: var(--item-hover);
      color: var(--text-primary);
    }

    .sidebar-nav {
      flex: 1;
      padding: 1rem;
      overflow-y: auto;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.85rem 1.25rem;
      border-radius: var(--radius-md);
      cursor: pointer;
      color: var(--text-muted);
      transition: all 0.2s ease;
      margin-bottom: 0.25rem;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .nav-item i {
      width: 20px;
      text-align: center;
      font-size: 1.1rem;
    }

    .nav-item:hover {
      background: #f1f5f9;
      color: var(--text-main);
    }

    .nav-item.active {
      background: #000000;
      color: #ffffff;
    }

    .sidebar-footer {
      padding: 1.5rem;
      border-top: 1px solid var(--border);
    }

    .bottom-nav {
      border-top: 1px solid var(--border-color);
      padding: 1rem;
      background: #fff;
    }

    .nav-item-clean {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.5rem 0.75rem;
      color: var(--text-secondary);
      font-size: 0.85rem;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      margin: 0.1rem 0;
      position: relative;
      overflow: hidden;
    }

    .nav-item-clean:hover {
      background: var(--item-hover);
      color: var(--text-primary);
      padding-left: 0.9rem;
    }

    .nav-item-clean.active {
      background: #f1f5f9;
      color: var(--blue-action);
      font-weight: 700;
    }

    .nav-item-clean i {
      width: 20px;
      min-width: 20px;
      text-align: center;
      font-size: 1rem;
      transition: transform 0.2s;
    }

    .nav-item-clean:hover i {
      transform: scale(1.1);
    }

    /* Drag and Drop Feedback */
    .draggable-row.dragging {
      opacity: 0.4;
      background: #f1f5f9 !important;
    }

    .draggable-row.over {
      border-top: 2px solid var(--primary) !important;
      background: #f8fafc;
    }

    .drag-handle {
      color: #cbd5e1;
      cursor: grab;
      padding: 0.4rem;
    }

    /* Content Area */
    .content-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: #f8fafc;
    }

    .section-header {
      background: #ffffff;
      border-bottom: 1px solid var(--border);
      padding: 0.5rem 1rem;
      display: flex;
      flex-direction: column;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      height: 55px;
      /* STRICT ONE LINE */
      overflow: visible;
      /* Prevent clipping dropdown */
    }

    .ribbon-scroll-container {
      position: relative;
      display: flex;
      width: 100%;
      height: 100%;
      align-items: center;
    }

    .ribbon-row {
      display: flex;
      align-items: center;
      gap: 1.25rem;
      flex-wrap: nowrap;
      /* NO WRAP */
      padding: 0.25rem 0.5rem;
      flex: 1;
      width: 100%;
      overflow: hidden;
      /* Hide anything that doesn't fit */
    }

    .ribbon-expand-btn {
      margin-left: 0.5rem;
      background: var(--blue-action);
      color: white;
      border: none;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      /* Always show as an 'Overflow' button */
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 1010;
      box-shadow: 0 4px 10px rgba(37, 99, 235, 0.3);
      transition: all 0.3s;
      flex-shrink: 0;
    }

    .ribbon-expand-btn:hover {
      transform: scale(1.1);
      background: #1d4ed8;
    }

    /* DROPDOWN MENU */
    .ribbon-dropdown {
      position: absolute;
      top: 45px;
      right: 0;
      background: white;
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
      width: 250px;
      padding: 1rem;
      display: none;
      /* JS toggled */
      flex-direction: column;
      gap: 1.5rem;
      z-index: 10000;
      animation: ribbonSlideDown 0.2s cubic-bezier(0.1, 0.9, 0.2, 1);
    }

    @keyframes ribbonSlideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .ribbon-dropdown.active {
      display: flex;
    }

    .ribbon-dropdown .ribbon-item-container {
      width: 100%;
      align-items: flex-start;
    }

    .ribbon-dropdown .ribbon-group {
      width: 100%;
      justify-content: flex-start;
      flex-wrap: wrap;
      background: #f1f5f9;
      padding: 6px;
    }

    .ribbon-dropdown .ribbon-divider {
      display: none;
      /* Hide horizontal dividers in vertical list */
    }

    .ribbon-dropdown .ribbon-group-label {
      text-align: left;
      margin-bottom: 4px;
      color: #64748b;
    }

    .ribbon-group {
      display: flex;
      align-items: center;
      gap: 2px;
      padding: 2px;
      background: #f8fafc;
      border-radius: 6px;
      border: 1px solid #e2e8f0;
    }

    .ribbon-group-label {
      font-size: 8px;
      /* Tiny label */
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #94a3b8;
      font-weight: 700;
      margin-top: 1px;
      text-align: center;
      width: 100%;
    }

    .ribbon-item-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex-shrink: 0;
      /* Prevent squashing */
    }

    .btn-ribbon {
      height: 30px;
      /* Thinner buttons */
      padding: 0 0.6rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      gap: 0.35rem;
      border: 1px solid transparent;
      transition: all 0.2s;
    }

    .btn-ribbon:hover {
      background: #e2e8f0;
      border-color: #cbd5e1;
    }

    .btn-ribbon i {
      font-size: 0.85rem;
    }

    .btn-ribbon.primary {
      background: var(--blue-action);
      color: white;
      box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2);
    }

    .btn-ribbon.primary:hover {
      background: #1d4ed8;
      transform: translateY(-1px);
    }

    .btn-ribbon.success {
      background: #10b981;
      color: white;
    }

    .btn-ribbon.ghost {
      background: transparent;
      color: var(--text-main);
    }

    .ribbon-divider {
      width: 1px;
      height: 30px;
      background: #e2e8f0;
      margin: 0 0.25rem;
    }

    /* Preview Area */
    .preview-area {
      flex: 1;
      min-width: 380px;
      background: #f1f5f9;
      height: 100%;
      display: flex;
      flex-direction: column;
      border-left: 1px solid var(--border);
      transition: all 0.3s ease;
    }

    .preview-area.hidden {
      display: none !important;
    }

    .sidebar-toggle-btn {
      background: transparent;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      margin-left: auto;
      /* Push to right */
    }

    .sidebar-toggle-btn:hover {
      background: var(--item-hover);
      color: var(--text-main);
    }

    .preview-header {
      padding: 0.75rem 1.25rem;
      background: #ffffff;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.85rem;
      font-weight: 700;
      color: var(--text-muted);
    }

    /* UI Components */
    .card {
      background: #ffffff;
      border-radius: 8px;
      padding: 1rem;
      /* Halved padding */
      border: 1px solid var(--border);
      margin-bottom: 1rem;
      box-shadow: var(--shadow-sm);
    }

    .card:hover {
      border-color: #cbd5e1;
    }

    #scrollable-content {
      flex: 1.2;
      overflow-y: auto;
      padding: 1rem;
      padding-bottom: 300px;
      /* Added substantial padding at the bottom */
      margin: 0;
      min-width: 320px;
    }

    body.preview-collapsed .preview-area {
      width: 0 !important;
      min-width: 0 !important;
      flex: 0 0 0 !important;
      overflow: hidden;
      border-left: none;
    }

    body.preview-narrow .preview-area {
      width: 450px;
    }

    body.zen-mode .sidebar,
    body.zen-mode #resizer-sidebar,
    body.zen-mode #resizer-preview,
    body.zen-mode .content-area {
      display: none !important;
    }

    body.zen-mode .preview-area {
      position: fixed;
      inset: 0;
      width: 100% !important;
      height: 100% !important;
      z-index: 100000;
      border: none;
    }

    body.zen-mode .preview-header {
      padding: 1rem 2rem;
      background: #000;
      color: #fff;
    }

    .zen-toggle-btn {
      background: var(--blue-action);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.2s;
    }

    .zen-toggle-btn:hover {
      background: #1d4ed8;
      transform: translateY(-1px);
    }

    .zen-toggle-btn i {
      font-size: 0.9rem;
    }

    /* --- RESIZABLE LAYOUT --- */
    #dashboard {
      display: flex;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
    }

    .sidebar {
      width: 220px;
      flex-shrink: 0;
      transition: width 0.1s ease;
    }

    .content-area {
      flex: 1;
      /* This will grow to fill space */
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-width: 300px;
    }

    .preview-area {
      /* width: 45%; */
      /* Removed fixed width */
      flex: 0 0 auto;
      /* Start with a healthy split, allow JS to control */
      /* flex-shrink: 0; */
      /* Replaced by flex: 0 0 auto */
      display: flex;
      flex-direction: column;
      background: #f1f5f9;
      border-left: 1px solid var(--border);
      /* transition: width 0.1s ease; */
      /* Removed transition */
      height: 100%;
      /* Ensure full height */
    }

    body.dragging-layout * {
      transition: none !important;
      user-select: none !important;
    }

    .resizer {
      width: 5px;
      cursor: col-resize;
      background: var(--border-color);
      z-index: 1001;
      position: relative;
      flex-shrink: 0;
    }

    .resizer:hover,
    .resizer.dragging {
      background: var(--blue-action);
      width: 8px;
    }

    .resizer::after {
      content: "";
      position: absolute;
      top: 0;
      bottom: 0;
      left: -8px;
      right: -8px;
      /* Bigger hit area */
    }

    #scrollable-content {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
    }

    #previewContainer {
      flex: 1;
      background: #f1f5f9;
      overflow: hidden;
      position: relative;
    }

    #livePreview {
      width: 100%;
      height: 100%;
      border: none;
      background: #fff;
      display: block;
    }

    .preview-mobile #livePreview {
      width: 375px;
      margin: 2rem auto;
      border-radius: 30px;
      border: 10px solid #000;
      height: calc(100% - 4rem);
      box-shadow: var(--shadow-lg);
    }

    /* Form Elements */
    .form-group {
      margin-bottom: 1.25rem;
    }

    label {
      display: block;
      font-weight: 700;
      margin-bottom: 0.5rem;
      color: var(--text-main);
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    input,
    select,
    textarea {
      width: 100%;
      padding: 0.45rem 0.75rem;
      /* Slimmer inputs */
      background: #ffffff;
      border: 1px solid var(--border);
      border-radius: 4px;
      color: #000000;
      font-size: 0.8rem;
      transition: all 0.2s ease;
      font-weight: 500;
    }

    textarea {
      resize: vertical;
      min-height: 80px;
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: var(--text-main);
      background: #ffffff;
      box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.05);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      border-radius: var(--radius-sm);
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid var(--border);
      font-size: 0.85rem;
      letter-spacing: 0.02em;
      background: #ffffff;
      color: var(--text-main);
    }

    .btn:active {
      transform: scale(0.98);
    }

    .btn-primary {
      background: #000000;
      border-color: #000000;
      color: #ffffff;
      font-weight: 800;
    }

    .btn-primary:hover {
      background: #1f2937;
      border-color: #1f2937;
    }

    .btn-success {
      background: #10b981;
      border-color: #10b981;
      color: #000000;
      font-weight: 800;
    }

    .btn-ghost {
      background: transparent;
      color: #000000;
    }

    .btn-ghost:hover {
      background: #f8fafc;
      border-color: #cbd5e1;
    }

    .btn-icon {
      padding: 0.6rem;
      min-width: 38px;
    }

    h1,
    h2,
    h3,
    h4 {
      color: var(--text-main);
      margin-top: 0;
      letter-spacing: -0.02em;
    }

    h2 {
      font-size: 1rem;
      font-weight: 800;
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    h2 i {
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    /* Table Styles */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
    }

    th {
      text-align: left;
      padding: 0.5rem 0.75rem;
      color: var(--text-muted);
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: 2px solid var(--border);
      font-weight: 700;
    }

    td {
      padding: 0.5rem 0.75rem;
      border-bottom: 1px solid var(--border);
      color: var(--text-main);
      font-size: 0.8rem;
    }

    tbody tr:hover td {
      background: #f8fafc;
    }

    .gallery-preview {
      width: 44px;
      height: 44px;
      object-fit: cover;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
    }

    /* Calendar Styles */
    #calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      background: var(--border);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      overflow: hidden;
    }

    .calendar-day {
      aspect-ratio: 1;
      background: #ffffff;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 0.85rem;
      position: relative;
    }

    .calendar-day.today {
      background: #f1f5f9;
      font-weight: 800;
      color: #000;
    }

    .dot-container {
      display: flex;
      gap: 2px;
      position: absolute;
      bottom: 4px;
    }

    .dot {
      width: 4px;
      height: 4px;
      border-radius: 50%;
    }

    /* Responsive */
    /* Booking Layout */
    .booking-layout-grid {
      display: grid;
      grid-template-columns: minmax(400px, 1fr) 1.5fr;
      gap: 2rem;
      align-items: start;
    }

    .calendar-sidebar {
      position: sticky;
      top: 20px;
    }

    #tab-bookings {
      padding: 2rem;
    }

    @media (max-width: 1024px) {
      body {
        flex-direction: column;
        height: auto !important;
        overflow-y: auto !important;
      }

      #dashboard {
        flex-direction: column;
        height: auto !important;
        width: 100%;
        overflow: visible !important;
      }

      .sidebar {
        display: none !important;
      }

      .section-header {
        display: none !important;
      }

      .preview-area {
        display: none !important;
      }

      .resizer {
        display: none !important;
      }

      #floatUpdateBtn {
        display: none !important;
      }

      .content-area {
        width: 100% !important;
        height: auto !important;
        min-height: 100vh !important;
        overflow: visible !important;
        flex: 1 0 auto !important;
      }

      #scrollable-content {
        height: auto !important;
        overflow: visible !important;
        padding-bottom: 100px !important;
        padding-top: 0 !important;
      }

      /* Booking Tab Responsive */
      #tab-bookings {
        padding: 1rem !important;
      }

      .booking-layout-grid {
        grid-template-columns: 1fr !important;
        gap: 1.5rem !important;
      }

      .calendar-sidebar {
        position: static !important;
      }

      .calendar-header {
        padding: 1rem !important;
      }

      .calendar-header h3 {
        font-size: 1.1rem !important;
      }

      .calendar-day-header {
        padding: 0.5rem 0.2rem !important;
        font-size: 0.75rem !important;
      }

      .calendar-day {
        min-height: 45px !important;
      }

      .calendar-date {
        width: 20px !important;
        height: 20px !important;
        font-size: 0.75rem !important;
      }

      .booking-dot {
        font-size: 0.55rem !important;
        padding: 0 2px !important;
      }

      .mobile-header {
        display: flex !important;
      }

      .desktop-only-title {
        display: none !important;
      }
    }

    /* Notifications */
    .notification-host {
      position: fixed;
      bottom: 1.5rem;
      right: 1.5rem;
      z-index: 10002;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .notification {
      background: #ffffff;
      border: 1px solid var(--text-main);
      padding: 1rem 1.5rem;
      border-radius: var(--radius-sm);
      color: var(--text-main);
      box-shadow: var(--shadow-lg);
      display: flex;
      align-items: center;
      gap: 0.75rem;
      animation: slideIn 0.3s ease-out;
      min-width: 280px;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .notification.success i {
      color: #10b981;
    }

    .notification.error i {
      color: #ef4444;
    }

    @keyframes slideIn {
      from {
        transform: translateX(20px);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes highlightPulse {
      0% {
        box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.7);
        transform: scale(1);
      }

      30% {
        box-shadow: 0 0 0 10px rgba(37, 99, 235, 0);
        transform: scale(1.03);
      }

      100% {
        box-shadow: 0 0 0 0 rgba(37, 99, 235, 0);
        transform: scale(1);
      }
    }

    .field-highlight {
      animation: highlightPulse 2s cubic-bezier(0.25, 0.46, 0.45, 0.94) infinite;
      border-color: var(--blue-action) !important;
      z-index: 10;
      position: relative;
    }

    .update-badge {
      position: fixed;
      bottom: 20px;
      left: 300px;
      /* sidebar width + gap */
      z-index: 1000;
    }

    .btn-update-float {
      background: var(--blue-action);
      color: white;
      font-weight: 600;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
      border: none;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
      cursor: pointer;
      transition: transform 0.1s;
    }

    .btn-update-float:active {
      transform: scale(0.98);
    }

    /* Helper to hide old styles if needed */
    .old-nav-hidden {
      display: none;
    }

    .workspace-wrapper {
      display: flex;
      flex: 1;
      overflow: hidden;
      width: 100%;
    }

    /* --- IMPROVED CALENDAR --- */
    .calendar-container {
      background: #ffffff;
      border-radius: 12px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-sm);
      overflow: hidden;
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.5rem;
      background: linear-gradient(to right, #ffffff, #f9fafb);
      border-bottom: 1px solid var(--border);
    }

    .calendar-header h3 {
      margin: 0;
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text-main);
    }

    .calendar-nav-btn {
      background: white;
      border: 1px solid var(--border);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      color: var(--text-muted);
    }

    .calendar-nav-btn:hover {
      background: var(--primary-light);
      color: var(--primary);
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      background: #ffffff;
    }

    .calendar-day-header {
      padding: 1rem 0.5rem;
      text-align: center;
      font-weight: 600;
      font-size: 0.85rem;
      color: var(--text-muted);
      border-bottom: 1px solid var(--border);
      background: #f8fafc;
    }

    /* Compact Calendar */
    .calendar-day {
      min-height: 50px;
      /* Much smaller */
      padding: 0.25rem;
      font-size: 0.8rem;
    }

    .calendar-date {
      width: 24px;
      height: 24px;
      font-size: 0.8rem;
      margin-bottom: 2px;
    }

    .booking-dot {
      padding: 1px 4px;
      font-size: 0.65rem;
      height: auto;
      line-height: 1.2;
    }
  </style>

  <div class="update-badge" id="floatUpdateBtn">
    <button onclick="saveDirectly()" class="btn-update-float">
      <i class="fas fa-save"></i> Speichern
    </button>
  </div>

</head>

<body>
  <div class="notification-host" id="notificationHost"></div>

  <div id="loginCard">
    <div class="login-box">
      <div style="font-size: 3rem; margin-bottom: 1.5rem; color: #000;">
        <i class="fas fa-ice-cream"></i>
      </div>
      <h1>EisFavorit Builder</h1>
      <p style="color: var(--text-muted); margin-bottom: 2rem;">Willkommen zurück! Verwalte deine Inhalte professionell
        und einfach.</p>
      <form id="loginForm">
        <div class="form-group" style="text-align: left;">
          <label>Passwort</label>
          <input id="adminPassword" type="password" required placeholder="••••••••">
        </div>
        <button class="btn btn-primary" type="submit" style="width: 100%; margin-top: 1rem;">
          <i class="fas fa-sign-in-alt"></i> Anmelden
        </button>
        <p id="loginError" style="color:var(--accent-danger); margin-top:1rem; min-height: 1.2rem; font-size: 0.85rem;">
        </p>
      </form>
    </div>
  </div>

  <div id="dashboard" class="hidden">
    <div class="sidebar">
      <!-- Sidebar content ... -->
      <div class="sidebar-header">
        <div class="sidebar-header-back" onclick="switchTab('start')"><i class="fas fa-chevron-left"></i></div>
        <div class="sidebar-header-title">
          <h2>EisFavorit CMS</h2>
          <span>Admin Panel</span>
        </div>
        <button onclick="toggleTheme()" class="sidebar-toggle-btn" title="Design Modus" style="margin-left: auto;">
          <i class="fas fa-sun" id="themeIcon"></i>
        </button>
      </div>
      <div class="sidebar-nav">
        <div class="sidebar-nav-title old-nav-hidden">Navigation</div>
        <div class="nav-item-clean active" onclick="switchTab('start')"><i class="fas fa-home"></i> Dashboard</div>
        <div class="nav-item-clean" onclick="switchTab('bookings')"><i class="fas fa-calendar-alt"></i> Buchungen</div>
        <div class="nav-item-clean" onclick="switchTab('design')"><i class="fas fa-paint-brush"></i> Design</div>

        <div class="sidebar-nav-title"
          style="display: flex; justify-content: space-between; align-items: center; padding-top: 1rem; margin-top: 0.5rem; border-top: 1px solid var(--border);">
          <span>Abschnitte</span>
          <button onclick="switchTab('sections')" class="btn btn-primary"
            style="padding: 4px 8px; font-size: 0.8rem; height: auto; background: var(--blue-action); border: none; color: white; border-radius: 4px;"
            title="Sektionen verwalten">
            <i class="fas fa-plus"></i>
          </button>
        </div>
        <div id="sidebar-sections-container" class="sidebar-section-list-container">
          <!-- Dynamic Sections List -->
        </div>

        <button onclick="switchTab('sections')" class="btn btn-primary"
          style="width: calc(100% - 2rem); margin: 1rem; font-size: 0.85rem; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
          <i class="fas fa-plus"></i> Sektion hinzufügen
        </button>

        <div class="sidebar-nav-title old-nav-hidden">Inhalte</div>
        <div class="nav-item-clean" onclick="switchTab('header')"><i class="fas fa-window-maximize"></i> Header</div>
        <div class="nav-item-clean" onclick="switchTab('gallery')"><i class="fas fa-images"></i> Galerie</div>
        <div class="nav-item-clean" onclick="switchTab('footer')"><i class="fas fa-info-circle"></i> Footer</div>
        <div class="nav-item-clean" onclick="switchTab('social')"><i class="fas fa-share-alt"></i> Social Media</div>
      </div>
      <div class="sidebar-footer bottom-nav">
        <div
          style="margin-bottom: 15px; text-align: center; opacity: 0.9; display: flex; flex-direction: column; align-items: center; gap: 5px;">
          <img id="sidebar-visitor-img"
            src="https://api.visitorbadge.io/api/visitors?path=agnellobaden.github.io/snackoase247&label=BESUCHER&countColor=%2300f2ff&style=flat"
            alt="Visitor Counter" />
          <button onclick="resetVisitorCounter()" class="btn-ghost"
            style="font-size: 0.7rem; padding: 2px 8px; border-radius: 4px; color: var(--text-muted); width: auto;"
            title="Zähler zurücksetzen">
            <i class="fas fa-redo-alt"></i> Reset
          </button>
        </div>
        <button id="logoutBtn" class="btn nav-item-clean" style="width: 100%;">
          <i class="fas fa-sign-out-alt"></i> Abmelden
        </button>
      </div>
    </div>
    <div class="resizer" id="resizer-sidebar"></div>
    <div class="content-area">
      <div class="section-header" id="mainRibbonHeader">
        <div class="ribbon-scroll-container">
          <!-- MAIN ROW (One Line) -->
          <div class="ribbon-row">
            <button onclick="toggleSidebar()" class="btn btn-ribbon ghost" title="Menü umschalten"
              style="margin-right: 0.5rem;">
              <i class="fas fa-bars"></i>
            </button>
            <div style="width: 1px; height: 20px; background: #e2e8f0; margin-right: 0.75rem;"></div>

            <div class="ribbon-item-container">
              <div class="ribbon-group">
                <button onclick="saveDirectly()" class="btn btn-ribbon success"><i class="fas fa-save"></i>
                  Speichern</button>
                <button onclick="switchTab('sections')" class="btn btn-ribbon primary" style="background:#000;"><i
                    class="fas fa-plus-circle"></i> Sektion +</button>
              </div>
              <div class="ribbon-group-label" style="font-size:7px;">Wichtigste Funktionen</div>
            </div>

            <div style="flex: 1;"></div>

            <!-- TITLE (Adapts) -->
            <div class="ribbon-title-area" style="text-align: right; min-width: 80px; margin-right: 45px;">
              <h1 id="currentTabTitle" style="margin:0; font-size:0.85rem; font-weight: 800; color: #1e293b;">Dashboard
              </h1>
              <div style="font-size: 7px; color: #94a3b8; font-weight: 600;">CMS v2.0</div>
            </div>
          </div>

          <!-- OVERFLOW ARROW -->
          <button class="ribbon-expand-btn" onclick="toggleRibbonMenu()" title="Alle Werkzeuge anzeigen">
            <i class="fas fa-ellipsis-v"></i>
          </button>

          <!-- DROPDOWN MENU (The rest) -->
          <div class="ribbon-dropdown" id="ribbonDropdown">
            <!-- GROUP 1: FILE -->
            <div class="ribbon-item-container">
              <div class="ribbon-group">
                <button id="saveDirectlyBtn" onclick="saveDirectly()" class="btn btn-ribbon success"
                  style="display:none;"><i class="fas fa-save"></i> Speichern</button>
                <button id="downloadBtn" class="btn btn-ribbon ghost" title="Als Datei laden"><i
                    class="fas fa-download"></i> Download</button>
                <button id="saveAllBtn" class="btn btn-ribbon primary"><i class="fas fa-rocket"></i> Export</button>
              </div>
              <div class="ribbon-group-label">Datei & System</div>
            </div>

            <!-- GROUP 2: EDIT -->
            <div class="ribbon-item-container">
              <div class="ribbon-group">
                <button id="undoBtn" onclick="undo()" class="btn btn-ribbon ghost" title="Rückgängig" disabled><i
                    class="fas fa-undo"></i></button>
                <button id="redoBtn" onclick="redo()" class="btn btn-ribbon ghost" title="Wiederherstellen" disabled><i
                    class="fas fa-redo"></i></button>
                <button onclick="switchTab('sections')" class="btn btn-ribbon primary" style="background: #000;"><i
                    class="fas fa-plus-circle"></i> Sektion +</button>
              </div>
              <div class="ribbon-group-label">Bearbeiten</div>
            </div>

            <!-- GROUP 3: VIEW -->
            <div class="ribbon-item-container">
              <div class="ribbon-group">
                <!-- Sidebar toggle moved to sidebar header -->
                <div style="display:flex; gap:2px; width:100%; margin-top:4px;">
                  <button onclick="changePreviewSize('none')" class="btn btn-ribbon ghost"><i
                      class="fas fa-eye-slash"></i></button>
                  <button onclick="changePreviewSize('narrow')" class="btn btn-ribbon ghost"><i
                      class="fas fa-mobile-alt"></i></button>
                  <button onclick="changePreviewSize('wide')" class="btn btn-ribbon ghost"><i
                      class="fas fa-desktop"></i></button>
                </div>
              </div>
              <div class="ribbon-group-label">Ansicht</div>
            </div>
          </div>
        </div>
      </div>

      <div id="scrollable-content">
        <!-- Bookings View -->
        <div id="tab-bookings" class="tab-content" style="padding: 2rem;">
          <!-- Mobile Only Header -->
          <div class="mobile-header"
            style="display: none; align-items: center; justify-content: space-between; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border);">
            <div style="display: flex; align-items: center; gap: 0.75rem;">
              <i class="fas fa-ice-cream" style="font-size: 1.5rem;"></i>
              <h2 style="margin:0; font-size: 1.2rem; font-weight: 800;">EisFavorit</h2>
            </div>
            <button onclick="sessionStorage.removeItem('adminAuth'); location.reload();" class="btn btn-ghost"
              style="padding: 0.5rem; font-size: 0.8rem; border: 1px solid var(--border);">
              <i class="fas fa-sign-out-alt"></i> Logout
            </button>
          </div>

          <h2 style="margin-bottom: 2rem; font-size:1.8rem; font-weight:800;" class="desktop-only-title">
            Buchungsmanagement
            <div style="float: right; display: flex; gap: 0.5rem;">
              <button onclick="exportBookings()" class="btn btn-ghost"
                style="border: 1px solid var(--border); padding: 0.5rem 1rem; font-size: 0.85rem;">
                <i class="fas fa-download"></i> Export
              </button>
              <button onclick="document.getElementById('importBookingsInput').click()" class="btn btn-ghost"
                style="border: 1px solid var(--border); padding: 0.5rem 1rem; font-size: 0.85rem;">
                <i class="fas fa-upload"></i> Import
              </button>
              <input type="file" id="importBookingsInput" style="display:none" accept=".json"
                onchange="importBookings(this)">
            </div>
          </h2>
          <div
            style="background: #e0f2fe; padding: 10px; border-radius: 8px; margin-bottom: 20px; font-size: 0.9rem; color: #0369a1; display:flex; gap:10px; align-items:center;">
            <i class="fas fa-info-circle"></i>
            <span>
              <strong>Hinweis zur Synchronisation:</strong> Buchungen werden lokal gespeichert. Wenn du die Seite auf
              GitHub veröffentlichst, nutze "Export", um die Buchungen zu sichern, und "Import", um sie auf einem
              anderen Gerät zu laden.
            </span>
          </div>
          <div class="booking-layout-grid">

            <!-- Left: Calendar (Flexible Width) -->
            <div class="calendar-sidebar">
              <div class="card"
                style="padding:0; overflow:hidden; border: 1px solid var(--border); box-shadow: var(--shadow-sm);">
                <div id="calendar-wrapper"></div>
                <div
                  style="padding: 0.75rem; border-top:1px solid #eee; font-size: 0.75rem; color: #666; display:flex; gap:1rem; justify-content:center; background:#f8fafc;">
                  <span><i class="fas fa-circle" style="color: #10b981;"></i> Fest</span>
                  <span><i class="fas fa-circle" style="color: #f59e0b;"></i> Offen</span>
                </div>
              </div>
              <button onclick="openBookingModal()" class="btn btn-primary"
                style="width: 100%; margin-top: 1rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem; font-size: 0.9rem;">
                <i class="fas fa-plus"></i> Termin eintragen
              </button>
            </div>

            <!-- Right: Inquiries List (Flexible Width) -->
            <div>
              <div
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid #eee;">
                <div>
                  <h3 style="margin:0; font-size: 1.4rem;">Eingegangene Termine</h3>
                  <p style="margin:0.5rem 0 0; color:#666;">Liste aller Anfragen und Buchungen</p>
                </div>
                <div style="display:flex; gap:0.5rem; background: #fff; padding: 0.25rem; border-radius: 20px;">
                  <button class="btn filter-btn active" data-filter="all" onclick="setFilter('all')"
                    style="background:#000; color:#fff; border-radius:20px; padding:0.4rem 1rem; font-size:0.8rem; border:none;">Alle</button>
                  <button class="btn filter-btn" data-filter="confirmed" onclick="setFilter('confirmed')"
                    style="background:#f1f5f9; color:#000; border-radius:20px; padding:0.4rem 1rem; font-size:0.8rem; border:none;">Bestätigt</button>
                  <button class="btn filter-btn" data-filter="pending" onclick="setFilter('pending')"
                    style="background:#f1f5f9; color:#000; border-radius:20px; padding:0.4rem 1rem; font-size:0.8rem; border:none;">Offen</button>
                  <button class="btn filter-btn" data-filter="rejected" onclick="setFilter('rejected')"
                    style="background:#f1f5f9; color:#000; border-radius:20px; padding:0.4rem 1rem; font-size:0.8rem; border:none;">Abgesagt</button>
                </div>
              </div>

              <div id="bookingsList" style="display: flex; flex-direction: column; gap: 1rem;">
                <!-- List item placeholder if empty handled by JS -->
              </div>
            </div>
          </div>
        </div>


        <!-- CMS Views -->
        <div id="tab-cms" class="tab-content hidden">
          <div id="fileLoadWarning" class="card" style="text-align: center; padding: 4rem 2rem;">
            <div style="font-size: 4rem; margin-bottom: 2rem; color: var(--primary); opacity: 0.6;">
              <i class="fas fa-file-invoice"></i>
            </div>
            <h2 style="margin-bottom: 1rem;">Seite zum Bearbeiten auswählen</h2>
            <p style="color: var(--text-muted); margin-bottom: 2.5rem; max-width: 500px; margin-inline: auto;">
              Wähle deine <strong>index.html</strong> Datei aus deinem Projektordner aus, um mit dem Bearbeiten und
              direkten Speichern zu beginnen.
            </p>

            <div style="display:flex; flex-direction:column; gap:1rem; align-items:center;">
              <button id="filePickerBtn" class="btn btn-primary"
                style="font-size: 1.1rem; padding: 1.25rem 3rem; width: 320px;">
                <i class="fas fa-folder-open"></i> Datei auswählen
              </button>

              <div style="display:grid; grid-template-columns: 1fr 1fr; gap:0.75rem; width: 340px;">
                <button onclick="createNewProject(); switchTab('sections')" class="btn btn-primary"
                  style="background: var(--blue-action); border: none; padding: 1rem; font-size: 0.9rem; flex-direction: column; height: auto;">
                  <i class="fas fa-plus-circle" style="font-size: 1.5rem; margin-bottom: 5px;"></i>
                  <span>Sektion +</span>
                </button>
                <button onclick="createNewProject(); switchTab('design')" class="btn btn-ghost"
                  style="border: 2px dashed var(--blue-action); color: var(--blue-action); padding: 1rem; font-size: 0.9rem; flex-direction: column; height: auto;">
                  <i class="fas fa-paint-brush" style="font-size: 1.5rem; margin-bottom: 5px;"></i>
                  <span>Design +</span>
                </button>
              </div>

              <button onclick="createNewProject()" class="btn btn-ghost" style="width: 320px; opacity: 0.6;">
                <i class="fas fa-plus"></i> Leeres Projekt starten
              </button>
            </div>
            <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 2rem;">
              Tipp: Starte ein neues Projekt und klicke später oben auf "Speichern", <br>
              um die <strong>index.html</strong> in deinem Wunschordner auf dem Desktop anzulegen.
            </p>

            <div style="margin-top: 3rem; border-top: 1px solid var(--border); padding-top: 2rem; display:none"
              id="manualTextareaOption">
              <p style="font-size: 0.9rem; color: var(--text-muted); margin: 2rem 0 1rem;">Oder Code manuell einfügen:
              </p>
              <textarea id="manualHtmlInput" placeholder="Kopiere den Inhalt der index.html hierhin..."
                style="height:120px;"></textarea>
              <button id="manualLoadBtn" class="btn btn-ghost" style="margin-top: 1rem; width: 100%;">
                <i class="fas fa-code"></i> Manuell einlesen
              </button>
            </div>
          </div>

          <div id="cmsFormFields">
            <!-- Dynamically populated fields -->
          </div>

          <!-- Special Gallery Manager -->
          <div id="galleryManager" class="card hidden">
            <h2 style="margin-bottom: 1.5rem;"><i class="fas fa-images"></i> Galerie Bilder</h2>

            <div
              style="margin-bottom: 1rem; background: #f8fafc; padding: 1rem; border-radius: 8px; border: 1px solid var(--border);">
              <div style="margin-bottom: 1rem;">
                <label
                  style="margin-bottom: 0.5rem; display: block; font-size: 0.8rem; font-weight: 700; text-transform: uppercase; color: var(--text-muted);">Galerie
                  Modus</label>
                <select id="galleryModeSelect" onchange="updateGalleryMode(this.value)" style="width: 100%;">
                  <option value="3d">3D Rotation (Modern)</option>
                  <option value="flying">Fliegende Bilder</option>
                  <option value="grid">Klassische Galerie (Grid)</option>
                  <option value="slider">Normale Rotation (Slider)</option>
                </select>
              </div>
              <div id="galleryMusicContainer">
                <label
                  style="margin-bottom: 0.5rem; display: block; font-size: 0.8rem; font-weight: 700; text-transform: uppercase; color: var(--text-muted);">Musik
                  Link / Pfad</label>
                <div style="display: flex; gap: 0.5rem;">
                  <input type="text" id="galleryMusicPath" placeholder="italienische_musik.mp3" style="flex: 1;">
                  <button onclick="updateGalleryMusic()" class="btn btn-primary"
                    style="padding: 0.45rem 1rem;">Übernehmen</button>
                </div>
              </div>
            </div>

            <table id="galleryTable">
              <thead>
                <tr>
                  <th>Bild</th>
                  <th>Pfad</th>
                  <th>Titel</th>
                  <th>Untertitel</th>
                  <th>Aktion</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
            <button onclick="addGalleryItem()" class="btn btn-ghost" style="margin-top: 1.5rem; width: 100%;">
              <i class="fas fa-plus-circle"></i> Bild hinzufügen
            </button>
          </div>

          <!-- Special Social Links Manager -->
          <div id="socialLinksManager" class="card hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
              <h2>Social Media Links (Footer)</h2>
              <button onclick="addSocialLink()" class="btn btn-primary btn-ghost">+ Neu</button>
            </div>
            <table id="socialTable">
              <thead>
                <tr>
                  <th>Icon</th>
                  <th>Icon Pfad</th>
                  <th>Ziel-Link (URL)</th>
                  <th>Aktion</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <!-- Section Manager -->
          <div id="sectionManager" class="card hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
              <h2><i class="fas fa-layer-group"></i> Sektions-Manager</h2>
            </div>
            <p style="color: var(--text-muted); margin-bottom: 2rem; font-size: 0.95rem;">
              Hier kannst du komplette Bereiche deiner Website ein-/ausblenden oder neu erstellen.
            </p>
            <div
              style="background: #f8fafc; padding: 2rem; border-radius: var(--radius-md); margin-bottom: 2.5rem; border: 1px dashed var(--border);">
              <h3 style="margin-top: 0; font-size: 1.1rem; margin-bottom: 1.5rem;">Sektion hinzufügen</h3>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                <div class="form-group">
                  <label>Typ</label>
                  <select id="sectionTemplateSelect">
                    <option value="hero-main">Hero: Großer Header</option>
                    <option value="intro-basic">Einleitung / Intro</option>
                    <option value="about-basic">Über mich Bereich</option>
                    <option value="services-list">Services / Leistungen</option>
                    <option value="gallery-grid">Bilder-Galerie</option>
                    <option value="text-image">Standard: Text & Bild</option>
                    <option value="grid-3">Grid: 3-Spalten Text</option>
                    <option value="grid-img-3">Grid: 3-Spalten Bilder</option>
                    <option value="banner">Banner (Info/Sale)</option>
                    <option value="black-week">Vorlage: Black Week Especial</option>
                    <option value="winter-break">Vorlage: Winterpause / Banner</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Name / ID (individuell)</label>
                  <input type="text" id="sectionIdInput" placeholder="z.B. angebot-winter">
                </div>
              </div>
              <div class="form-group">
                <label>Positionierung</label>
                <select id="sectionPositionSelect">
                  <option value="start">Ganz oben (Anfang)</option>
                  <option value="end">Ganz unten (Ende)</option>
                  <option value="after">Nach bestimmter Sektion...</option>
                </select>
              </div>
              <div id="sectionAfterContainer" class="form-group hidden">
                <label>Einfügen nach:</label>
                <select id="sectionInsertAfterSelect"></select>
              </div>
              <button onclick="addNewSection()" class="btn btn-primary" style="width: 100%;">
                <i class="fas fa-plus"></i> Sektion einfügen
              </button>
            </div>

            <h3 style="margin-bottom: 1rem; font-size: 1.1rem;">Vorhandene Sektionen</h3>
            <table id="sectionTable">
              <thead>
                <tr>
                  <th>Bereich (ID)</th>
                  <th>Inhalt (Vorschau)</th>
                  <th>Aktion</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <!-- Booking Edit/Add Modal -->
        <div id="manualBookingModal" class="hidden"
          style="position: fixed; inset: 0; background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(8px); display: flex; align-items: center; justify-content: center; z-index: 10000; padding: 1rem;">
          <div class="card"
            style="max-width: 600px; width: 100%; margin: 0; box-shadow: var(--shadow-xl); border: 1px solid var(--glass-border);">
            <h2 id="bookingModalTitle" style="margin-bottom: 1.5rem;"><i class="fas fa-calendar-plus"></i> Buchung
              eintragen</h2>
            <form id="manualBookingForm">
              <input type="hidden" id="m_id">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group"><label>Name</label><input type="text" id="m_name" required
                    placeholder="z.B. Max Mustermann"></div>
                <div class="form-group"><label>E-Mail</label><input type="email" id="m_email" required
                    placeholder="name@beispiel.de"></div>
              </div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group"><label>Telefon</label><input type="text" id="m_phone" placeholder="0176...">
                </div>
                <div class="form-group"><label>Event</label><input type="text" id="m_event" placeholder="z.B. Hochzeit">
                </div>
              </div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group"><label>Datum</label><input type="date" id="m_date" required></div>
                <div class="form-group"><label>Gästeanzahl</label><input type="number" id="m_guests"
                    placeholder="z.B. 50">
                </div>
              </div>
              <div class="form-group"><label>Veranstaltungsort / Adresse</label><textarea id="m_address" rows="2"
                  placeholder="Straße, PLZ, Ort"></textarea></div>
              <div class="form-group"><label>Nachricht / Notiz</label><textarea id="m_message" rows="2"
                  placeholder="Optionale Details..."></textarea></div>

              <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                <button type="submit" class="btn btn-primary" style="flex: 2;"><i class="fas fa-save"></i>
                  Speichern</button>
                <button type="button" onclick="document.getElementById('manualBookingModal').classList.add('hidden')"
                  class="btn btn-ghost" style="flex: 1;">Abbrechen</button>
              </div>
            </form>
          </div>
        </div>

        <div id="exportArea" class="hidden">
          <div class="card"
            style="background: var(--bg-sidebar); color: var(--text-main); border: 1px solid var(--glass-border);">
            <h2><i class="fas fa-file-code"></i> Dein neuer Website-Code</h2>
            <p style="color: var(--text-muted); margin-bottom: 1.5rem;">Kopiere diesen Code und speichere ihn in
              deiner
              index.html Datei.</p>
            <textarea id="finalCodeArea"
              style="height:400px; font-family: 'Fira Code', monospace; font-size:0.85rem; background: rgba(0,0,0,0.3); color:#fff; border: 1px solid var(--border); padding: 1.5rem; border-radius: var(--radius-md);"
              readonly></textarea>
            <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
              <button id="copyCodeBtn" class="btn btn-primary" style="flex: 1;"><i class="fas fa-copy"></i> Code
                kopieren</button>
              <button onclick="document.getElementById('exportArea').classList.add('hidden')" class="btn btn-ghost"
                style="flex: 1;">Schließen</button>
            </div>
          </div>
        </div>

        <!-- Image Insert Modal -->
        <div id="insertImageModal" class="hidden"
          style="position: fixed; inset: 0; background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(8px); display: flex; align-items: center; justify-content: center; z-index: 10001; padding: 1rem;">
          <div class="card"
            style="max-width: 500px; width: 100%; margin: 0; position: relative; border: 1px solid var(--glass-border);">
            <h2 style="margin-bottom: 1.5rem;"><i class="fas fa-image"></i> Bild einfügen</h2>

            <!-- Drop Zone -->
            <div id="imgInsertDropZone" onclick="handleDropZoneClick()" ondrop="handleImgDrop(event)"
              ondragover="handleImgDragOver(event)" ondragleave="handleImgDragLeave(event)"
              style="border: 2px dashed var(--glass-border); border-radius: var(--radius-md); padding: 3.5rem 2rem; text-align: center; cursor: pointer; transition: all 0.2s; background: var(--glass); margin-bottom: 1.5rem; color: var(--text-muted);">
              <i class="fas fa-cloud-upload-alt"
                style="font-size: 2.5rem; margin-bottom: 1rem; display: block; opacity: 0.5;"></i>
              Hier klicken oder Bild hineinziehen
            </div>
            <div id="imgInsertPreview" style="display:none; text-align:center; margin-bottom:1rem;"></div>
            <input type="hidden" id="imgInsertFilename">

            <!-- Layout Options -->
            <h4 style="margin-bottom: 0.75rem; font-size: 0.95rem; color: var(--text-muted);">Anzeige-Modus</h4>
            <div style="display: flex; flex-direction: column; gap: 0.75rem; margin-bottom: 2rem;">
              <label
                style="display: flex; align-items: center; gap: 1rem; padding: 0.75rem; border: 1px solid var(--glass-border); border-radius: var(--radius-md); cursor: pointer; background: var(--glass);">
                <input type="radio" name="imgLayout" value="full" checked style="width: auto;">
                <span><b>Volle Breite (Standard)</b><br><small style="color:var(--text-muted)">Füllt den Bereich
                    komplett aus</small></span>
              </label>
              <label
                style="display: flex; align-items: center; gap: 1rem; padding: 0.75rem; border: 1px solid var(--glass-border); border-radius: var(--radius-md); cursor: pointer; background: var(--glass);">
                <input type="radio" name="imgLayout" value="half-right" style="width: auto;">
                <span><b>Rechts neben Text</b><br><small style="color:var(--text-muted)">Bild rechts, Text umfließt
                    es</small></span>
              </label>
              <label
                style="display: flex; align-items: center; gap: 1rem; padding: 0.75rem; border: 1px solid var(--glass-border); border-radius: var(--radius-md); cursor: pointer; background: var(--glass);">
                <input type="radio" name="imgLayout" value="half-left" style="width: auto;">
                <span><b>Links neben Text</b><br><small style="color:var(--text-muted)">Bild links, Text umfließt
                    es</small></span>
              </label>
            </div>

            <div style="display: flex; gap: 1rem;">
              <button onclick="confirmInsertImage()" class="btn btn-primary" style="flex: 1;"><i
                  class="fas fa-check"></i>
                Einfügen</button>
              <button onclick="closeInsertImageModal()" class="btn btn-ghost" style="flex: 1;">Abbrechen</button>
            </div>
          </div>
        </div>

        <!-- Button Insert Modal -->
        <div id="insertButtonModal" class="hidden"
          style="position: fixed; inset: 0; background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(8px); display: flex; align-items: center; justify-content: center; z-index: 10001; padding: 1rem;">
          <div class="card"
            style="max-width: 500px; width: 100%; margin: 0; position: relative; border: 1px solid var(--glass-border);">
            <h2 style="margin-bottom: 1.5rem;"><i class="fas fa-link"></i> Button einfügen</h2>

            <div class="form-group">
              <label>Button Text</label>
              <input type="text" id="btnInsertText" placeholder="z.B. Jetzt buchen">
            </div>

            <div class="form-group">
              <label>Ziel (Link oder Sektion)</label>
              <div style="display: flex; gap: 0.5rem;">
                <input type="text" id="btnInsertLink" placeholder="https://... oder #kontakt" style="flex:1">
                <select onchange="document.getElementById('btnInsertLink').value = this.value"
                  style="width: 150px; background: rgba(15, 23, 42, 0.5);">
                  <option value="">Sektion wählen...</option>
                  <option value="#bookings">Buchungen</option>
                  <option value="#contact">Kontakt</option>
                  <option value="#gallery">Galerie</option>
                </select>
              </div>
            </div>

            <div class="form-group">
              <label>Stil</label>
              <select id="btnInsertStyle" style="background: rgba(15, 23, 42, 0.5);">
                <option value="btn-primary">Hauptfarbe (Gefüllt)</option>
                <option value="btn-ghost">Umrandet (Ghost)</option>
                <option value="btn-white">Weiß</option>
              </select>
            </div>

            <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
              <button onclick="confirmInsertButton()" class="btn btn-primary" style="flex: 1;"><i
                  class="fas fa-check"></i>
                Einfügen</button>
              <button onclick="closeInsertButtonModal()" class="btn btn-ghost" style="flex: 1;">Abbrechen</button>
            </div>
          </div>
        </div>
        <div id="insertSectionModal" class="hidden"
          style="position: fixed; inset: 0; background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(8px); display: flex; align-items: center; justify-content: center; z-index: 10001; padding: 1rem;">
          <div class="card"
            style="max-width: 600px; width: 100%; margin: 0; position: relative; border: 1px solid var(--glass-border); max-height: 90vh; overflow-y: auto;">
            <h2 style="margin-bottom: 1.5rem;"><i class="fas fa-layer-group"></i> Neue Sektion einfügen</h2>

            <div class="form-group">
              <label>Was möchtest du hinzufügen?</label>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-top: 0.5rem;"
                id="modalTemplateGrid">
                <!-- Populated by JS -->
              </div>
            </div>

            <div class="form-group">
              <label>ID / Name (optional)</label>
              <input type="text" id="modalSectionId" placeholder="z.B. winter-angebot">
            </div>

            <input type="hidden" id="modalInsertAfterId">

            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
              <button onclick="confirmInsertSectionModal()" class="btn btn-primary" style="flex: 1;"><i
                  class="fas fa-check"></i> Jetzt einfügen</button>
              <button onclick="closeInsertSectionModal()" class="btn btn-ghost" style="flex: 1;">Abbrechen</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="resizer" id="resizer-preview"></div>

    <!-- Live Preview Area -->
    <div class="preview-area hidden">
      <div class="preview-header">
        <div style="display: flex; align-items: center; gap: 1rem;">
          <span><i class="fas fa-globe"></i> Live Vorschau</span>
          <button class="zen-toggle-btn" onclick="toggleZenMode()" id="zenToggleBtn">
            <i class="fas fa-expand-arrows-alt"></i> Vollbild Bearbeiten
          </button>
          <button class="btn btn-primary" onclick="saveDirectly()" id="zenSaveBtn"
            style="display:none; background: #28a745; border:none;">
            <i class="fas fa-save"></i> Speichern
          </button>
        </div>
        <div class="preview-device-toggle">
          <button class="btn btn-ghost btn-icon" style="padding: 0.4rem; border: none;"
            onclick="setPreviewSize('desktop')"><i class="fas fa-desktop"></i></button>
          <button class="btn btn-ghost btn-icon" style="padding: 0.4rem; border: none;"
            onclick="setPreviewSize('mobile')"><i class="fas fa-mobile-alt"></i></button>
        </div>
      </div>
      <div id="previewContainer">
        <iframe id="livePreview"></iframe>
      </div>
    </div>

  </div> <!-- End Dashboard -->

  <script>
    const ADMIN_PASSWORD = 'eis2026';
    const ACTIVE_KEY = 'eisfavorite_bookings';

    // --- SCRIPTS ---


    // State
    let loadedHtmlContent = "";
    let currentTab = "start";
    let currentDate = new Date();

    // --- RESIZER LOGIC ---
    function initResizers() {
      const sidebar = document.querySelector('.sidebar');
      const preview = document.querySelector('.preview-area');
      const iframe = document.getElementById('livePreview');
      const resizerSidebar = document.getElementById('resizer-sidebar');
      const resizerPreview = document.getElementById('resizer-preview');

      if (resizerSidebar) {
        let startX, startWidth;
        resizerSidebar.addEventListener('mousedown', (e) => {
          startX = e.clientX;
          startWidth = sidebar.offsetWidth;
          document.body.classList.add('dragging-layout');
          resizerSidebar.classList.add('dragging');
          if (iframe) iframe.style.pointerEvents = 'none';

          const onMouseMove = (e) => {
            const delta = e.clientX - startX;
            const newWidth = Math.max(80, startWidth + delta);
            sidebar.style.width = newWidth + 'px';
            sidebar.style.flex = "0 0 " + newWidth + "px";
          };
          const onMouseUp = () => {
            document.body.classList.remove('dragging-layout');
            resizerSidebar.classList.remove('dragging');
            if (iframe) iframe.style.pointerEvents = 'auto';
            window.removeEventListener('mousemove', onMouseMove);
            window.removeEventListener('mouseup', onMouseUp);
          };
          window.addEventListener('mousemove', onMouseMove);
          window.addEventListener('mouseup', onMouseUp);
        });
      }

      if (resizerPreview) {
        let startX, startWidth;
        resizerPreview.addEventListener('mousedown', (e) => {
          startX = e.clientX;
          startWidth = preview.offsetWidth;
          document.body.classList.add('dragging-layout');
          resizerPreview.classList.add('dragging');
          if (iframe) iframe.style.pointerEvents = 'none';

          const onMouseMove = (e) => {
            const delta = e.clientX - startX;
            const newWidth = Math.max(50, startWidth - delta);
            preview.style.width = newWidth + 'px';
            preview.style.flex = "0 0 " + newWidth + "px";
          };
          const onMouseUp = () => {
            document.body.classList.remove('dragging-layout');
            resizerPreview.classList.remove('dragging');
            if (iframe) iframe.style.pointerEvents = 'auto';
            window.removeEventListener('mousemove', onMouseMove);
            window.removeEventListener('mouseup', onMouseUp);
          };
          window.addEventListener('mousemove', onMouseMove);
          window.addEventListener('mouseup', onMouseUp);
        });
      }
    }

    // --- RIBBON DROPDOWN LOGIC ---
    function toggleRibbonMenu() {
      const dropdown = document.getElementById('ribbonDropdown');
      if (dropdown) dropdown.classList.toggle('active');
    }

    // Close dropdown on click outside
    document.addEventListener('click', (e) => {
      const dropdown = document.getElementById('ribbonDropdown');
      const btn = document.querySelector('.ribbon-expand-btn');
      if (dropdown && dropdown.classList.contains('active')) {
        if (!dropdown.contains(e.target) && !btn.contains(e.target)) {
          dropdown.classList.remove('active');
        }
      }
    });

    // --- AUTO IMPORT FROM EMAIL LINK ---
    document.addEventListener('DOMContentLoaded', () => {
      // 1. Check for URL params
      const params = new URLSearchParams(window.location.search);
      const importData = params.get('import_booking');

      if (importData) {
        try {
          // Decode Base64
          const jsonString = atob(decodeURIComponent(importData));
          const newBooking = JSON.parse(jsonString);

          // Add to LocalStorage
          const currentBookings = JSON.parse(localStorage.getItem(ACTIVE_KEY) || '[]');

          // Check duplicate by ID
          if (!currentBookings.find(b => b.id === newBooking.id)) {
            currentBookings.push(newBooking);
            localStorage.setItem(ACTIVE_KEY, JSON.stringify(currentBookings));

            // Clean URL
            window.history.replaceState({}, document.title, window.location.pathname);

            // Notify
            setTimeout(() => {
              showNotification(`🆕 Neue Buchung von ${newBooking.name} erfolgreich importiert!`);
              switchTab('bookings'); // Go directly to bookings
              renderBookings();
              renderCalendar();
            }, 500);
          } else {
            window.history.replaceState({}, document.title, window.location.pathname);
            showNotification("Diese Buchung existiert bereits.", "warning");
          }
        } catch (e) {
          console.error("Import Error:", e);
          showNotification("Fehler beim Importieren des Links.", "error");
        }
      }

      initResizers();
    });

    const fontOptions = [
      { name: 'Standard (System)', value: 'system-ui, -apple-system, sans-serif' },
      { name: '👑 Vivaldi (Premium)', value: "'Vivaldi', 'Great Vibes', cursive" },
      { name: '👑 Great Vibes', value: "'Great Vibes', cursive" },
      { name: '👑 Alex Brush', value: "'Alex Brush', cursive" },
      { name: 'Arial', value: "Arial, sans-serif" },
      { name: 'Georgia', value: "Georgia, serif" },
      { name: 'Times New Roman', value: "'Times New Roman', serif" },
      { name: 'Verdana', value: "Verdana, sans-serif" },
      { name: 'Courier New', value: "'Courier New', monospace" },
      { name: 'Plus Jakarta Sans', value: "'Plus Jakarta Sans', sans-serif" },
      { name: 'Outfit', value: "'Outfit', sans-serif" },
      { name: 'Playfair Display', value: "'Playfair Display', serif" },
      { name: 'Inter', value: "'Inter', sans-serif" },
      { name: 'Roboto', value: "'Roboto', sans-serif" },
      { name: 'Montserrat', value: "'Montserrat', sans-serif" },
      { name: 'Lora', value: "'Lora', serif" },
      { name: 'Dancing Script', value: "'Dancing Script', cursive" },
      { name: 'Bebas Neue', value: "'Bebas Neue', sans-serif" }
    ];

    function importGoogleFont(doc, fontValue) {
      const fontNames = {
        'Plus Jakarta Sans': 'Plus+Jakarta+Sans:wght@400;500;600;700;800',
        'Outfit': 'Outfit:wght@300;400;600;800',
        'Playfair Display': 'Playfair+Display:ital,wght@0,600;1,600',
        'Great Vibes': 'Great+Vibes',
        'Alex Brush': 'Alex+Brush',
        'Dancing Script': 'Dancing+Script:wght@400;500;600;700',
        'Bebas Neue': 'Bebas+Neue'
      };

      let selectedFontName = null;
      for (let name in fontNames) {
        if (fontValue.includes(name)) {
          selectedFontName = name;
          break;
        }
      }

      if (selectedFontName) {
        const fontUrl = `https://fonts.googleapis.com/css2?family=${fontNames[selectedFontName]}&display=swap`;
        let linkTag = Array.from(doc.querySelectorAll('link[rel="stylesheet"]')).find(l => l.href.includes(selectedFontName.replace(' ', '+')));
        if (!linkTag) {
          linkTag = doc.createElement('link');
          linkTag.rel = 'stylesheet';
          linkTag.href = fontUrl;
          doc.head.appendChild(linkTag);
        }
      }
    }

    // --- NOTIFICATIONS ---
    function showNotification(message, type = 'success') {
      const host = document.getElementById('notificationHost');
      if (!host) return;

      const notification = document.createElement('div');
      notification.className = `notification ${type}`;

      const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
      notification.innerHTML = `<i class="fas ${icon}"></i> <span>${message}</span>`;

      host.appendChild(notification);

      setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => notification.remove(), 400);
      }, 4000);
    }

    // History Management for Undo/Redo
    let history = [];
    let historyIndex = -1;
    const MAX_HISTORY = 50; // Limit to prevent memory issues

    function saveToHistory() {
      // Remove any "future" states if we're not at the end
      if (historyIndex < history.length - 1) {
        history = history.slice(0, historyIndex + 1);
      }

      // Add current state
      history.push(loadedHtmlContent);
      historyIndex++;

      // Limit history size
      if (history.length > MAX_HISTORY) {
        history.shift();
        historyIndex--;
      }

      updateHistoryButtons();
      renderSidebarSections();
    }

    function undo() {
      if (historyIndex > 0) {
        historyIndex--;
        loadedHtmlContent = history[historyIndex];
        updatePreview();
        if (currentTab !== 'bookings') renderCMSFields(currentTab);
        updateHistoryButtons();
      }
    }

    function redo() {
      if (historyIndex < history.length - 1) {
        historyIndex++;
        loadedHtmlContent = history[historyIndex];
        updatePreview();
        if (currentTab !== 'bookings') renderCMSFields(currentTab);
        updateHistoryButtons();
      }
    }

    function updateHistoryButtons() {
      const undoBtn = document.getElementById('undoBtn');
      const redoBtn = document.getElementById('redoBtn');
      if (undoBtn) undoBtn.disabled = historyIndex <= 0;
      if (redoBtn) redoBtn.disabled = historyIndex >= history.length - 1;
    }

    // Helper function to update HTML content and save to history
    function updateHtmlContent(newContent) {
      loadedHtmlContent = newContent;
      saveToHistory();
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.key === 'z' && !e.shiftKey) {
        e.preventDefault();
        undo();
      } else if ((e.ctrlKey && e.key === 'y') || (e.ctrlKey && e.shiftKey && e.key === 'z')) {
        e.preventDefault();
        redo();
      }
    });

    // Mapping fields to sections
    const SECTIONS = {
      start: [], // Managed manually
      header: [
        { id: 'cms-logo-text', label: 'Logo Text', type: 'text' },
        { id: 'cms-logo-img', label: 'Logo Bild (Pfad)', type: 'text', attr: 'src' },
        { id: 'cms-nav-home', label: 'Navigation: Startseite', type: 'text' },
        { id: 'cms-nav-services', label: 'Navigation: Events/Leistungen', type: 'text' },
        { id: 'cms-nav-gallery', label: 'Navigation: Galerie', type: 'text' },
        { id: 'cms-nav-contact', label: 'Navigation: Kontakt', type: 'text' },
        { id: 'cms-nav-cta', label: 'Navigation: Button (Aktion)', type: 'text' }
      ],
      hero: [
        { id: 'cms-hero-h1', label: 'Haupt-Überschrift', type: 'text' },
        { id: 'cms-hero-p', label: 'Untertitel', type: 'text' },
        { id: 'cms-hero-btn', label: 'Button Text', type: 'text' },
        { id: 'cms-hero-section', label: 'Hintergrundbild', type: 'text', attr: 'style', special: 'hero-bg' }
      ],
      intro: [
        { id: 'cms-intro-h2', label: 'Überschrift', type: 'text' },
        { id: 'cms-intro-p1', label: 'Fetter Einleitungstext', type: 'textarea' },
        { id: 'cms-intro-p2', label: 'Hauptbeschreibung', type: 'textarea' },
        { id: 'cms-intro-img', label: 'Intro Bild (Pfad)', type: 'text', attr: 'src' },
        { id: 'cms-intro-badge', label: 'Intro Badge Text', type: 'text' },
        { id: 'cms-feature1-h4', label: 'Feature 1: Titel', type: 'text' },
        { id: 'cms-feature1-p', label: 'Feature 1: Text', type: 'text' },
        { id: 'cms-feature2-h4', label: 'Feature 2: Titel', type: 'text' },
        { id: 'cms-feature2-p', label: 'Feature 2: Text', type: 'text' },
        { id: 'cms-feature3-h4', label: 'Feature 3: Titel', type: 'text' },
        { id: 'cms-feature3-p', label: 'Feature 3: Text', type: 'text' }
      ],
      services: [
        { id: 'cms-services-h2', label: 'Sektions-Überschrift', type: 'text' },
        { id: 'cms-services-p', label: 'Sektions-Untertitel', type: 'text' },
        { id: 'cms-service1-icon', label: 'Service 1: Icon (Emoji)', type: 'text' },
        { id: 'cms-service1-h3', label: 'Service 1: Titel', type: 'text' },
        { id: 'cms-service1-p', label: 'Service 1: Text', type: 'textarea' },
        { id: 'cms-service2-icon', label: 'Service 2: Icon (Emoji)', type: 'text' },
        { id: 'cms-service2-h3', label: 'Service 2: Titel', type: 'text' },
        { id: 'cms-service2-p', label: 'Service 2: Text', type: 'textarea' },
        { id: 'cms-service3-icon', label: 'Service 3: Icon (Emoji)', type: 'text' },
        { id: 'cms-service3-h3', label: 'Service 3: Titel', type: 'text' },
        { id: 'cms-service3-p', label: 'Service 3: Text', type: 'textarea' },
        { id: 'cms-service4-icon', label: 'Service 4: Icon (Emoji)', type: 'text' },
        { id: 'cms-service4-h3', label: 'Service 4: Titel', type: 'text' },
        { id: 'cms-service4-p', label: 'Service 4: Text', type: 'textarea' }
      ],
      about: [
        { id: 'cms-about-h2', label: 'Über mich: Titel', type: 'text' },
        { id: 'cms-about-p1', label: 'Text Block 1', type: 'textarea' },
        { id: 'cms-about-p2', label: 'Text Block 2', type: 'textarea' },
        { id: 'cms-about-img', label: 'Über mich: Bild (Pfad)', type: 'text', attr: 'src' }
      ],
      gallery: [
        { id: 'cms-gallery-h2', label: 'Galerie: Überschrift', type: 'text' },
        { id: 'cms-gallery-p', label: 'Galerie: Untertitel', type: 'text' }
      ],
      blackweek: [
        { id: 'cms-blackweek-badge', label: 'Badge Text (z.B. FRÜHBUCHER SPECIAL)', type: 'text' },
        { id: 'cms-blackweek-h2', label: 'Hauptüberschrift', type: 'text' },
        { id: 'cms-blackweek-p', label: 'Beschreibung', type: 'textarea' }
      ],
      workflow: [
        { id: 'workflow', label: 'Workflow Sektion', type: 'info', info: 'Die Workflow-Sektion zeigt den 3-Schritte-Prozess. Bearbeite die Schritte direkt im Sektions-Manager oder über den Code.' }
      ],
      testimonials: [
        { id: 'testimonials', label: 'Testimonials Sektion', type: 'info', info: 'Die Testimonials-Sektion zeigt Kundenstimmen. Bearbeite die Testimonials direkt im Sektions-Manager oder über den Code.' }
      ],
      faq: [
        { id: 'faq', label: 'FAQ Sektion', type: 'info', info: 'Die FAQ-Sektion zeigt häufig gestellte Fragen. Bearbeite die FAQs direkt im Sektions-Manager oder über den Code.' }
      ],
      winterpause: [
        { id: 'cms-winterpause-h3', label: 'Überschrift', type: 'text' },
        { id: 'cms-winterpause-p1', label: 'Beschreibung 1', type: 'textarea' },
        { id: 'cms-winterpause-p2', label: 'Beschreibung 2', type: 'textarea' }
      ],
      footer: [
        { id: 'cms-footer-address', label: 'Adresse (HTML erlaubt)', type: 'textarea' },
        { id: 'cms-footer-phone', label: 'Telefon Anzeige', type: 'text' },
        { id: 'cms-footer-phone', label: 'Telefon Link (tel:...)', type: 'text', attr: 'href' },
        { id: 'cms-footer-email', label: 'E-Mail Anzeige', type: 'text' },
        { id: 'cms-footer-email', label: 'E-Mail Link (mailto:...)', type: 'text', attr: 'href' },
        { id: 'cms-footer-qr', label: 'QR Code Bild (Pfad)', type: 'text', attr: 'src' },
        { id: 'cms-footer-bottom', label: 'Copyright / Fußzeile', type: 'text' }
      ],
      social: [], // Managed by socialLinksManager
      design: [
        { id: 'cms-font-heading', label: 'Schriftart Überschriften', type: 'font-select' },
        { id: 'cms-font-body', label: 'Schriftart Fließtext', type: 'font-select' },
        { id: 'cms-size-h1', label: 'Größe H1 (z.B. 4rem)', type: 'text' },
        { id: 'cms-size-h2', label: 'Größe H2 (z.B. 2.5rem)', type: 'text' },
        { id: 'cms-size-p', label: 'Größe Text (z.B. 1.1rem)', type: 'text' },
        { id: 'cms-color-primary', label: 'Hauptfarbe (Buttons, Titel)', type: 'color' },
        { id: 'cms-color-accent', label: 'Akzentfarbe (Gold/Highlights)', type: 'color' },
        { id: 'cms-color-secondary', label: 'Sekundärfarbe (Waves)', type: 'color' },
        { id: 'cms-color-bg', label: 'Hintergrundfarbe (Body)', type: 'color' },
        { id: 'cms-color-text', label: 'Haupt-Schriftfarbe', type: 'color' },
        { id: 'cms-color-muted', label: 'Gedeckte Schriftfarbe', type: 'color' }
      ],
      sections: [] // Managed by sectionManager
    };

    // --- NAVIGATION ---
    function switchTab(tabId) {
      currentTab = tabId;
      // Normal Nav Items
      document.querySelectorAll('.nav-item').forEach(el => {
        el.classList.remove('active');
        if (el.getAttribute('onclick')?.includes(`'${tabId}'`)) {
          el.classList.add('active');
        }
      });

      // Sidebar Section Items
      document.querySelectorAll('.sidebar-section-item').forEach(el => {
        el.classList.remove('active');
        if (el.getAttribute('data-id') === currentlyEditingSection && tabId === 'sections') {
          el.classList.add('active');
        }
      });

      const titleMap = {
        'start': 'Dashboard',
        'bookings': 'Buchungen',
        'design': 'Design & Farben',
        'header': 'Header & Logo',
        'gallery': 'Galerie Manager',
        'footer': 'Footer & Kontakt',
        'social': 'Social Media',
        'sections': 'Sektions-Manager'
      };

      const titleEl = document.getElementById('currentTabTitle');
      if (titleEl) titleEl.textContent = titleMap[tabId] || tabId;

      if (tabId === 'bookings') {
        document.getElementById('tab-bookings').classList.remove('hidden');
        document.getElementById('tab-cms').classList.add('hidden');
        renderCalendar();
        renderBookings();
      } else {
        document.getElementById('tab-bookings').classList.add('hidden');
        document.getElementById('tab-cms').classList.remove('hidden');
        renderCMSFields(tabId);

        // Special Managers
        if (tabId === 'gallery') {
          document.getElementById('galleryManager').classList.remove('hidden');
          if (typeof loadGallerySettings === 'function') loadGallerySettings();
          if (typeof renderGalleryItems === 'function') renderGalleryItems();
        } else {
          document.getElementById('galleryManager').classList.add('hidden');
        }

        if (tabId === 'social') document.getElementById('socialLinksManager').classList.remove('hidden');
        else document.getElementById('socialLinksManager').classList.add('hidden');

        if (tabId === 'sections') document.getElementById('sectionManager').classList.remove('hidden');
        else document.getElementById('sectionManager').classList.add('hidden');

        if (tabId === 'footer') document.getElementById('socialLinksManager').classList.remove('hidden');
      }
    }


    // --- SOCIAL LINKS MANAGER ---
    function renderSocialLinks() {
      const body = document.querySelector('#socialTable tbody');
      if (!body) return;
      body.innerHTML = '';
      if (!loadedHtmlContent) return;

      const parser = new DOMParser();
      const doc = parser.parseFromString(loadedHtmlContent, 'text/html');
      const container = doc.getElementById('cms-social-links');
      if (!container) return;

      const links = container.querySelectorAll('a');
      links.forEach((link, index) => {
        const href = link.getAttribute('href') || "#";
        const img = link.querySelector('img');
        const src = img ? img.getAttribute('src') : "";

        const tr = document.createElement('tr');
        tr.className = 'draggable-row';
        tr.setAttribute('draggable', 'true');
        tr.setAttribute('data-index', index);
        tr.setAttribute('data-type', 'social');

        tr.addEventListener('dragstart', handleSocialDragStart);
        tr.addEventListener('dragover', handleSocialDragOver);
        tr.addEventListener('drop', handleSocialDrop);
        tr.addEventListener('dragend', handleDragEnd);

        tr.innerHTML = `
          <td>
            <div style="display:flex; align-items:center; gap:1rem;">
              <span class="drag-handle"><i class="fas fa-grip-vertical"></i></span>
              <img src="${src}" class="gallery-preview" style="width:30px; height:30px; border-radius:4px;">
            </div>
          </td>
          <td>
            <div style="display: flex; gap: 0.5rem;">
              <input type="text" id="social-src-${index}" value="${src}" onchange="updateSocialLink(${index}, 'src', this.value)"
                     readonly onclick="triggerFilePicker('social-src-${index}')"
                     placeholder="Bild wählen..."
                     style="cursor:pointer">
              <button onclick="triggerFilePicker('social-src-${index}')" class="btn btn-ghost" style="padding: 0.3rem; font-size: 0.8rem;">📁</button>
            </div>
          </td>
          <td><input type="text" value="${href}" onchange="updateSocialLink(${index}, 'href', this.value)"></td>
          <td><button class="btn btn-ghost" style="color:var(--accent-danger)" onclick="removeSocialLink(${index})"><i class="fas fa-trash"></i></button></td>
        `;
        body.appendChild(tr);
      });
    }

    let socialDragSrcIndex = null;

    function handleSocialDragStart(e) {
      socialDragSrcIndex = this.getAttribute('data-index');
      e.dataTransfer.effectAllowed = 'move';
      this.classList.add('dragging');
    }

    function handleSocialDragOver(e) {
      if (e.preventDefault) e.preventDefault();
      this.classList.add('over');
      return false;
    }

    function handleSocialDrop(e) {
      if (e.stopPropagation) e.stopPropagation();
      this.classList.remove('over');

      const targetIndex = this.getAttribute('data-index');
      if (socialDragSrcIndex !== targetIndex) {
        reorderSocialLinks(parseInt(socialDragSrcIndex), parseInt(targetIndex));
      }
      return false;
    }

    function reorderSocialLinks(srcIdx, targetIdx) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(loadedHtmlContent, 'text/html');
      const container = doc.getElementById('cms-social-links');
      const links = Array.from(container.querySelectorAll('a'));

      const itemToMove = links[srcIdx];
      links.splice(srcIdx, 1);
      links.splice(targetIdx, 0, itemToMove);

      container.innerHTML = '';
      links.forEach(link => container.appendChild(link));

      loadedHtmlContent = '<!DOCTYPE html>\n' + doc.documentElement.outerHTML;
      renderSocialLinks();
      updatePreview();
      saveToHistory();
    }

    function updateSocialLink(index, type, value) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(loadedHtmlContent, 'text/html');
      const container = doc.getElementById('cms-social-links');
      const links = container.querySelectorAll('a');
      const link = links[index];
      if (!link) return;

      if (type === 'href') link.setAttribute('href', value);
      if (type === 'src') {
        const img = link.querySelector('img');
        if (img) img.setAttribute('src', value);
      }

      loadedHtmlContent = '<!DOCTYPE html>\n' + doc.documentElement.outerHTML;
      renderSocialLinks();
      updatePreview();
    }

    function addSocialLink() {
      const parser = new DOMParser();
      const doc = parser.parseFromString(loadedHtmlContent, 'text/html');
      const container = doc.getElementById('cms-social-links');
      if (!container) return;

      const a = doc.createElement('a');
      a.setAttribute('href', '#');
      a.setAttribute('target', '_blank');
      a.innerHTML = `<img src="https://cdn-icons-png.flaticon.com/512/124/124010.png" alt="Social" style="width: 40px; border-radius: 8px;">`;
      container.appendChild(a);

      loadedHtmlContent = '<!DOCTYPE html>\n' + doc.documentElement.outerHTML;
      renderSocialLinks();
      updatePreview();
    }

    function removeSocialLink(index) {
      if (!confirm('Link wirklich löschen?')) return;
      const parser = new DOMParser();
      const doc = parser.parseFromString(loadedHtmlContent, 'text/html');
      const container = doc.getElementById('cms-social-links');
      const links = container.querySelectorAll('a');
      if (links[index]) links[index].remove();

      loadedHtmlContent = '<!DOCTYPE html>\n' + doc.documentElement.outerHTML;
      renderSocialLinks();
      updatePreview();
    }

    // --- SIDEBAR SECTIONS LIST ---
    function renderSidebarSections() {
      const container = document.getElementById('sidebar-sections-container');
      if (!container || !loadedHtmlContent) return;
      container.innerHTML = '';

      const parser = new DOMParser();
      const doc = parser.parseFromString(loadedHtmlContent, 'text/html');

      // Try to find sections: in cms-main-content, main, or top-level body elements
      let main = doc.getElementById('cms-main-content') || doc.querySelector('main');
      let sectors = [];

      // Always include Header
      const header = doc.querySelector('header');
      if (header) sectors.push(header);

      if (main) {
        sectors = sectors.concat(Array.from(main.children));
      } else {
        sectors = sectors.concat(Array.from(doc.body.children).filter(el =>
          ['SECTION', 'DIV'].includes(el.tagName) &&
          !['livePreview', 'dashboard', 'loginCard', 'notificationHost', 'navbar', 'contact'].includes(el.id)
        ));
      }

      // Always include Footer
      const footer = doc.querySelector('footer');
      if (footer && !sectors.includes(footer)) sectors.push(footer);

      sectors.forEach((sec, idx) => {
        if (!sec.id) sec.id = "sec-" + idx;
        const id = sec.id;

        const item = document.createElement('div');
        item.className = 'sidebar-section-item';
        if (currentlyEditingSection === id) item.classList.add('active');

        item.setAttribute('draggable', 'true');
        item.setAttribute('data-id', id);

        item.onclick = (e) => {
          e.stopPropagation();
          editDynamicSection(id);
        };

        // Drag Handlers for Sidebar
        item.ondragstart = (e) => {
          e.dataTransfer.setData('text/plain', id);
          e.target.style.opacity = '0.5';
        };
        item.ondragend = (e) => e.target.style.opacity = '1';
        item.ondragover = (e) => e.preventDefault();
        item.ondrop = (e) => {
          e.preventDefault();
          const srcId = e.dataTransfer.getData('text/plain');
          if (srcId && srcId !== id) reorderSections(srcId, id);
        };

        let label = id.replace('cms-', '').replace('sec-', '');

        // Custom friendly names for known sections
        const friendlyNames = {
          'home': 'Home / Startseite',
          'intro': 'Intro',
          'services': 'Events & Services',
          'about': 'Über Mich',
          'gallery': 'Galerie Vorschau',
          'workflow': 'Ablauf',
          'testimonials': 'Kundenstimmen',
          'faq': 'FAQ',
          'cms-blackweek': 'Aktions-Banner',
          'cms-winterpause': 'Info-Box'
        };

        const h2 = sec.querySelector('h2, h3, h1');

        // Use friendly name if available, otherwise fallback to H2 or ID
        let displayLabel = friendlyNames[id];
        if (!displayLabel) {
          displayLabel = h2 ? h2.innerText : (label.charAt(0).toUpperCase() + label.slice(1));
        }

        // Truncate long labels
        if (displayLabel.length > 25) displayLabel = displayLabel.substring(0, 22) + '...';

        const icon = getSectionIcon(id);
        const isCore = ['navbar', 'header', 'footer', 'contact'].includes(id);

        item.innerHTML = `
          <div style="display:flex; align-items:center; gap:12px; flex:1; overflow:hidden">
            <i class="${icon}" style="width:20px; text-align:center; color: var(--primary)"></i>
            <span style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis">${displayLabel}</span>
          </div>
          <div class="sidebar-actions" style="display:flex; align-items:center; gap:8px">
            ${!isCore ? `<i class="fas fa-trash-alt" onclick="event.stopPropagation(); removeSection('${id}')" title="Sektion löschen" style="font-size:0.8rem; color:var(--accent-danger); cursor:pointer; padding:4px"></i>` : ''}
            <i class="fas fa-grip-vertical" style="opacity:0.3; font-size:0.7rem; cursor:grab"></i>
          </div>
        `;
        container.appendChild(item);
      });
    }

    function getSectionIcon(id) {
      if (id.includes('hero')) return 'fas fa-rocket';
      if (id.includes('gallery')) return 'fas fa-images';
      if (id.includes('service')) return 'fas fa-ice-cream';
      if (id.includes('contact')) return 'fas fa-envelope';
      if (id.includes('about')) return 'fas fa-user';
      if (id.includes('faq')) return 'fas fa-question-circle';
      return 'fas fa-layer-group';
    }

    // --- SECTION MANAGER ---
    function renderSectionManager() {
      renderSidebarSections();
      const body = document.querySelector('#sectionTable tbody');
      const afterSelect = document.getElementById('sectionInsertAfterSelect');
      if (!body) return;
      body.innerHTML = '';
      if (afterSelect) afterSelect.innerHTML = '';
      if (!loadedHtmlContent) return;

      const parser = new DOMParser();
      const doc = parser.parseFromString(loadedHtmlContent, 'text/html');

      let main = doc.getElementById('cms-main-content') || doc.querySelector('main');
      let sectors = [];

      const header = doc.querySelector('header');
      if (header) sectors.push(header);

      if (main) {
        sectors = sectors.concat(Array.from(main.children));
      } else {
        sectors = sectors.concat(Array.from(doc.body.children).filter(el =>
          ['SECTION', 'DIV'].includes(el.tagName) &&
          !['livePreview', 'dashboard', 'loginCard', 'notificationHost', 'navbar', 'contact'].includes(el.id)
        ));
      }

      const footer = doc.querySelector('footer');
      if (footer && !sectors.includes(footer)) sectors.push(footer);

      sectors.forEach((sec, idx) => {
        if (!sec.id) sec.id = "unnamed-" + idx;
        const id = sec.id;

        // Custom friendly names for known sections
        const friendlyNames = {
          'home': 'Home / Startseite',
          'intro': 'Intro',
          'services': 'Events & Services',
          'about': 'Über Mich',
          'gallery': 'Galerie Vorschau',
          'workflow': 'Ablauf',
          'testimonials': 'Kundenstimmen',
          'faq': 'FAQ',
          'cms-blackweek': 'Aktions-Banner',
          'cms-winterpause': 'Info-Box'
        };

        let displayLabel = friendlyNames[id];
        if (!displayLabel) {
          const h2ForLabel = sec.querySelector('h2, h3, h1');
          const simpleLabel = id.replace('cms-', '').replace('sec-', '');
          displayLabel = h2ForLabel ? h2ForLabel.innerText : (simpleLabel.charAt(0).toUpperCase() + simpleLabel.slice(1));
        }

        // Ensure GLOBAL IDS run if not already (safeguard)
        ensureGlobalCmsIds(doc);

        // Populate afterSelect
        if (afterSelect) {
          const opt = document.createElement('option');
          opt.value = id;
          opt.textContent = `Nach: ${displayLabel}`;
          afterSelect.appendChild(opt);
        }

        // Add an "Insert Plus" before the first row and after every row
        if (idx === 0) {
          const firstInsertTr = document.createElement('tr');
          firstInsertTr.innerHTML = `<td colspan="3" style="padding: 0; text-align: center; border:none;">
                <button onclick="openAddSectionAfter('start')" class="btn btn-ghost" style="width:100%; height: 30px; border: 1px dashed #eee; font-size: 0.7rem; color: #999; margin: 4px 0;">
                    <i class="fas fa-plus-circle"></i> Ganz oben einfügen
                </button>
            </td>`;
          body.appendChild(firstInsertTr);
        }

        let preview = "";
        const h2 = sec.querySelector('h2, h3');
        if (h2) preview = h2.innerText.substring(0, 30) + "...";
        else {
          const p = sec.querySelector('p');
          if (p) preview = p.innerText.substring(0, 30) + "...";
        }

        const tr = document.createElement('tr');

        // Add Drag Attributes & Listeners
        tr.setAttribute('draggable', 'true');
        tr.setAttribute('data-id', id);
        tr.classList.add('draggable-row');

        tr.addEventListener('dragstart', handleDragStart, false);
        tr.addEventListener('dragenter', handleDragEnter, false);
        tr.addEventListener('dragover', handleDragOver, false);
        tr.addEventListener('dragleave', handleDragLeave, false);
        tr.addEventListener('drop', handleDrop, false);
        tr.addEventListener('dragend', handleDragEnd, false);

        tr.innerHTML = `
          <td>
            <div style="display:flex; align-items:center; gap:0.75rem;">
                <span class="drag-handle"><i class="fas fa-grip-vertical"></i></span>
                <div style="display:flex; flex-direction:column;">
                    <strong>${displayLabel}</strong>
                    <span style="font-size:0.75rem; color:var(--text-muted); opacity:0.7;">ID: ${id}</span>
                </div>
            </div>
          </td>
          <td style="font-size: 0.8rem; color: var(--text-muted);">${preview}</td>
          <td>
            <div style="display: flex; gap: 0.3rem; justify-content: flex-end;">
              <button class="btn btn-ghost btn-icon" onclick="editDynamicSection('${id}')" title="Bearbeiten"><i class="fas fa-edit"></i></button>
              <button class="btn btn-ghost btn-icon" onclick="moveSection('${id}', 'up')" ${idx === 0 ? 'disabled' : ''} title="Hoch"><i class="fas fa-arrow-up"></i></button>
              <button class="btn btn-ghost btn-icon" onclick="moveSection('${id}', 'down')" ${idx === sectors.length - 1 ? 'disabled' : ''} title="Runter"><i class="fas fa-arrow-down"></i></button>
              <button class="btn btn-ghost btn-icon" onclick="removeSection('${id}')" style="color: var(--accent-danger);" title="Löschen"><i class="fas fa-trash"></i></button>
            </div>
          </td>
        `;
        body.appendChild(tr);

        // Add "Insert After" row
        const insertTr = document.createElement('tr');
        insertTr.innerHTML = `<td colspan="3" style="padding: 0; text-align: center; border:none;">
            <button onclick="openAddSectionAfter('${id}')" class="btn btn-ghost" style="width:100%; height: 30px; border: 1px dashed #eee; font-size: 0.7rem; color: #999; margin: 4px 0;">
                <i class="fas fa-plus-circle"></i> Sektion hier einfügen
            </button>
        </td>`;
        body.appendChild(insertTr);
      });
    }

    function moveSection(id, direction) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(loadedHtmlContent, 'text/html');
      const main = doc.getElementById('cms-main-content') || doc.querySelector('main');
      const el = doc.getElementById(id);
      if (!main || !el) return;

      if (direction === 'up' && el.previousElementSibling) {
        main.insertBefore(el, el.previousElementSibling);
      } else if (direction === 'down' && el.nextElementSibling) {
        main.insertBefore(el.nextElementSibling, el);
      }

      loadedHtmlContent = '<!DOCTYPE html>\n' + doc.documentElement.outerHTML;
      renderSectionManager();
      updatePreview();
      saveToHistory();
    }

    // consolidated reorderSections logic here, or will be replaced below

    // --- ELEMENT REORDERING ---
    function moveElement(id, direction) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(loadedHtmlContent, 'text/html');
      const el = doc.getElementById(id);
      if (!el) return;

      if (direction === 'up') {
        const prev = el.previousElementSibling;
        if (prev) {
          prev.before(el);
        }
      } else {
        const next = el.nextElementSibling;
        if (next) {
          next.after(el);
        }
      }

      loadedHtmlContent = '<!DOCTYPE html>\n' + doc.documentElement.outerHTML;
      updatePreview();
      saveToHistory();

      // Refresh current view
      if (currentlyEditingSection && currentTab === 'sections') {
        editDynamicSection(currentlyEditingSection);
      } else if (currentTab) {
        renderCMSFields(currentTab);
      }
    }

    function setSectionPadding(sectionId, input, side) { // side = 'Top' or 'Bottom'
      const val = input.value;
      const parser = new DOMParser();
      const doc = parser.parseFromString(loadedHtmlContent, 'text/html');
      const sec = doc.getElementById(sectionId);
      if (sec) {
        sec.style[`padding${side}`] = val + 'rem';
        loadedHtmlContent = '<!DOCTYPE html>\n' + doc.documentElement.outerHTML;
        updatePreview();
      }
    }

    function setSectionFont(sectionId, prop, value) { // prop = '--font-heading' or '--font-body'
      const parser = new DOMParser();
      const doc = parser.parseFromString(loadedHtmlContent, 'text/html');
      const sec = doc.getElementById(sectionId);
      if (sec) {
        importGoogleFont(doc, value);
        sec.style.setProperty(prop, value);
        loadedHtmlContent = '<!DOCTYPE html>\n' + doc.documentElement.outerHTML;
        updatePreview();
      }
    }

    // --- SHARED SCANNING LOGIC ---
    function scanSectionForFields(sectionId) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(loadedHtmlContent, 'text/html');
      let secEl = doc.getElementById(sectionId);

      if (!secEl) return { fields: [], sectionFound: false };

      // Ensure IDs
      let changed = false;
      const allEditable = secEl.querySelectorAll('h1, h2, h3, h4, p, img, span, li, button, a, div');

      allEditable.forEach((el, index) => {
        if (el.tagName.toLowerCase() === 'div' && el.children.length > 0) return;
        if (!el.id) {
          el.id = `${sectionId}-${el.tagName.toLowerCase()}-${index}`;
          changed = true;
        }
      });
      if (changed) {
        loadedHtmlContent = '<!DOCTYPE html>\n' + doc.documentElement.outerHTML;
        doc.active = parser.parseFromString(loadedHtmlContent, 'text/html');
        secEl = doc.active.getElementById(sectionId);
      }

      const fields = [];
      const children = secEl.querySelectorAll('h1, h2, h3, h4, p, img, span, li, button, a, div');
      children.forEach(el => {
        const tag = el.tagName.toLowerCase();
        if (tag === 'div' && el.children.length > 0) return;

        let label = tag.toUpperCase();
        if (tag.startsWith('h')) label = 'Überschrift';
        if (tag === 'p') label = 'Text';
        if (tag === 'button') label = 'Button';
        if (tag === 'a') label = 'Link';

        const field = {
          id: el.id,
          label: label,
          type: (['p', 'span', 'li', 'div'].includes(tag)) ? 'textarea' : 'text',
        };
        if (tag === 'img') { field.label = 'Bild'; field.attr = 'src'; }
        if (tag === 'a') field.isLink = true;

        fields.push(field);
      });
      return { fields, sectionFound: true };
    }

    function ensureGlobalCmsIds(doc = null) {
      const parser = new DOMParser();
      const docToUse = doc || parser.parseFromString(loadedHtmlContent, 'text/html');

      // Target the whole body to ensure Header and Footer are covered
      const container = docToUse.body;
      if (!container) return;

      let changed = false;
      // Target all potentially editable elements, including those in Header/Footer
      const allElements = container.querySelectorAll('h1, h2, h3, h4, h5, h6, p, span, a, li, img, button, blockquote, div.card, div.gallery-item, div.feature-item');

      allElements.forEach((el, index) => {
        // Skip elements that are part of the admin UI or internal CMS stuff
        if (el.closest('.cms-toolbar') || el.classList.contains('cms-toolbar') || el.id === 'livePreview') return;

        if (!el.id) {
          const section = el.closest('section') || el.closest('header') || el.closest('footer') || el.parentElement;
          const secId = (section && section.id) ? section.id : 'el';
          const tag = el.tagName.toLowerCase();
          el.id = `${secId}-${tag}-${index}`;
          changed = true;
        }
      });

      if (changed) {
        loadedHtmlContent = '<!DOCTYPE html>\n' + docToUse.documentElement.outerHTML;
      }
    }

    function getCleanHtml(htmlString) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(htmlString || loadedHtmlContent, 'text/html');

      // Remove all CMS-injected elements
      const toRemove = doc.querySelectorAll('.cms-toolbar, .cms-size-handle, .cms-resize-handle, .cms-section-highlight, [contenteditable]');
      toRemove.forEach(el => {
        if (el.classList.contains('cms-toolbar') || el.classList.contains('cms-size-handle')) {
          el.remove();
        } else {
          el.removeAttribute('contenteditable');
          el.classList.remove('cms-section-highlight', 'cms-editable-hover');
        }
      });

      return '<!DOCTYPE html>\n' + doc.documentElement.outerHTML;
    }

    // --- DRAG & DROP LOGIC ---
    let dragSrcEl = null;

    function handleDragStart(e) {
      dragSrcEl = this;
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/html', this.innerHTML);
      this.classList.add('dragging');
    }

    function handleDragOver(e) {
      if (e.preventDefault) {
        e.preventDefault();
      }
      e.dataTransfer.dropEffect = 'move';
      return false;
    }

    function handleDragEnter(e) {
      this.classList.add('over');
    }

    function handleDragLeave(e) {
      this.classList.remove('over');
    }

    function handleDrop(e) {
      if (e.stopPropagation) {
        e.stopPropagation();
      }

      if (dragSrcEl !== this) {
        const srcId = dragSrcEl.getAttribute('data-id');
        const targetId = this.getAttribute('data-id');

        reorderSections(srcId, targetId);
      }
      return false;
    }

    function handleDragEnd(e) {
      this.classList.remove('dragging');
      document.querySelectorAll('#sectionTable tbody tr').forEach(row => {
        row.classList.remove('over');
      });
    }

    function reorderSections(srcId, targetId) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(loadedHtmlContent, 'text/html');
      const main = doc.getElementById('cms-main-content') || doc.querySelector('main');
      const srcEl = doc.getElementById(srcId);
      const targetEl = doc.getElementById(targetId);

      if (main && srcEl && targetEl) {
        const allSections = Array.from(main.children);
        const srcIndex = allSections.indexOf(srcEl);
        const targetIndex = allSections.indexOf(targetEl);

        if (srcIndex < targetIndex) {
          // Moving down: insert after target
          if (targetEl.nextElementSibling) {
            main.insertBefore(srcEl, targetEl.nextElementSibling);
          } else {
            main.appendChild(srcEl);
          }
        } else {
          // Moving up: insert before target
          main.insertBefore(srcEl, targetEl);
        }

        loadedHtmlContent = '<!DOCTYPE html>\n' + doc.documentElement.outerHTML;
        renderSectionManager();
        updatePreview();
        saveToHistory();
      }
    }

    // --- SIDEBAR TOGGLE ---
    window.toggleSidebar = function () {
      document.body.classList.toggle('sidebar-collapsed');
    }

    function deleteElement(id) {
      if (!confirm("Element wirklich löschen?")) return;
      const parser = new DOMParser();
      const doc = parser.parseFromString(loadedHtmlContent, 'text/html');
      const el = doc.getElementById(id);
      if (el) {
        el.remove();
        loadedHtmlContent = '<!DOCTYPE html>\n' + doc.documentElement.outerHTML;
        updatePreview();
        saveToHistory();
        if (currentlyEditingSection && currentTab === 'sections') {
          editDynamicSection(currentlyEditingSection);
        } else if (currentTab) {
          renderCMSFields(currentTab);
        }
      }
    }

    // --- UNIFIED RENDERER FOR ALL SECTIONS ---
    function renderCMSFields(tabId) {
      currentTab = tabId;
      document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
      const navItem = Array.from(document.querySelectorAll('.nav-item')).find(el => el.getAttribute('onclick')?.includes(tabId));
      if (navItem) navItem.classList.add('active');
      const titleEl = document.getElementById('currentTabTitle');
      if (titleEl && navItem) titleEl.innerText = navItem.innerText.trim();

      const container = document.getElementById('cmsFormFields');
      container.innerHTML = '';
      currentlyEditingSection = null;

      // Managers Config
      const managerIds = ['galleryManager', 'socialLinksManager', 'sectionManager', 'fileLoadWarning', 'exportArea'];
      managerIds.forEach(id => document.getElementById(id)?.classList.add('hidden'));

      // 1. Special Managers (Booking, Gallery, Social, Sections, Start)
      if (tabId === 'gallery') { document.getElementById('galleryManager').classList.remove('hidden'); renderGalleryItems(); return; }
      if (tabId === 'social') { document.getElementById('socialLinksManager').classList.remove('hidden'); renderSocialLinks(); return; }
      if (tabId === 'sections') { document.getElementById('sectionManager').classList.remove('hidden'); renderSectionManager(); return; }
      if (tabId === 'bookings') {
        document.getElementById('tab-bookings').classList.remove('hidden');
        document.getElementById('tab-cms').classList.add('hidden');
        renderCalendar();
        renderBookings();
        return;
      } else {
        document.getElementById('tab-bookings').classList.add('hidden');
        document.getElementById('tab-cms').classList.remove('hidden');
      }
      if (tabId === 'start') {
        if (loadedHtmlContent) {
          const projectCard = document.createElement('div');
          projectCard.className = 'card';
          projectCard.innerHTML = `
             <h2>Projekt: Aktiv</h2>
             <p style="color:#28a745; margin-bottom:1.5rem;">✅ index.html erfolgreich geladen</p>
             <div style="display:flex; flex-direction:column; gap:1rem;">
               <button onclick="saveDirectly()" class="btn btn-primary" style="background: var(--blue-action); border:none;"><i class="fas fa-save"></i> Änderungen jetzt speichern</button>
               
               <div style="display:grid; grid-template-columns: 1fr 1fr; gap:0.75rem;">
                  <button onclick="switchTab('sections')" class="btn btn-ghost" style="border:1px dashed var(--border); padding: 1rem 0.5rem;">
                    <i class="fas fa-plus-circle" style="display:block; margin-bottom:5px; color:var(--blue-action); font-size: 1.2rem;"></i> Sektion +
                  </button>
                  <button onclick="switchTab('design')" class="btn btn-ghost" style="border:1px dashed var(--border); padding: 1rem 0.5rem;">
                    <i class="fas fa-paint-brush" style="display:block; margin-bottom:5px; color:var(--blue-action); font-size: 1.2rem;"></i> Design +
                  </button>
               </div>

               <button onclick="createNewProject()" class="btn btn-ghost" style="opacity: 0.7;"><i class="fas fa-plus"></i> Neues Projekt (Leere Seite)</button>
               <button onclick="document.getElementById('filePickerBtn').click()" class="btn btn-ghost"><i class="fas fa-folder-open"></i> Andere Datei öffnen</button>
             </div>
           `;
          container.appendChild(projectCard);
        } else {
          document.getElementById('fileLoadWarning').classList.remove('hidden');
        }
        return;
      }

      // Ensure IDs are present for everything to be editable
      ensureGlobalCmsIds();

      // 2. Design Tab (Colors)
      if (tabId === 'design') { renderDesignFields(container); return; }

      if (!loadedHtmlContent) {
        document.getElementById('fileLoadWarning').classList.remove('hidden');
        return;
      }

      // 3. UNIFIED STRATEGY
      // First, try Auto-Scan 
      let scanId = tabId;
      if (tabId === 'footer') scanId = 'footer'; // Explicit map if needed

      let finalFields = null;
      let usedId = scanId;
      let isFallback = false;

      const scanResult = scanSectionForFields(scanId);

      if (scanResult.sectionFound) {
        // Case A: Found a real DOM section matching the ID
        finalFields = scanResult.fields;
        usedId = scanId;
      } else if (SECTIONS[tabId]) {
        // Case B: Fallback to Configured Fields (e.g. Hero, Intro)
        // We use the configured definitions but pass them to the Unified Editor
        // to get the nice UI (Move/Delete).
        finalFields = SECTIONS[tabId];
        isFallback = true;
        // We will attempt to guess the Container ID inside renderUnifiedEditor
      }

      if (finalFields) {
        renderUnifiedEditor(usedId, finalFields, container, isFallback);
      } else {
        container.innerHTML = `<div class="card"><p>Kein bearbeitbarer Bereich für '${scanId}' gefunden.</p></div>`;
      }
    }

    function renderDesignFields(container) {
      const fields = SECTIONS['design'];
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = '<h3>Design & Farben</h3><p style="color:#666; font-size:0.9rem; margin-bottom:1rem;">Hier kannst du die globalen Farben deiner Website anpassen.</p>';

      fields.forEach(field => {
        const group = document.createElement('div');
        group.className = 'form-group';
        group.innerHTML = `<label style="display:block; margin-bottom:0.5rem;">${field.label}</label>`;

        let input;
        if (field.type === 'font-select') {
          input = document.createElement('select');
          input.innerHTML = fontOptions.map(o => `<option value="${o.value}">${o.name}</option>`).join('');
        } else {
          input = document.createElement('input');
          input.type = field.type === 'color' ? 'color' : 'text';
          if (field.type === 'color') input.style.height = '40px';
        }

        input.style.width = '100%';
        input.id = field.id;

        // Try to find current value 
        const map = {
          'cms-color-primary': '--primary',
          'cms-color-accent': '--accent',
          'cms-color-secondary': '--secondary',
          'cms-color-bg': '--bg-body',
          'cms-color-text': '--text-main',
          'cms-color-muted': '--text-muted',
          'cms-font-heading': '--font-heading',
          'cms-font-body': '--font-body',
          'cms-size-h1': '--size-h1',
          'cms-size-h2': '--size-h2',
          'cms-size-p': '--size-p'
        };
        const varName = map[field.id];
        if (varName) {
          const regex = new RegExp(`${varName}:\\s*([^;]+)`);
          const match = loadedHtmlContent.match(regex);
          if (match && match[1]) {
            let val = match[1].trim();
            if (field.type === 'font-select') {
              // try to find closest match in fontOptions
              const found = fontOptions.find(o => val.includes(o.value.replace(/['"]/g, '')) || o.value.includes(val.replace(/['"]/g, '')));
              if (found) input.value = found.value;
            } else {
              input.value = val;
            }
          }
        }

        input.oninput = (e) => updateCssVariable(field.id, e.target.value);
        if (field.type === 'font-select') input.onchange = (e) => updateCssVariable(field.id, e.target.value);

        group.appendChild(input);
        card.appendChild(group);
      });
      container.appendChild(card);
    }

    function updateCssVariable(varId, value) {
      const map = {
        'cms-color-primary': '--primary',
        'cms-color-accent': '--accent',
        'cms-color-secondary': '--secondary',
        'cms-color-bg': '--bg-body',
        'cms-color-text': '--text-main',
        'cms-color-muted': '--text-muted',
        'cms-font-heading': '--font-heading',
        'cms-font-body': '--font-body',
        'cms-size-h1': '--size-h1',
        'cms-size-h2': '--size-h2',
        'cms-size-p': '--size-p'
      };
      const varName = map[varId];
      if (!varName) return;

      const parser = new DOMParser();
      const doc = parser.parseFromString(loadedHtmlContent, 'text/html');

      // Handle Font Import
      if (varId.includes('font')) {
        importGoogleFont(doc, value);
      }

      let themeStyle = doc.getElementById('cms-theme-style');
      if (!themeStyle) {
        themeStyle = doc.createElement('style');
        themeStyle.id = 'cms-theme-style';
        doc.head.appendChild(themeStyle);
        themeStyle.innerHTML = `:root { ${varName}: ${value}; }`;
      } else {
        const regex = new RegExp(`${varName}:\\s*[^;]+`, 'g');
        if (themeStyle.innerHTML.match(regex)) {
          themeStyle.innerHTML = themeStyle.innerHTML.replace(regex, `${varName}: ${value}`);
        } else {
          if (themeStyle.innerHTML.includes(':root')) {
            themeStyle.innerHTML = themeStyle.innerHTML.replace(':root {', `:root {\n      ${varName}: ${value};`);
          } else {
            themeStyle.innerHTML += `\n:root { ${varName}: ${value}; }`;
          }
        }
      }

      loadedHtmlContent = '<!DOCTYPE html>\n' + doc.documentElement.outerHTML;
      updatePreview();
    }

    function renderFallbackFields(tabId, fields, container) {
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `<div style="margin-bottom:1rem; border-bottom:1px solid #eee; padding-bottom:0.5rem;">
        <span class="badge" style="background:#ffc107; color:#000; padding:2px 6px; border-radius:4px; font-size:0.7em;">Standard-Modus</span> 
        <small style="color:#666; margin-left:0.5rem;">Bereich "${tabId}" hat keine eindeutige Sektions-ID. Bearbeite konfigurierte Felder.</small>
      </div>`;

      fields.forEach(field => {
        const group = document.createElement('div');
        group.className = 'form-group';
        group.style.padding = '0.5rem 0';

        const labelRow = document.createElement('div');
        labelRow.style.display = 'flex';
        labelRow.style.justifyContent = 'space-between';
        labelRow.style.alignItems = 'center';

        const label = document.createElement('label');
        label.innerText = field.label;
        labelRow.appendChild(label);

        if (field.attr === 'src' || field.special === 'hero-bg') {
          const btn = document.createElement('button');
          btn.innerHTML = '📁';
          btn.className = 'btn btn-ghost';
          btn.onclick = () => triggerFilePicker(field.id);
          labelRow.appendChild(btn);
        }

        group.appendChild(labelRow);

        // Text Toolbar
        if ((field.type === 'text' || field.type === 'textarea') && !field.attr) {
          const tb = createTextToolbar(field.id);
          tb.style.marginBottom = '0.2rem';
          group.appendChild(tb);
        }

        let input;
        if (field.type === 'textarea') {
          input = document.createElement('textarea');
          input.rows = 3;
        } else {
          input = document.createElement('input');
          input.type = 'text';
        }

        if (field.attr === 'src' || field.special === 'hero-bg') {
          enableDragDrop(input);
          input.placeholder = "Klicke zum Wählen...";
          input.readOnly = true;
          input.onclick = () => triggerFilePicker(field.id);
        }

        input.value = getValueFromDoc(field);
        input.id = field.id;
        input.oninput = () => updateDocValue(field, input.value);
        input.onfocus = () => highlightInPreview(field.id);

        group.appendChild(input);
        card.appendChild(group);
      });

      container.appendChild(card);
    }

    function editDynamicSection(sectionId) {
      currentTab = 'sections';
      currentlyEditingSection = sectionId;
      const scanResult = scanSectionForFields(sectionId);
      const container = document.getElementById('cmsFormFields');
      container.innerHTML = '';
      document.getElementById('sectionManager').classList.add('hidden');
      renderUnifiedEditor(sectionId, scanResult.fields, container);
    }

    function renderUnifiedEditor(sectionId, fields, container, isFallback) {
      // Smart Guessing: If id not found, try to find parent of first field
      let validId = sectionId;
      if (isFallback) {
        const parser = new DOMParser();
        const doc = parser.parseFromString(loadedHtmlContent, 'text/html');
        if (!doc.getElementById(sectionId) && fields.length > 0) {
          const firstEl = doc.getElementById(fields[0].id);
          if (firstEl) {
            const p = firstEl.closest('section') || firstEl.closest('header') || firstEl.closest('footer') || firstEl.parentElement;
            if (p && p.id) validId = p.id;
          }
        }
      }
      // Use the valid ID for the rest of the function (Padding, etc.)
      sectionId = validId;
      currentlyEditingSection = sectionId;

      const iframe = document.getElementById('livePreview');
      if (iframe && iframe.contentWindow) {
        iframe.contentWindow.postMessage({ type: 'highlight-section', id: sectionId }, '*');
      }

      const card = document.createElement('div');
      card.className = 'card';
      card.style.borderLeft = '5px solid var(--primary)';

      // Header
      const header = document.createElement('div');
      header.style.marginBottom = '1.5rem';
      header.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
             <div>
               <span style="font-size:0.8rem; text-transform:uppercase; color:#888;">Bearbeite Sektor</span>
               <h3 style="margin:0;">${sectionId}</h3>
             </div>
             ${currentTab === 'sections' ? `<button onclick="document.getElementById('sectionManager').classList.remove('hidden'); document.getElementById('cmsFormFields').innerHTML='';" class="btn btn-ghost">Zurück</button>` : ''}
        </div>
       `;

      // Padding & Font Controls
      const pads = document.createElement('div');
      pads.style.background = '#f9f9f9';
      pads.style.padding = '1rem';
      pads.style.borderRadius = '8px';
      pads.style.display = 'grid';
      pads.style.gridTemplateColumns = '1fr 1fr';
      pads.style.gap = '1rem';
      pads.innerHTML = `
         <div>
            <label style="font-size:0.8rem;">Größe (Abstand Oben)</label>
            <input type="range" min="0" max="10" step="0.5" value="4" style="width:100%" 
             oninput="this.nextElementSibling.innerText = this.value + ' rem'; setSectionPadding('${sectionId}', this, 'Top')">
            <span style="font-size:0.8rem; color:#666; float:right;"> - </span>
         </div>
         <div>
            <label style="font-size:0.8rem;">Größe (Abstand Unten)</label>
            <input type="range" min="0" max="10" step="0.5" value="4" style="width:100%" 
             oninput="this.nextElementSibling.innerText = this.value + ' rem'; setSectionPadding('${sectionId}', this, 'Bottom')">
            <span style="font-size:0.8rem; color:#666; float:right;"> - </span>
         </div>
         
         <div style="grid-column: 1 / -1; border-top: 1px dashed #ddd; padding-top: 0.5rem; margin-top: 0.5rem; display:grid; grid-template-columns: 1fr 1fr; gap:0.5rem;">
            <div>
              <label style="font-size:0.8rem;">Schriftart Überschriften</label>
              <select id="font-h-${sectionId}" style="font-size:0.85rem; padding:0.3rem;" onchange="setSectionFont('${sectionId}', '--font-heading', this.value)">
                ${fontOptions.map(o => `<option value="${o.value}">${o.name}</option>`).join('')}
              </select>
            </div>
            <div>
              <label style="font-size:0.8rem;">Schriftart Fließtext</label>
              <select id="font-p-${sectionId}" style="font-size:0.85rem; padding:0.3rem;" onchange="setSectionFont('${sectionId}', '--font-body', this.value)">
                ${fontOptions.map(o => `<option value="${o.value}">${o.name}</option>`).join('')}
              </select>
            </div>
         </div>

         <div style="grid-column: 1 / -1; border-top: 1px dashed #ddd; padding-top: 0.5rem; margin-top: 0.5rem; display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
            <div>
              <label style="font-size:0.8rem; display:block; margin-bottom:0.5rem;">Hintergrundbild</label>
              <div style="display:flex; gap:0.5rem;">
                 <input type="text" id="sec-bg-${sectionId}" placeholder="bild.jpg" readonly 
                        onclick="triggerFilePicker('sec-bg-${sectionId}', (url) => setSectionBg('${sectionId}', url))"
                        style="flex:1; padding:0.4rem; border:1px solid #ccc; border-radius:4px; font-size:0.85rem;">
                 <button onclick="triggerFilePicker('sec-bg-${sectionId}', (url) => setSectionBg('${sectionId}', url))" class="btn btn-ghost" style="padding:0.4rem;">
                     <i class="fas fa-image"></i>
                 </button>
                 <button onclick="setSectionBg('${sectionId}', '')" class="btn btn-ghost" style="padding:0.4rem; color: #dc3545;" title="Entfernen">
                     <i class="fas fa-trash"></i>
                 </button>
              </div>
            </div>
            <div>
              <label style="font-size:0.8rem; display:block; margin-bottom:0.5rem;">Hintergrundvideo</label>
              <div style="display:flex; gap:0.5rem;">
                 <input type="text" id="sec-video-${sectionId}" placeholder="video.mp4" readonly 
                        onclick="triggerFilePicker('sec-video-${sectionId}', (url) => setSectionVideo('${sectionId}', url), 'video/*')"
                        style="flex:1; padding:0.4rem; border:1px solid #ccc; border-radius:4px; font-size:0.85rem;">
                 <button onclick="triggerFilePicker('sec-video-${sectionId}', (url) => setSectionVideo('${sectionId}', url), 'video/*')" class="btn btn-ghost" style="padding:0.4rem;">
                     <i class="fas fa-video"></i>
                 </button>
                 <button onclick="setSectionVideo('${sectionId}', '')" class="btn btn-ghost" style="padding:0.4rem; color: #dc3545;" title="Entfernen">
                     <i class="fas fa-trash"></i>
                 </button>
              </div>
            </div>
         </div>
        `;
      header.appendChild(pads);
      card.appendChild(header);

      // Fields
      const fieldsDiv = document.createElement('div');
      renderFieldsToContainer(fields, fieldsDiv, true);
      card.appendChild(fieldsDiv);

      // "Add Element" Footer
      const footer = document.createElement('div');
      footer.style.marginTop = '2rem';
      footer.style.borderTop = '1px dashed #eee';
      footer.style.paddingTop = '1rem';
      footer.innerHTML = `
          <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:0.75rem">
            <button onclick="addImageToSection('${sectionId}')" class="btn btn-ghost" style="border:1px dashed #ccc;"><i class="fas fa-image"></i> Bild</button>
            <button onclick="addVideoToSection('${sectionId}')" class="btn btn-ghost" style="border:1px dashed #ccc;"><i class="fas fa-video"></i> Video</button>
            <button onclick="addButtonToSection('${sectionId}')" class="btn btn-ghost" style="border:1px dashed #ccc;"><i class="fas fa-link"></i> Button</button>
            <button onclick="addTextToSection('${sectionId}')" class="btn btn-ghost" style="border:1px dashed #ccc;"><i class="fas fa-font"></i> Text</button>
            <button onclick="addGridToSection('${sectionId}')" class="btn btn-ghost" style="border:1px dashed #ccc;"><i class="fas fa-th-large"></i> Grid</button>
          </div>
          <div style="margin-top:0.75rem;">
            <button onclick="openAddSectionAfter('${sectionId}')" class="btn btn-primary btn-ghost" style="width:100%; border:1px dashed var(--blue-action); color:var(--blue-action);">
              <i class="fas fa-plus-circle"></i> Sektion danach einfügen
            </button>
          </div>
       `;
      card.appendChild(footer);

      container.appendChild(card);

      // Set current padding values
      const parser = new DOMParser();
      const doc = parser.parseFromString(loadedHtmlContent, 'text/html');
      const sec = doc.getElementById(sectionId);
      if (sec) {
        let pt = sec.style.paddingTop.replace('rem', '').trim();
        let pb = sec.style.paddingBottom.replace('rem', '').trim();
        if (!pt) pt = "6";
        if (!pb) pb = "6";

        const inputs = pads.querySelectorAll('input[type=range]');
        inputs[0].value = parseFloat(pt); inputs[0].nextElementSibling.innerText = pt + ' rem';
        inputs[1].value = parseFloat(pb); inputs[1].nextElementSibling.innerText = pb + ' rem';

        // Set current font values
        const fh = sec.style.getPropertyValue('--font-heading').trim();
        const fb = sec.style.getPropertyValue('--font-body').trim();
        const selH = pads.querySelector(`#font-h-${sectionId}`);
        const selB = pads.querySelector(`#font-p-${sectionId}`);
        if (selH && fh) {
          const existing = fontOptions.find(o => o.value.includes(fh.replace(/['"]/g, '')) || fh.includes(o.value.replace(/['"]/g, '')));
          if (existing) selH.value = existing.value;
        }
        if (selB && fb) {
          const existing = fontOptions.find(o => o.value.includes(fb.replace(/['"]/g, '')) || fb.includes(o.value.replace(/['"]/g, '')));
          if (existing) selB.value = existing.value;
        }

        // Set current BG values
        const bgImg = sec.style.backgroundImage.replace(/url\(['"]?|['"]?\)/g, '');
        const bgVid = sec.getAttribute('data-video');
        const inputBg = pads.querySelector(`#sec-bg-${sectionId}`);
        const inputVid = pads.querySelector(`#sec-video-${sectionId}`);
        if (inputBg) inputBg.value = bgImg;
        if (inputVid) inputVid.value = bgVid || '';
      }
    }


    function renderFieldsToContainer(fields, container, isDynamic) {
      fields.forEach(field => {
        const group = document.createElement('div');
        group.className = 'form-group element-card';
        group.style.padding = '1.25rem';
        group.style.background = 'rgba(255,255,255,0.02)';
        group.style.borderRadius = 'var(--radius-md)';
        group.style.border = '1px solid var(--border)';
        group.style.position = 'relative';
        group.style.transition = 'all 0.3s';
        group.style.marginBottom = '1rem';

        // Element Drag and Drop
        group.setAttribute('draggable', 'true');
        group.ondragstart = (e) => {
          e.dataTransfer.setData('text/element', field.id);
          group.style.opacity = '0.4';
          group.style.transform = 'scale(0.98)';
        };
        group.ondragend = () => {
          group.style.opacity = '1';
          group.style.transform = 'scale(1)';
        };
        group.ondragover = (e) => e.preventDefault();
        group.ondrop = (e) => {
          e.preventDefault();
          const srcId = e.dataTransfer.getData('text/element');
          if (srcId && srcId !== field.id) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(loadedHtmlContent, 'text/html');
            const srcEl = doc.getElementById(srcId);
            const targetEl = doc.getElementById(field.id);
            if (srcEl && targetEl) {
              targetEl.before(srcEl);
              loadedHtmlContent = '<!DOCTYPE html>\n' + doc.documentElement.outerHTML;
              updatePreview();
              saveToHistory();
              if (isDynamic && currentlyEditingSection) editDynamicSection(currentlyEditingSection);
              else renderCMSFields(currentTab);
            }
          }
        };

        const labelRow = document.createElement('div');
        labelRow.style.display = 'flex';
        labelRow.style.justifyContent = 'space-between';
        labelRow.style.alignItems = 'center';
        labelRow.style.marginBottom = '0.75rem';

        const labelLeft = document.createElement('div');
        labelLeft.innerHTML = `<strong>${field.label}</strong> <span style="font-size:0.75rem; color:var(--text-muted); opacity:0.6;">#${field.id}</span>`;
        labelRow.appendChild(labelLeft);

        const actionsDiv = document.createElement('div');
        actionsDiv.style.display = 'flex';
        actionsDiv.style.gap = '4px';

        const delBtn = document.createElement('button');
        delBtn.innerHTML = '<i class="fas fa-trash"></i>';
        delBtn.className = 'btn btn-ghost btn-icon';
        delBtn.style.color = 'var(--accent-danger)';
        delBtn.style.width = '30px';
        delBtn.style.height = '30px';
        delBtn.onclick = () => deleteElement(field.id);
        actionsDiv.appendChild(delBtn);

        labelRow.appendChild(actionsDiv);
        group.appendChild(labelRow);

        // Text Toolbar
        if ((field.type === 'text' || field.type === 'textarea') && !field.attr && !field.isLink) {
          group.appendChild(createTextToolbar(field.id));
        }

        let input;
        if (field.type === 'textarea') {
          input = document.createElement('textarea');
          input.rows = 2;
        } else if (field.type === 'color') {
          input = document.createElement('input');
          input.type = 'color';
        } else {
          input = document.createElement('input');
          input.type = 'text';
          if (field.attr === 'src' || field.special === 'hero-bg') {
            enableDragDrop(input);
            input.placeholder = "Klicke zum Wählen...";
            input.readOnly = true;
            input.onclick = () => triggerFilePicker(isDynamic ? `dyn-${field.id}` : `field-${field.id}`);
          }
        }

        input.value = getValueFromDoc(field);

        if (field.isLink) {
          const flexWrapper = document.createElement('div');
          flexWrapper.style.display = 'flex';
          flexWrapper.style.flexDirection = 'column';
          flexWrapper.style.gap = '0.5rem';

          input.placeholder = "Link Text";
          const hrefInput = document.createElement('input');
          hrefInput.type = 'text';
          hrefInput.placeholder = "Ziel-URL (href)";
          hrefInput.value = getAttributeFromDoc(field.id, 'href');
          hrefInput.onchange = (e) => setAttributeInDoc(field.id, 'href', e.target.value);

          flexWrapper.appendChild(input);
          flexWrapper.appendChild(hrefInput);
          group.appendChild(flexWrapper);
        } else {
          group.appendChild(input);
        }

        if (field.id) {
          input.id = isDynamic ? `dyn-${field.id}` : `field-${field.id}`;
          input.oninput = () => updateDocValue(field, input.value);
          input.onfocus = () => highlightInPreview(field.id);
        }

        container.appendChild(group);
      });
    }



    function createTextToolbar(id) {
      const toolbar = document.createElement('div');
      toolbar.className = 'text-editor-toolbar';
      toolbar.style.display = 'flex';
      toolbar.style.flexWrap = 'wrap';
      toolbar.style.gap = '0.4rem';
      toolbar.style.background = '#f8fafc';
      toolbar.style.padding = '0.5rem';
      toolbar.style.borderRadius = 'var(--radius-sm)';
      toolbar.style.marginBottom = '0.8rem';
      toolbar.style.border = '1px solid var(--border)';

      const createBtn = (icon, title, action, activeCheck) => {
        const btn = document.createElement('button');
        btn.innerHTML = `<i class="${icon}"></i>`;
        btn.className = 'btn btn-ghost btn-icon';
        btn.style.width = '32px';
        btn.style.height = '32px';
        btn.style.padding = '0';
        btn.title = title;
        btn.onclick = (e) => { e.preventDefault(); action(); };
        return btn;
      };

      // Font Selection
      const fontSelect = document.createElement('select');
      fontSelect.className = 'font-select-mini';
      fontSelect.style.fontSize = '0.7rem';
      fontSelect.style.padding = '2px 4px';
      fontSelect.style.width = '90px';
      fontSelect.style.height = '32px';
      fontSelect.style.borderRadius = 'var(--radius-sm)';
      fontSelect.style.border = '1px solid var(--border)';
      fontSelect.onchange = (e) => setStyle(id, 'fontFamily', e.target.value);

      const defaultOpt = document.createElement('option');
      defaultOpt.textContent = "Font...";
      defaultOpt.value = "";
      fontSelect.appendChild(defaultOpt);

      fontOptions.forEach(o => {
        const opt = document.createElement('option');
        opt.value = o.value;
        opt.textContent = o.name;
        fontSelect.appendChild(opt);
      });
      toolbar.appendChild(fontSelect);

      // Divider
      const sep = () => {
        const s = document.createElement('div');
        s.style.width = '1px'; s.style.height = '20px'; s.style.background = 'var(--border)'; s.style.margin = '0 0.2rem';
        return s;
      };
      toolbar.appendChild(sep());

      // Styling
      toolbar.appendChild(createBtn('fas fa-bold', 'Fett', () => toggleStyle(id, 'fontWeight', 'bold', 'normal')));
      toolbar.appendChild(createBtn('fas fa-italic', 'Kursiv', () => toggleStyle(id, 'fontStyle', 'italic', 'normal')));



      // Align
      toolbar.appendChild(createBtn('fas fa-align-left', 'Links', () => setStyle(id, 'textAlign', 'left')));
      toolbar.appendChild(createBtn('fas fa-align-center', 'Mitte', () => setStyle(id, 'textAlign', 'center')));
      toolbar.appendChild(createBtn('fas fa-align-right', 'Rechts', () => setStyle(id, 'textAlign', 'right')));

      toolbar.appendChild(sep());

      // Precise Size Selection
      const sizeSelect = document.createElement('select');
      sizeSelect.className = 'size-select-mini';
      sizeSelect.style.fontSize = '0.7rem';
      sizeSelect.style.padding = '2px 4px';
      sizeSelect.style.width = '60px';
      sizeSelect.style.height = '32px';
      sizeSelect.style.borderRadius = 'var(--radius-sm)';
      sizeSelect.style.border = '1px solid var(--border)';
      sizeSelect.onchange = (e) => setStyle(id, 'fontSize', e.target.value + 'px');

      const sizeDefault = document.createElement('option');
      sizeDefault.textContent = "Größe";
      sizeDefault.value = "";
      sizeSelect.appendChild(sizeDefault);

      for (let i = 1; i <= 100; i++) {
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = i + 'px';
        sizeSelect.appendChild(opt);
      }
      toolbar.appendChild(sizeSelect);

      toolbar.appendChild(sep());

      // Sliders for Letter Spacing & Line Height
      const createSlider = (icon, title, min, max, step, prop, unit = '') => {
        const container = document.createElement('div');
        container.style.display = 'flex';
        container.style.alignItems = 'center';
        container.style.gap = '0.5rem';
        container.style.padding = '0 0.5rem';
        container.title = title;

        const i = document.createElement('i');
        i.className = icon;
        i.style.fontSize = '0.8rem';
        i.style.opacity = '0.6';

        const slider = document.createElement('input');
        slider.type = 'range';
        slider.min = min; slider.max = max; slider.step = step;
        slider.style.width = '60px';
        slider.oninput = () => setStyle(id, prop, slider.value + unit);

        container.appendChild(i);
        container.appendChild(slider);
        return container;
      };

      toolbar.appendChild(createSlider('fas fa-arrows-alt-h', 'Zeichenabstand', -2, 10, 0.5, 'letterSpacing', 'px'));
      toolbar.appendChild(createSlider('fas fa-arrows-alt-v', 'Zeilenhöhe', 0.8, 3, 0.1, 'lineHeight'));

      toolbar.appendChild(sep());

      // Color
      const colorPicker = document.createElement('input');
      colorPicker.type = 'color';
      colorPicker.style.width = '24px';
      colorPicker.style.height = '24px';
      colorPicker.style.padding = '0';
      colorPicker.style.border = 'none';
      colorPicker.style.background = 'transparent';
      colorPicker.style.cursor = 'pointer';
      colorPicker.title = "Textfarbe";
      colorPicker.oninput = (e) => setStyle(id, 'color', e.target.value);
      toolbar.appendChild(colorPicker);

      return toolbar;
    }

    function toggleStyle(id, prop, activeVal, normalVal) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(loadedHtmlContent, 'text/html');
      const el = doc.getElementById(id);
      if (el) {
        const current = el.style[prop];
        el.style[prop] = (current === activeVal) ? normalVal : activeVal;
        loadedHtmlContent = '<!DOCTYPE html>\n' + doc.documentElement.outerHTML;
        updatePreview();
        saveToHistory();
      }
    }

    function setStyle(id, prop, val) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(loadedHtmlContent, 'text/html');
      const el = doc.getElementById(id);
      if (el) {
        if (prop === 'fontFamily' && val) {
          importGoogleFont(doc, val);
        }
        el.style[prop] = val;
        loadedHtmlContent = '<!DOCTYPE html>\n' + doc.documentElement.outerHTML;
        updatePreview();
        saveToHistory();
      }
    }

    function getAttributeFromDoc(id, attr) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(loadedHtmlContent, 'text/html');
      const el = doc.getElementById(id);
      return el ? (el.getAttribute(attr) || "") : "";
    }

    function setAttributeInDoc(id, attr, val) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(loadedHtmlContent, 'text/html');
      const el = doc.getElementById(id);
      if (el) {
        el.setAttribute(attr, val);
        loadedHtmlContent = '<!DOCTYPE html>\n' + doc.documentElement.outerHTML;
        updatePreview();
        saveToHistory();
      }
    }

    function toggleBold(id) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(loadedHtmlContent, 'text/html');
      const el = doc.getElementById(id);
      if (el) {
        const currentWeight = el.style.fontWeight;
        el.style.fontWeight = (currentWeight === 'bold' || currentWeight === '700') ? 'normal' : 'bold';
        loadedHtmlContent = '<!DOCTYPE html>\n' + doc.documentElement.outerHTML;
        updatePreview();
        saveToHistory();
      }
    }

    function setFontSize(id, size) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(loadedHtmlContent, 'text/html');
      const el = doc.getElementById(id);
      if (el) {
        el.style.fontSize = size;
        loadedHtmlContent = '<!DOCTYPE html>\n' + doc.documentElement.outerHTML;
        updatePreview();
        saveToHistory();
      }
    }

    function setTextColor(id, color) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(loadedHtmlContent, 'text/html');
      const el = doc.getElementById(id);
      if (el) {
        el.style.color = color;
        loadedHtmlContent = '<!DOCTYPE html>\n' + doc.documentElement.outerHTML;
        updatePreview();
        saveToHistory();
      }
    }

    function getComputedStyleValue(id, prop) {
      // Try to get from live preview first for accurate computed styles
      const iframe = document.getElementById('livePreview');
      if (iframe && iframe.contentWindow) {
        try {
          const doc = iframe.contentWindow.document;
          const el = doc.getElementById(id);
          if (el) {
            const style = iframe.contentWindow.getComputedStyle(el);
            return style[prop];
          }
        } catch (e) {
          console.warn("Could not access iframe styles", e);
        }
      }

      // Fallback: Check inline styles from loaded content string
      const parser = new DOMParser();
      const doc = parser.parseFromString(loadedHtmlContent, 'text/html');
      const el = doc.getElementById(id);
      if (el) {
        return el.style[prop] || "#000000";
      }
      return "#000000";
    }

    // --- IMAGE INSERTION MODAL & LOGIC ---
    let pendingSectionId = null;

    function openInsertImageModal(sectionId) {
      pendingSectionId = sectionId;
      document.getElementById('insertImageModal').classList.remove('hidden');
      document.getElementById('imgInsertPreview').style.display = 'none';
      document.getElementById('imgInsertDropZone').innerHTML = '📁<br>Hier klicken oder Bild hineinziehen';
      document.getElementById('imgInsertFilename').value = '';
    }

    function closeInsertImageModal() {
      document.getElementById('insertImageModal').classList.add('hidden');
      pendingSectionId = null;
    }

    function handleDropZoneClick() {
      triggerFilePicker(null, (filename) => {
        document.getElementById('imgInsertFilename').value = filename;
        updateDropZonePreview(filename);
      });
    }

    function handleImgDrop(e) {
      e.preventDefault();
      e.stopPropagation();
      document.getElementById('imgInsertDropZone').classList.remove('dragover');

      const file = e.dataTransfer.files[0];
      if (file) {
        document.getElementById('imgInsertFilename').value = file.name;
        updateDropZonePreview(file.name);
      }
    }

    function handleImgDragOver(e) {
      e.preventDefault();
      e.stopPropagation();
      document.getElementById('imgInsertDropZone').classList.add('dragover');
    }

    function handleImgDragLeave(e) {
      e.preventDefault();
      e.stopPropagation();
      document.getElementById('imgInsertDropZone').classList.remove('dragover');
    }

    function updateDropZonePreview(name) {
      const zone = document.getElementById('imgInsertDropZone');
      zone.innerHTML = `✅ ${name}<br><span style="font-size:0.8rem; color:#666">Bereit zum Einfügen</span>`;
    }

    function confirmInsertImage() {
      if (!pendingSectionId) return;
      const filename = document.getElementById('imgInsertFilename').value;
      const layout = document.querySelector('input[name="imgLayout"]:checked').value;

      if (!filename) {
        showNotification("Bitte erst ein Bild auswählen!", "error");
        return;
      }

      const parser = new DOMParser();
      const doc = parser.parseFromString(loadedHtmlContent, 'text/html');
      const sec = doc.getElementById(pendingSectionId);

      if (sec) {
        const container = sec.querySelector('.container') || sec;
        const img = doc.createElement('img');
        img.src = filename;
        img.id = `${pendingSectionId}-img-${Date.now()}`;

        // Layout Logic
        if (layout === 'full') {
          img.style.width = '100%';
          img.style.height = 'auto';
          img.style.borderRadius = '12px';
          img.style.marginTop = '1rem';
          img.style.display = 'block';
        } else if (layout === 'half-right') {
          img.style.width = '45%';
          img.style.float = 'right';
          img.style.marginLeft = '2rem';
          img.style.marginBottom = '1rem';
          img.style.borderRadius = '12px';
        } else if (layout === 'half-left') {
          img.style.width = '45%';
          img.style.float = 'left';
          img.style.marginRight = '2rem';
          img.style.marginBottom = '1rem';
          img.style.borderRadius = '12px';
        }

        container.appendChild(img);

        // Clear floats fix if needed
        if (layout !== 'full') {
          const clearer = doc.createElement('div');
          clearer.style.clear = 'both';
          container.appendChild(clearer);
        }

        loadedHtmlContent = '<!DOCTYPE html>\n' + doc.documentElement.outerHTML;
        updatePreview();
        saveToHistory();

        // Refresh editor if needed
        if (currentlyEditingSection === pendingSectionId) editDynamicSection(pendingSectionId);
        else if (currentTab && currentTab !== 'sections') renderCMSFields(currentTab);
      }

      closeInsertImageModal();
    }

    function addImageToSection(sectionId) {
      openInsertImageModal(sectionId);
    }

    // --- BUTTON INSERTION LOGIC ---
    let pendingButtonSectionId = null;

    function openInsertButtonModal(sectionId) {
      pendingButtonSectionId = sectionId;
      document.getElementById('insertButtonModal').classList.remove('hidden');
      document.getElementById('btnInsertText').value = '';
      document.getElementById('btnInsertLink').value = '';
    }

    function closeInsertButtonModal() {
      document.getElementById('insertButtonModal').classList.add('hidden');
      pendingButtonSectionId = null;
    }

    function confirmInsertButton() {
      if (!pendingButtonSectionId) return;
      const text = document.getElementById('btnInsertText').value;
      const link = document.getElementById('btnInsertLink').value;
      const style = document.getElementById('btnInsertStyle').value;

      if (!text || !link) {
        showNotification("Bitte Text und Link eingeben.", "error");
        return;
      }

      const parser = new DOMParser();
      const doc = parser.parseFromString(loadedHtmlContent, 'text/html');
      const sec = doc.getElementById(pendingButtonSectionId);

      if (sec) {
        const container = sec.querySelector('.container') || sec;

        const a = doc.createElement('a');
        a.href = link;
        a.textContent = text;
        a.className = `btn ${style}`;
        a.style.display = 'inline-block';
        a.style.marginTop = '1rem';
        a.style.marginRight = '0.5rem';
        a.id = `${pendingButtonSectionId}-btn-${Date.now()}`;

        container.appendChild(a);

        loadedHtmlContent = '<!DOCTYPE html>\n' + doc.documentElement.outerHTML;
        updatePreview();
        saveToHistory();

        if (currentlyEditingSection === pendingButtonSectionId) editDynamicSection(pendingButtonSectionId);
        else if (currentTab && currentTab !== 'sections') renderCMSFields(currentTab);
      }
      closeInsertButtonModal();
    }

    function addButtonToSection(sectionId) {
      openInsertButtonModal(sectionId);
    }

    function addTextToSection(sectionId) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(loadedHtmlContent, 'text/html');
      const sec = doc.getElementById(sectionId);
      if (sec) {
        const container = sec.querySelector('.container') || sec;
        const div = doc.createElement('div');
        const blockId = `${sectionId}-text-${Date.now()}`;
        div.id = blockId;
        div.innerHTML = `
          <h3 id="${blockId}-h3">Neue Überschrift</h3>
          <p id="${blockId}-p">Hier kannst du deinen neuen Textblock bearbeiten. Klicke einfach hinein oder nutze das Admin-Panel.</p>
        `;
        container.appendChild(div);
        loadedHtmlContent = '<!DOCTYPE html>\n' + doc.documentElement.outerHTML;
        updatePreview();
        saveToHistory();
        if (currentlyEditingSection === sectionId) editDynamicSection(sectionId);
      }
    }

    function addGridToSection(sectionId) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(loadedHtmlContent, 'text/html');
      const sec = doc.getElementById(sectionId);
      if (sec) {
        const container = sec.querySelector('.container') || sec;
        const gridId = `${sectionId}-grid-${Date.now()}`;
        const grid = doc.createElement('div');
        grid.className = 'cards-grid';
        grid.id = gridId;
        grid.style.display = 'grid';
        grid.style.gridTemplateColumns = 'repeat(auto-fit, minmax(280px, 1fr))';
        grid.style.gap = '2rem';
        grid.style.marginTop = '2rem';

        for (let i = 1; i <= 3; i++) {
          const item = doc.createElement('div');
          item.className = 'card';
          item.id = `${gridId}-item-${i}`;
          item.innerHTML = `
            <span id="${gridId}-i${i}" style="font-size: 2rem; display: block; margin-bottom: 1rem;">📦</span>
            <h3 id="${gridId}-h${i}">Feature ${i}</h3>
            <p id="${gridId}-p${i}">Kurze Beschreibung für dieses Element im Grid.</p>
          `;
          grid.appendChild(item);
        }

        container.appendChild(grid);
        loadedHtmlContent = '<!DOCTYPE html>\n' + doc.documentElement.outerHTML;
        updatePreview();
        saveToHistory();
        if (currentlyEditingSection === sectionId) editDynamicSection(sectionId);
      }
    }

    function addButtonToTab(tabId) {
      // Similar resolve logic as addImageToTab
      if (!SECTIONS[tabId] || SECTIONS[tabId].length === 0) return;
      const firstId = SECTIONS[tabId][0].id;

      const parser = new DOMParser();
      const doc = parser.parseFromString(loadedHtmlContent, 'text/html');
      const el = doc.getElementById(firstId);
      if (!el) return showNotification("Hauptelement des Bereichs nicht gefunden.", "error");

      let section = el.closest('section') || el.closest('header') || el.closest('footer');
      if (!section) section = el.parentElement;
      if (!section) section = el;

      const sectionId = section.id || `tab-sec-${tabId}`;
      if (!section.id) {
        section.id = sectionId;
        loadedHtmlContent = '<!DOCTYPE html>\n' + doc.documentElement.outerHTML;
      }

      addButtonToSection(sectionId);
    }


    function addImageToTab(tabId) {
      if (!SECTIONS[tabId] || SECTIONS[tabId].length === 0) return;
      const firstId = SECTIONS[tabId][0].id;

      const parser = new DOMParser();
      const doc = parser.parseFromString(loadedHtmlContent, 'text/html');
      const el = doc.getElementById(firstId);
      if (!el) return showNotification("Hauptelement des Bereichs nicht gefunden.", "error");

      // Try to find the parent section
      let section = el.closest('section') || el.closest('header') || el.closest('footer');
      // If not strict section/header/footer, try looking up a few levels
      if (!section) section = el.parentElement;
      if (!section) section = el; // Fallback to sticking it next to the element

      const sectionId = section.id || `tab-sec-${tabId}`;
      if (!section.id) {
        section.id = sectionId;
        // Save the ID assignment so addImageToSection can find it
        loadedHtmlContent = '<!DOCTYPE html>\n' + doc.documentElement.outerHTML;
      }

      addImageToSection(sectionId);
    }

    function addVideoToSection(sectionId) {
      triggerFilePicker(null, (fileName) => {
        const parser = new DOMParser();
        const doc = parser.parseFromString(loadedHtmlContent, 'text/html');
        const sec = doc.getElementById(sectionId);
        if (sec) {
          const container = sec.querySelector('.container') || sec;
          const link = doc.createElement('a');
          link.href = fileName;
          link.className = 'btn btn-video';
          link.id = `${sectionId}-video-${Date.now()}`;
          link.innerHTML = `<i class="fas fa-video"></i> Video herunterladen`;
          link.setAttribute('download', fileName);
          container.appendChild(link);

          loadedHtmlContent = '<!DOCTYPE html>\n' + doc.documentElement.outerHTML;
          updatePreview();
          saveToHistory();
          if (currentlyEditingSection === sectionId) editDynamicSection(sectionId);
        }
      }, 'video/*');
    }

    let selectedModalTemplate = null;
    let modalInsertAfterId = null;

    function openAddSectionAfter(afterId) {
      modalInsertAfterId = afterId;
      document.getElementById('modalInsertAfterId').value = afterId;
      populateModalTemplates();
      document.getElementById('insertSectionModal').classList.remove('hidden');
    }

    function closeInsertSectionModal() {
      document.getElementById('insertSectionModal').classList.add('hidden');
      selectedModalTemplate = null;
    }

    const SECTION_TEMPLATES = [
      { id: 'hero-main', label: 'Hero / Header', icon: 'fas fa-star' },
      { id: 'intro-basic', label: 'Einleitung', icon: 'fas fa-info-circle' },
      { id: 'about-basic', label: 'Über mich', icon: 'fas fa-user' },
      { id: 'services-list', label: 'Leistungen', icon: 'fas fa-concierge-bell' },
      { id: 'gallery-grid', label: 'Galerie', icon: 'fas fa-images' },
      { id: 'text-image', label: 'Text & Bild', icon: 'fas fa-file-alt' },
      { id: 'grid-3', label: '3-Spalten Text', icon: 'fas fa-th' },
      { id: 'grid-img-3', label: '3-Spalten Bilder', icon: 'fas fa-th-large' },
      { id: 'banner', label: 'Info-Banner', icon: 'fas fa-bullhorn' }
    ];

    function populateModalTemplates() {
      const grid = document.getElementById('modalTemplateGrid');
      grid.innerHTML = SECTION_TEMPLATES.map(t => `
          <button onclick="selectModalTemplate('${t.id}', this)" class="btn btn-ghost modal-template-btn" style="border: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; padding: 1rem; gap: 0.5rem; height: auto;">
            <i class="${t.icon}" style="font-size: 1.5rem; color: var(--blue-action);"></i>
            <span style="font-size: 0.75rem;">${t.label}</span>
          </button>
        `).join('');
    }

    window.selectModalTemplate = function (type, btn) {
      selectedModalTemplate = type;
      document.querySelectorAll('.modal-template-btn').forEach(b => {
        b.style.borderColor = 'var(--border)';
        b.style.background = 'transparent';
      });
      btn.style.borderColor = 'var(--blue-action)';
      btn.style.background = 'rgba(0, 123, 255, 0.05)';
    }

    function confirmInsertSectionModal() {
      if (!selectedModalTemplate) return showNotification("Bitte eine Vorlage wählen!", "error");
      const customId = document.getElementById('modalSectionId').value.trim();
      const afterId = document.getElementById('modalInsertAfterId').value;

      if (afterId === 'start') {
        addNewSection(selectedModalTemplate, 'start', customId);
      } else {
        addNewSection(selectedModalTemplate, 'after', customId, afterId);
      }
      closeInsertSectionModal();
    }

    function addNewSection(forceType, forcePos, forceId, forceAfter) {
      const type = forceType || document.getElementById('sectionTemplateSelect').value;
      const pos = forcePos || document.getElementById('sectionPositionSelect').value;
      const customId = forceId || document.getElementById('sectionIdInput').value.trim();
      const afterId = forceAfter || document.getElementById('sectionInsertAfterSelect').value;

      const parser = new DOMParser();
      const doc = parser.parseFromString(loadedHtmlContent, 'text/html');
      const main = doc.getElementById('cms-main-content') || doc.querySelector('main');
      if (!main) return showNotification("Fehler: Haupt-Inhalt nicht gefunden.", "error");

      const newId = customId || `cms-sec-${Date.now()}`;
      if (doc.getElementById(newId)) return showNotification("ID bereits vergeben!", "error");

      let html = "";
      if (type === 'hero-main') {
        html = `
          <section id="${newId}" style="padding: 10rem 0; background: #f0f4f8; text-align: center;">
            <div class="container">
              <h1 id="${newId}-h1" style="margin-bottom: 1.5rem;">Überschrift Hero</h1>
              <p id="${newId}-p" style="font-size: 1.25rem; max-width: 700px; margin: 0 auto 2.5rem;">Hier steht eine überzeugende Einleitung für deine Besucher.</p>
              <a href="#" class="btn btn-primary" id="${newId}-btn" style="background: var(--primary); color: white;">Aktion starten</a>
            </div>
          </section>
        `;
      } else if (type === 'intro-basic') {
        html = `
          <section id="${newId}" style="padding: 8rem 0; background: #ffffff;">
            <div class="container" style="display: grid; grid-template-columns: 1.2fr 1fr; gap: 5rem; align-items: center;">
              <div>
                <span id="${newId}-badge" style="background: #e2e8f0; padding: 5px 15px; border-radius: 50px; font-size: 0.8rem; font-weight: bold;">WILLKOMMEN</span>
                <h2 id="${newId}-h2" style="font-size: 3rem; margin: 1.5rem 0;">Dein Einleitungstext</h2>
                <p id="${newId}-p1" style="font-size: 1.2rem; font-weight: 600; color: #333; margin-bottom: 1rem;">Ein kurzer, prägnanter Satz.</p>
                <p id="${newId}-p2">Hier kannst du mehr über dein Projekt oder dich selbst schreiben. Erzähle deine Geschichte.</p>
              </div>
              <div>
                <img id="${newId}-img" src="intro.jpg" style="width: 100%; border-radius: 30px; box-shadow: 0 40px 80px -20px rgba(0,0,0,0.1);">
              </div>
            </div>
          </section>
        `;
      } else if (type === 'about-basic') {
        html = `
          <section id="${newId}" style="padding: 8rem 0; background: #f9f9f9;">
            <div class="container" style="display: grid; grid-template-columns: 1fr 1.2fr; gap: 6rem; align-items: center;">
              <div style="position: relative;">
                <img id="${newId}-img" src="about.jpg" style="width: 100%; border-radius: 20px; z-index: 2; position: relative;">
                <div style="position: absolute; width: 100%; height: 100%; border: 2px solid var(--primary); top: 20px; left: -20px; border-radius: 20px; z-index: 1;"></div>
              </div>
              <div>
                <h2 id="${newId}-h2" style="font-size: 2.5rem;">Über mich</h2>
                <p id="${newId}-p1" style="margin-bottom: 1.5rem;">Hier steht ein persönlicher Text über dich oder dein Team.</p>
                <p id="${newId}-p2">Ergänzende Informationen, Ziele oder Visionen können hier platziert werden.</p>
              </div>
            </div>
          </section>
        `;
      } else if (type === 'services-list') {
        html = `
          <section id="${newId}" style="padding: 8rem 0; background: #ffffff;">
            <div class="container">
              <div style="text-align: center; margin-bottom: 5rem;">
                <h2 id="${newId}-h2" style="font-size: 3rem;">Unsere Leistungen</h2>
                <p id="${newId}-p">Wir bieten eine Vielzahl von Services an, die dich begeistern werden.</p>
              </div>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem;">
                <div style="padding: 3rem 2rem; background: #f8fafc; border-radius: 20px; text-align: center;">
                  <span id="${newId}-s1-icon" style="font-size: 3rem; display: block; margin-bottom: 1.5rem;">🍦</span>
                  <h3 id="${newId}-s1-h3">Service 1</h3>
                  <p id="${newId}-s1-p" style="font-size: 0.95rem;">Beschreibung der ersten Leistung.</p>
                </div>
                <div style="padding: 3rem 2rem; background: #f8fafc; border-radius: 20px; text-align: center;">
                  <span id="${newId}-s2-icon" style="font-size: 3rem; display: block; margin-bottom: 1.5rem;">🎉</span>
                  <h3 id="${newId}-s2-h3">Service 2</h3>
                  <p id="${newId}-s2-p" style="font-size: 0.95rem;">Beschreibung der zweiten Leistung.</p>
                </div>
                <div style="padding: 3rem 2rem; background: #f8fafc; border-radius: 20px; text-align: center;">
                  <span id="${newId}-s3-icon" style="font-size: 3rem; display: block; margin-bottom: 1.5rem;">🚚</span>
                  <h3 id="${newId}-s3-h3">Service 3</h3>
                  <p id="${newId}-s3-p" style="font-size: 0.95rem;">Beschreibung der dritten Leistung.</p>
                </div>
              </div>
            </div>
          </section>
        `;
      } else if (type === 'gallery-grid') {
        html = `
          <section id="${newId}" style="padding: 8rem 0; background: #f1f5f9;">
            <div class="container">
              <div style="text-align: center; margin-bottom: 4rem;">
                <h2 id="${newId}-h2" style="font-size: 3rem;">Impressionen</h2>
                <p id="${newId}-p">Entdecke unsere Bilder-Welt.</p>
              </div>
                <div id="${newId}-grid" class="gallery-spinner" style="position: relative; width: 200px; height: 200px; transform-style: preserve-3d; animation: rotateSphere 80s linear infinite;">
                   <!-- Bilder werden über den Galerie-Manager hinzugefügt -->
                   <div class="gallery-item"><img src="https://images.unsplash.com/photo-1492684223066-81342ee5ff30" style="width:100%; height:100%; object-fit:cover;"></div>
                   <div class="gallery-item"><img src="https://images.unsplash.com/photo-1519751138087-5bf79df62d58" style="width:100%; height:100%; object-fit:cover;"></div>
                   <div class="gallery-item"><img src="https://images.unsplash.com/photo-1516450360452-9312f5e86fc7" style="width:100%; height:100%; object-fit:cover;"></div>
                   <div class="gallery-item"><img src="https://images.unsplash.com/photo-1517457373958-b7bdd4587205" style="width:100%; height:100%; object-fit:cover;"></div>
                   <div class="gallery-item"><img src="https://images.unsplash.com/photo-1542314831-068cd1dbfeeb" style="width:100%; height:100%; object-fit:cover;"></div>
                </div>
              </div>
              <style>
                @keyframes rotateSphere { 0% { transform: rotate3d(0, 1, 0, 0deg) rotate3d(1, 0, 0, 0deg); } 100% { transform: rotate3d(0, 1, 0, 360deg) rotate3d(1, 0, 0, 360deg); } }
                .gallery-spinner:hover { animation-play-state: paused !important; }
                .gallery-item {
                   position: absolute !important;
                   top: 50%; left: 50%;
                   width: 280px; height: 200px;
                   margin-left: -140px; margin-top: -100px;
                   backface-visibility: visible; 
                   transition: transform 1s;
                   opacity: 0.9;
                   border-radius: 12px; overflow: hidden;
                   box-shadow: 0 15px 35px rgba(0,0,0,0.6);
                   background: #fff;
                }
                .gallery-item:hover { opacity: 1; transform: scale(1.2) translateZ(50px) !important; z-index:100; box-shadow: 0 0 50px gold; }
              </style>
            </div>
          </section>
        `;
      } else if (type === 'text-image') {
        html = `
          <section id="${newId}" style="padding: 6rem 0; background: #ffffff;">
            <div class="container" style="display: grid; grid-template-columns: 1fr 1fr; gap: 4rem; align-items: center;">
              <div>
                <h2 id="${newId}-h2">Deine Überschrift</h2>
                <p id="${newId}-p">Dein Text hier...</p>
              </div>
              <img id="${newId}-img" src="Bild.jpg" style="width: 100%; border-radius: 20px;">
            </div>
          </section>
        `;
      } else if (type === 'grid-3') {
        html = `
          <section id="${newId}" style="padding: 6rem 0; background: #ffffff;">
            <div class="container">
              <h2 id="${newId}-h2" style="text-align: center; margin-bottom: 4rem;">Unsere Vorteile</h2>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2.5rem;">
                <div style="text-align: center;">
                  <h3 id="${newId}-c1-h3">Vorteil 1</h3>
                  <p id="${newId}-c1-p">Kurze Beschreibung...</p>
                </div>
                <div style="text-align: center;">
                  <h3 id="${newId}-c2-h3">Vorteil 2</h3>
                  <p id="${newId}-c2-p">Kurze Beschreibung...</p>
                </div>
                <div style="text-align: center;">
                  <h3 id="${newId}-c3-h3">Vorteil 3</h3>
                  <p id="${newId}-c3-p">Kurze Beschreibung...</p>
                </div>
              </div>
            </div>
          </section>
        `;
      } else if (type === 'grid-img-3') {
        html = `
          <section id="${newId}" style="padding: 6rem 0; background: #f8fafc;">
            <div class="container">
              <h2 id="${newId}-h2" style="text-align: center; margin-bottom: 4rem;">Unsere Galerie</h2>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
                <img id="${newId}-img1" src="img1.jpg" style="width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 12px;">
                <img id="${newId}-img2" src="img2.jpg" style="width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 12px;">
                <img id="${newId}-img3" src="img3.jpg" style="width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 12px;">
              </div>
            </div>
          </section>
        `;
      } else if (type === 'banner') {
        html = `
          <div id="${newId}" style="background: var(--primary); color: white; padding: 3rem; text-align: center;">
            <h2 id="${newId}-h2">Wichtige Info</h2>
            <p id="${newId}-p">Hier steht dein Banner-Text.</p>
          </div>
        `;
      } else if (type === 'black-week') {
        html = `
          <section id="${newId}" style="padding: 6rem 0; background: #000000; color: #ffffff; border-top: 5px solid var(--accent);">
            <div class="container" style="text-align: center;">
              <span id="${newId}-badge" style="background: var(--accent); color: black; padding: 4px 12px; border-radius: 100px; font-weight: bold;">BLACK WEEK SPECIAL</span>
              <h2 id="${newId}-h2" style="margin-top: 1rem;">10% GUTSCHEIN FÜR DEIN EVENT</h2>
              <p id="${newId}-p">Sichere dir jetzt deinen Rabatt für Buchungen im nächsten Jahr!</p>
              <button class="btn" onclick="openModal()" id="${newId}-btn" style="background: var(--accent); color: black;">Jetzt Code sichern</button>
            </div>
          </section>
        `;
      } else if (type === 'winter-break') {
        html = `
          <div id="${newId}" class="container" style="text-align: center; padding: 6rem 0; background: transparent;">
            <div style="background: white; padding: 4rem 2rem; border-radius: var(--radius-lg); box-shadow: var(--shadow-lg); border: 15px solid var(--secondary); position: relative;">
              <div id="${newId}-badge" style="position: absolute; top: -30px; left: 50%; transform: translateX(-50%); background: var(--primary); color: white; padding: 0.5rem 2rem; border-radius: 50px; font-weight: 800; letter-spacing: 2px;">STRANDPAUSE</div>
              <span id="${newId}-icon" style="font-size: 3rem; display: block; margin-bottom: 1rem;">🐚 ❄️</span>
              <h2 id="${newId}-h2">Wir tanken Sonne!</h2>
              <p id="${newId}-p">Aktuell befinden wir os in der Winterpause. Buchungsanfragen für 2026 werden jedoch bereits entgegengenommen!</p>
              <button class="btn" onclick="openModal()" id="${newId}-btn" style="margin-top: 2rem;">Vormerken für 2026</button>
            </div>
          </div>
        `;
      }

      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = html.trim();
      const newEl = tempDiv.firstChild;

      if (pos === 'start') {
        main.prepend(newEl);
      } else if (pos === 'end') {
        main.append(newEl);
      } else if (pos === 'after') {
        const afterEl = doc.getElementById(afterId);
        if (afterEl) afterEl.after(newEl);
        else main.append(newEl);
      }

      loadedHtmlContent = '<!DOCTYPE html>\n' + doc.documentElement.outerHTML;
      saveToHistory();
      renderSectionManager();
      updatePreview();
      showNotification("Sektion wurde hinzugefügt!");

      // Select the new section for immediate editing
      editDynamicSection(newId);
    }

    function removeSection(id) {
      if (!confirm(`Möchtest du die Sektion "${id}" wirklich löschen?`)) return;
      const parser = new DOMParser();
      const doc = parser.parseFromString(loadedHtmlContent, 'text/html');
      const el = doc.getElementById(id);
      if (el) el.remove();

      loadedHtmlContent = '<!DOCTYPE html>\n' + doc.documentElement.outerHTML;
      saveToHistory();
      renderSectionManager();
      updatePreview();
      showNotification("Sektion wurde gelöscht.");
    }

    // --- IMAGE PICKER LOGIC ---
    function triggerFilePicker(inputId, callback, accept = 'image/*') {
      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = accept;
      fileInput.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
          if (callback) {
            callback(file.name);
          } else {
            document.getElementById(inputId).value = file.name;
            document.getElementById(inputId).dispatchEvent(new Event('change'));
            document.getElementById(inputId).dispatchEvent(new Event('input'));
          }
        }
      };
      fileInput.click();
    }

    // --- GLOBAL DRAG & DROP FOR INPUTS ---
    function enableDragDrop(inputElement) {
      inputElement.ondragover = (e) => { e.preventDefault(); inputElement.style.background = '#eef'; inputElement.style.borderColor = 'var(--primary)'; };
      inputElement.ondragleave = (e) => { e.preventDefault(); inputElement.style.background = '#f9f9f9'; inputElement.style.borderColor = ''; };
      inputElement.ondrop = (e) => {
        e.preventDefault();
        inputElement.style.background = '#f9f9f9';
        inputElement.style.borderColor = '';
        const file = e.dataTransfer.files[0];
        if (file) {
          inputElement.value = file.name;
          inputElement.dispatchEvent(new Event('input'));
          inputElement.dispatchEvent(new Event('change'));
        }
      };
    }

    function handleGlobalInputDrop(e, input) {
      e.preventDefault();
      input.style.background = '#f9f9f9';
      input.style.borderColor = '';
      const file = e.dataTransfer.files[0];
      if (file) {
        input.value = file.name;
        input.dispatchEvent(new Event('change')); // Trigger update
      }
    }

    function getValueFromDoc(field) {
      if (!loadedHtmlContent) return "Datei noch nicht geladen...";
      const parser = new DOMParser();
      const doc = parser.parseFromString(loadedHtmlContent, 'text/html');

      // Global Theme Variables in style tag
      if (field.id && (field.id.startsWith('cms-color-') || field.id.startsWith('cms-font-') || field.id.startsWith('cms-size-'))) {
        const styleTag = doc.getElementById('cms-theme-style');
        if (styleTag) {
          let cssVar = "";
          if (field.id.startsWith('cms-color-')) {
            cssVar = field.id.replace('cms-color-', '--').replace('bg', 'bg-body').replace('text', 'text-main').replace('muted', 'text-muted');
          } else if (field.id.startsWith('cms-font-')) {
            cssVar = field.id.replace('cms-font-', '--font-');
          } else if (field.id.startsWith('cms-size-')) {
            cssVar = field.id.replace('cms-size-', '--size-');
          }
          const regex = new RegExp(`${cssVar}:\\s*([^;]+)`);
          const match = styleTag.innerHTML.match(regex);
          return match ? match[1].trim() : "";
        }
      }

      const el = doc.getElementById(field.id);
      if (!el) return "";

      if (field.special === 'hero-bg') {
        const style = el.getAttribute('style') || "";
        const match = style.match(/url\(['"]?([^'"]+)['"]?\)/);
        return match ? match[1] : "";
      }

      if (field.attr === 'style.background') {
        return rgbToHex(el.style.backgroundColor || el.style.background || "#ffffff");
      }

      if (field.attr) return el.getAttribute(field.attr);
      return (field.id === 'cms-intro-p1' || field.type === 'textarea') ? el.innerHTML.trim() : el.innerText.trim();
    }

    function rgbToHex(rgb) {
      if (!rgb || !rgb.startsWith('rgb')) return rgb;
      const rgbValues = rgb.match(/\d+/g);
      if (!rgbValues) return "#ffffff";
      const [r, g, b] = rgbValues;
      return "#" + ((1 << 24) + (+r << 16) + (+g << 8) + +b).toString(16).slice(1).toUpperCase();
    }


    function updateDocValue(field, value) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(loadedHtmlContent, 'text/html');

      if (field.id && (field.id.startsWith('cms-color-') || field.id.startsWith('cms-font-') || field.id.startsWith('cms-size-'))) {
        const styleTag = doc.getElementById('cms-theme-style');
        if (styleTag) {
          let cssVar = "";
          if (field.id.startsWith('cms-color-')) {
            cssVar = field.id.replace('cms-color-', '--').replace('bg', 'bg-body').replace('text', 'text-main').replace('muted', 'text-muted');
          } else if (field.id.startsWith('cms-font-')) {
            cssVar = field.id.replace('cms-font-', '--font-');
          } else if (field.id.startsWith('cms-size-')) {
            cssVar = field.id.replace('cms-size-', '--size-');
          }
          const regex = new RegExp(`${cssVar}:\\s*[^;]+`);
          styleTag.innerHTML = styleTag.innerHTML.replace(regex, `${cssVar}: ${value}`);
          loadedHtmlContent = '<!DOCTYPE html>\n' + doc.documentElement.outerHTML;
          updatePreview();
          return;
        }
      }

      const el = doc.getElementById(field.id);
      if (!el) return;

      if (field.special === 'hero-bg') {
        const currentStyle = el.getAttribute('style') || "";
        const newStyle = currentStyle.replace(/url\(['"]?([^'"]+)['"]?\)/, `url('${value}')`);
        el.setAttribute('style', newStyle);
      } else if (field.attr === 'style.background') {
        el.style.backgroundColor = value;
        el.style.background = value;
      } else if (field.attr) {
        el.setAttribute(field.attr, value);
      } else if (field.id === 'cms-intro-p1' || field.type === 'textarea') {
        el.innerHTML = value;
      } else {
        el.innerText = value;
      }

      loadedHtmlContent = '<!DOCTYPE html>\n' + doc.documentElement.outerHTML;
      saveToHistory();
      updatePreview();
    }

    // --- LIVE PREVIEW ---
    function updatePreview() {
      const iframe = document.getElementById('livePreview');
      const previewContainer = document.querySelector('.preview-area');
      if (previewContainer && loadedHtmlContent) previewContainer.classList.remove('hidden');
      if (!iframe || !loadedHtmlContent) return;

      const script = `
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
        <style>
          /* Professional Visual Editor Styles */
          .cms-editable-hover {
            outline: 2px solid #60a5fa !important;
            outline-offset: 2px;
            cursor: pointer !important;
            transition: outline 0.2s;
          }
          .cms-highlight-active {
            outline: 4px solid #3b82f6 !important;
            outline-offset: 4px;
            box-shadow: 0 0 50px rgba(59, 130, 246, 0.6);
            position: relative;
            z-index: 999999;
            transition: all 0.3s;
            animation: previewPulse 1.5s infinite;
          }
          @keyframes previewPulse {
            0% { transform: scale(1); box-shadow: 0 0 20px rgba(59, 130, 246, 0.4); }
            50% { transform: scale(1.02); box-shadow: 0 0 50px rgba(59, 130, 246, 0.8); }
            100% { transform: scale(1); box-shadow: 0 0 20px rgba(59, 130, 246, 0.4); }
          }
          /* Toolbar Glassmorphism Design */
          #cms-global-toolbar {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-10px);
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(12px);
            color: white;
            display: none;
            gap: 2px;
            padding: 6px;
            border-radius: 14px;
            font-family: 'Plus Jakarta Sans', sans-serif;
            z-index: 1000000;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(255,255,255,0.1);
            white-space: nowrap;
            align-items: center;
            opacity: 0;
            transition: opacity 0.2s, transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            pointer-events: auto;
          }

          #cms-global-toolbar.active {
            display: flex;
            opacity: 1;
            transform: translateX(-50%) translateY(0);
          }

          .cms-toolbar-group {
            display: flex;
            align-items: center;
            gap: 2px;
            padding: 0 8px;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
          }
          .cms-toolbar-group:last-child { border-right: none; }

          #cms-global-toolbar button, #cms-global-toolbar select {
            cursor: pointer;
            padding: 6px;
            border-radius: 8px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            color: #cbd5e1;
            border: none;
            min-width: 34px;
            height: 34px;
            font-size: 14px;
          }

          #cms-global-toolbar button:hover { 
            background: rgba(255, 255, 255, 0.1);
            color: #60a5fa;
            transform: translateY(-2px);
          }
          
          #cms-global-toolbar button.btn-danger:hover { color: #f87171; }
          #cms-global-toolbar button.btn-success:hover { color: #4ade80; }

          #cms-global-toolbar select {
            background: rgba(255,255,255,0.08);
            color: white;
            font-size: 11px;
            width: auto;
            max-width: 110px;
            padding: 0 6px;
            border: 1px solid rgba(255,255,255,0.1);
            margin: 0 4px;
          }

          .cms-color-palette {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #ffffff;
            border-radius: 12px;
            padding: 10px;
            display: none;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            z-index: 1000001;
            margin-top: 10px;
          }

          .color-swatch {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            cursor: pointer;
            border: 1px solid rgba(0,0,0,0.1);
            transition: transform 0.2s;
          }
          .color-swatch:hover { transform: scale(1.2); }

          [contenteditable]:focus {
            outline: none !important;
            background: rgba(96, 165, 250, 0.1);
            border-radius: 4px;
          }
        </style>

        <script>
          const BRAND_COLORS = ['#b8d062', '#a92d58', '#0f1d34', '#ffffff', '#000000', '#f5f7f9', '#485E75', '#FFD700', '#0066CC', '#FF5733'];
          const FONTS = ['Inter', 'Outfit', 'Plus Jakarta Sans', 'Playfair Display', 'Great Vibes', 'Alex Brush', 'serif', 'sans-serif'];

          let currentEditingElement = null;
          let toolbar = null;
          let isToolbarLocked = false;

          function createToolbar() {
            if (document.getElementById('cms-global-toolbar')) return;
            
            toolbar = document.createElement('div');
            toolbar.id = 'cms-global-toolbar';
            
            const g1 = document.createElement('div'); g1.className = 'cms-toolbar-group'; // Style
            const g2 = document.createElement('div'); g2.className = 'cms-toolbar-group'; // Align
            const g3 = document.createElement('div'); g3.className = 'cms-toolbar-group'; // Reorder
            const g4 = document.createElement('div'); g4.className = 'cms-toolbar-group'; // Elements/Quick-Add
            const g5 = document.createElement('div'); g5.className = 'cms-toolbar-group'; // Actions
            
            const addBtn = (group, icon, title, action, className = '') => {
              const btn = document.createElement('button');
              btn.innerHTML = '<i class="' + icon + '"></i>';
              btn.title = title;
              if (className) btn.className = className;
              btn.onclick = (e) => { e.stopPropagation(); action(); };
              group.appendChild(btn);
              return btn;
            };

            // Group 1: Text Styles
            const fontSel = document.createElement('select');
            FONTS.forEach(f => {
              const opt = document.createElement('option');
              opt.value = f; opt.innerText = f;
              fontSel.appendChild(opt);
            });
            fontSel.onchange = () => {
              if (currentEditingElement) {
                currentEditingElement.style.fontFamily = fontSel.value;
                window.parent.postMessage({type: 'cms-style-update', id: currentEditingElement.id, prop: 'fontFamily', value: fontSel.value}, '*');
              }
            };
            g1.appendChild(fontSel);

            addBtn(g1, 'fas fa-bold', 'Fett', () => {
              const val = (currentEditingElement.style.fontWeight === 'bold' || currentEditingElement.style.fontWeight === '700') ? 'normal' : 'bold';
              currentEditingElement.style.fontWeight = val;
              window.parent.postMessage({type: 'cms-style-update', id: currentEditingElement.id, prop: 'fontWeight', value: val}, '*');
            });
            
            addBtn(g1, 'fas fa-palette', 'Textfarbe', () => {
              const palette = toolbar.querySelector('.cms-color-palette');
              palette.style.display = palette.style.display === 'grid' ? 'none' : 'grid';
            });

            addBtn(g1, 'fas fa-text-height', 'Größe', () => {
              const s = prompt("Größe (z.B. 16px, 2rem):", currentEditingElement.style.fontSize);
              if (s) {
                currentEditingElement.style.fontSize = s;
                window.parent.postMessage({type: 'cms-style-update', id: currentEditingElement.id, prop: 'fontSize', value: s}, '*');
              }
            });

            // Group 2: Alignment
            addBtn(g2, 'fas fa-align-left', 'Links', () => { 
                currentEditingElement.style.textAlign = 'left'; 
                window.parent.postMessage({type: 'cms-style-update', id: currentEditingElement.id, prop: 'textAlign', value: 'left'}, '*');
            });
            addBtn(g2, 'fas fa-align-center', 'Mitte', () => { 
                currentEditingElement.style.textAlign = 'center'; 
                window.parent.postMessage({type: 'cms-style-update', id: currentEditingElement.id, prop: 'textAlign', value: 'center'}, '*');
            });
            addBtn(g2, 'fas fa-align-right', 'Rechts', () => { 
                currentEditingElement.style.textAlign = 'right'; 
                window.parent.postMessage({type: 'cms-style-update', id: currentEditingElement.id, prop: 'textAlign', value: 'right'}, '*');
            });

            // Group 3: Reorder
            addBtn(g3, 'fas fa-arrow-up', 'Nach oben', () => {
                const prev = currentEditingElement.previousElementSibling;
                if (prev) window.parent.postMessage({type: 'cms-reorder', draggedId: currentEditingElement.id, targetId: prev.id, position: 'before'}, '*');
            });
            addBtn(g3, 'fas fa-arrow-down', 'Nach unten', () => {
                const next = currentEditingElement.nextElementSibling;
                if (next) window.parent.postMessage({type: 'cms-reorder', draggedId: currentEditingElement.id, targetId: next.id, position: 'after'}, '*');
            });

            // Group 4: Quick Add & Media
            addBtn(g4, 'fas fa-plus-circle', 'Hier etwas einfügen', () => window.parent.postMessage({type: 'cms-add-request', id: currentEditingElement.id}, '*'), 'btn-success');
            addBtn(g4, 'fas fa-image', 'Bild tauschen', () => window.parent.postMessage({type: 'cms-image-pick', id: currentEditingElement.id}, '*')).id = 'toolbar-btn-img';
            addBtn(g4, 'fas fa-link', 'Link bearbeiten', () => {
              const href = prompt("URL:", currentEditingElement.getAttribute('href') || '#');
              if (href !== null) window.parent.postMessage({type: 'cms-attribute-update', id: currentEditingElement.id, attr: 'href', value: href}, '*');
            }).id = 'toolbar-btn-link';

            // Group 5: Actions
            addBtn(g5, 'fas fa-undo', 'Rückgängig', () => window.parent.postMessage({type: 'cms-undo'}, '*'));
            addBtn(g5, 'fas fa-redo', 'Wiederholen', () => window.parent.postMessage({type: 'cms-redo'}, '*'));
            addBtn(g5, 'fas fa-copy', 'Duplizieren', () => window.parent.postMessage({type: 'cms-duplicate', id: currentEditingElement.id}, '*'));
            addBtn(g5, 'fas fa-trash', 'Löschen', () => window.parent.postMessage({type: 'cms-delete', id: currentEditingElement.id}, '*'), 'btn-danger');
            addBtn(g5, 'fas fa-save', 'Projekt Speichern', () => window.parent.postMessage({type: 'cms-save-request'}, '*'), 'btn-success');

            // Color Palette
            const palette = document.createElement('div');
            palette.className = 'cms-color-palette';
            BRAND_COLORS.forEach(c => {
              const swatch = document.createElement('div');
              swatch.className = 'color-swatch';
              swatch.style.backgroundColor = c;
              swatch.onclick = (e) => {
                e.stopPropagation();
                if (currentEditingElement) {
                    currentEditingElement.style.color = c;
                    window.parent.postMessage({type: 'cms-style-update', id: currentEditingElement.id, prop: 'color', value: c}, '*');
                }
                palette.style.display = 'none';
              };
              palette.appendChild(swatch);
            });

            // RGB Picker Container
            const pickerContainer = document.createElement('div');
            pickerContainer.style.gridColumn = 'span 5';
            pickerContainer.style.borderTop = '1px solid #eee';
            pickerContainer.style.paddingTop = '8px';
            pickerContainer.style.marginTop = '4px';
            pickerContainer.style.display = 'flex';
            pickerContainer.style.alignItems = 'center';
            pickerContainer.style.gap = '10px';
            
            const pickerInput = document.createElement('input');
            pickerInput.type = 'color';
            pickerInput.style.width = '30px';
            pickerInput.style.height = '30px';
            pickerInput.style.border = 'none';
            pickerInput.style.padding = '0';
            pickerInput.style.background = 'none';
            pickerInput.style.cursor = 'pointer';
            
            const pickerText = document.createElement('span');
            pickerText.innerText = 'RGB Palette';
            pickerText.style.fontSize = '12px';
            pickerText.style.color = '#333';
            pickerText.style.fontWeight = '600';

            pickerInput.oninput = (e) => {
              const c = e.target.value;
              if (currentEditingElement) {
                currentEditingElement.style.color = c;
                window.parent.postMessage({type: 'cms-style-update', id: currentEditingElement.id, prop: 'color', value: c}, '*');
              }
            };
            pickerInput.onclick = (e) => e.stopPropagation();

            pickerContainer.append(pickerInput, pickerText);
            palette.appendChild(pickerContainer);
            
            toolbar.append(g1, g2, g3, g4, g5, palette);
            document.body.appendChild(toolbar);
            document.addEventListener('click', () => { palette.style.display = 'none'; });
          }

          function positionToolbar(el) {
            if (!toolbar) return;
            currentEditingElement = el;
            const rect = el.getBoundingClientRect();
            
            const isImg = el.tagName === 'IMG';
            const isLink = el.tagName === 'A' || el.classList.contains('btn');
            const isContainer = el.tagName === 'DIV' || el.tagName === 'SECTION';

            toolbar.querySelector('.cms-toolbar-group:nth-child(1)').style.display = !isImg ? 'flex' : 'none';
            toolbar.querySelector('.cms-toolbar-group:nth-child(2)').style.display = (!isImg && el.tagName !== 'SPAN') ? 'flex' : 'none';
            document.getElementById('toolbar-btn-img').style.display = isImg ? 'flex' : 'none';
            document.getElementById('toolbar-btn-link').style.display = isLink ? 'flex' : 'none';

            toolbar.classList.add('active');
            
            let top = rect.top - 60;
            if (top < 10) top = rect.bottom + 10;
            
            toolbar.style.top = top + 'px';
            toolbar.style.left = Math.max(200, Math.min(window.innerWidth - 200, rect.left + rect.width / 2)) + 'px';
          }

          function initCMS() {
            createToolbar();
            document.querySelectorAll('body *[id]').forEach(el => {
              if (['SCRIPT', 'STYLE', 'LINK', 'META', 'HEAD', 'HTML', 'BODY'].includes(el.tagName)) return;
              
              if (window.getComputedStyle(el).position === 'static') el.style.position = 'relative';

              const isText = ['H1','H2','H3','H4','H5','H6','P','SPAN','A','LI','DIV'].includes(el.tagName);
              if (isText && (el.children.length === 0 || el.id.includes('cms-logo-text'))) el.contentEditable = 'true';

              el.onmouseenter = (e) => {
                e.stopPropagation();
                if (currentEditingElement !== el) el.classList.add('cms-editable-hover');
                if (!isToolbarLocked) positionToolbar(el);
              };
              el.onmouseleave = () => el.classList.remove('cms-editable-hover');
              
              el.onclick = (e) => {
                e.stopPropagation();
                isToolbarLocked = true;
                currentEditingElement = el;
                document.querySelectorAll('.cms-editable-hover').forEach(x => x.classList.remove('cms-editable-hover'));
                el.classList.add('cms-editable-hover');
                window.parent.postMessage({ type: 'cms-element-clicked', id: el.id }, '*');
                positionToolbar(el);
              };

              if (el.contentEditable === 'true') {
                el.oninput = () => window.parent.postMessage({ type: 'cms-text-update', id: el.id, value: el.innerHTML.trim() }, '*');
                el.onfocus = () => { isToolbarLocked = true; positionToolbar(el); };
              }
            });

            document.body.addEventListener('click', (e) => {
              if (!e.target.closest('*[id]') && !e.target.closest('#cms-global-toolbar')) {
                isToolbarLocked = false;
                if (toolbar) toolbar.classList.remove('active');
                document.querySelectorAll('.cms-editable-hover').forEach(x => x.classList.remove('cms-editable-hover'));
              }
            });
          }

          window.addEventListener('scroll', () => {
            if (currentEditingElement && toolbar && toolbar.classList.contains('active')) positionToolbar(currentEditingElement);
          }, { passive: true });

          window.addEventListener('message', (e) => {
            if (e.data.type === 'highlight-element' || e.data.type === 'highlight-section') {
              const el = document.getElementById(e.data.id);
              if (el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                el.classList.add('cms-highlight-active');
                positionToolbar(el);
                isToolbarLocked = true;
                setTimeout(() => el.classList.remove('cms-highlight-active'), 3000);
              }
            }
          });

          document.addEventListener('DOMContentLoaded', initCMS);
          setTimeout(initCMS, 1000); 
        <\/script>
      `;

      let content = loadedHtmlContent;
      if (content.includes('</body>')) {
        content = content.replace('</body>', script + '</body>');
      } else {
        content += script;
      }
      iframe.srcdoc = content;
    }

    // Listen for messages from the preview iframe
    window.addEventListener('message', (event) => {
      if (event.data.type === 'cms-element-clicked') {
        handleVisualClick(event.data.id);
      } else if (event.data.type === 'cms-text-update') {
        handleVisualTextUpdate(event.data.id, event.data.value);
      } else if (event.data.type === 'cms-padding-update') {
        handleVisualPaddingUpdate(event.data.id, event.data.padding);
      } else if (event.data.type === 'cms-delete') {
        handleVisualDelete(event.data.id);
      } else if (event.data.type === 'cms-duplicate') {
        handleVisualDuplicate(event.data.id);
      } else if (event.data.type === 'cms-image-pick') {
        triggerFilePicker(null, (fileName) => handleVisualImageUpdate(event.data.id, fileName));
      } else if (event.data.type === 'cms-style-update') {
        handleVisualStyleUpdate(event.data.id, event.data.prop, event.data.value);
      } else if (event.data.type === 'cms-layout-update') {
        handleVisualLayoutUpdate(event.data.id, event.data.mode);
      } else if (event.data.type === 'cms-reorder') {
        handleVisualReorder(event.data.draggedId, event.data.targetId);
      } else if (event.data.type === 'cms-attribute-update') {
        handleVisualAttributeUpdate(event.data.id, event.data.attr, event.data.value);
      } else if (event.data.type === 'cms-add-request') {
        handleVisualAddRequest(event.data.id);
      } else if (event.data.type === 'cms-save-request') {
        saveDirectly();
      } else if (event.data.type === 'cms-undo') {
        undo();
      } else if (event.data.type === 'cms-redo') {
        redo();
      }
    });

    function handleVisualAddRequest(id) {
      // Simple Quick-Add Menu using prompt or a small custom dialog
      const choice = prompt("Was möchtest du hier hinzufügen?\n1: Bild\n2: Button\n3: Textblock\n4: Spalten-Gitter (Grid)",
        "1");

      if (choice === "1") addImageToSection(id);
      else if (choice === "2") addButtonToSection(id);
      else if (choice === "3") addTextToSection(id);
      else if (choice === "4") addGridToSection(id);
    }

    function handleVisualAttributeUpdate(id, attr, value) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(loadedHtmlContent, 'text/html');
      const el = doc.getElementById(id);
      if (el) {
        el.setAttribute(attr, value);
        loadedHtmlContent = '<!DOCTYPE html>\n' + doc.documentElement.outerHTML;
        saveToHistory();
        updatePreview();
      }
    }

    function handleVisualReorder(draggedId, targetId, position) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(loadedHtmlContent, 'text/html');
      const dragged = doc.getElementById(draggedId);
      const target = doc.getElementById(targetId);
      if (dragged && target) {
        if (position === 'after') target.after(dragged);
        else target.before(dragged);

        loadedHtmlContent = '<!DOCTYPE html>\n' + doc.documentElement.outerHTML;
        saveToHistory();
        updatePreview();
      }
    }

    function setSectionBg(sectionId, url) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(loadedHtmlContent, 'text/html');
      const sec = doc.getElementById(sectionId);
      if (sec) {
        if (url) {
          sec.style.backgroundImage = `url('${url}')`;
          sec.style.backgroundSize = 'cover';
          sec.style.backgroundPosition = 'center';
        } else {
          sec.style.backgroundImage = '';
        }
        loadedHtmlContent = '<!DOCTYPE html>\n' + doc.documentElement.outerHTML;
        updatePreview();
        saveToHistory();

        // update input field
        const input = document.getElementById('sec-bg-' + sectionId);
        if (input) input.value = url;
      }
    }

    function setSectionVideo(sectionId, url) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(loadedHtmlContent, 'text/html');
      const sec = doc.getElementById(sectionId);
      if (sec) {
        if (url) {
          sec.setAttribute('data-video', url);
        } else {
          sec.removeAttribute('data-video');
        }
        loadedHtmlContent = '<!DOCTYPE html>\n' + doc.documentElement.outerHTML;
        updatePreview();
        saveToHistory();

        // update input field
        const input = document.getElementById('sec-video-' + sectionId);
        if (input) input.value = url;
      }
    }

    function handleVisualImageUpdate(id, src) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(loadedHtmlContent, 'text/html');
      const el = doc.getElementById(id);
      if (el) {
        if (el.tagName === 'IMG') el.src = src;
        else if (el.style.backgroundImage) el.style.backgroundImage = `url('${src}')`;
        else el.setAttribute('src', src);
        loadedHtmlContent = '<!DOCTYPE html>\n' + doc.documentElement.outerHTML;
        saveToHistory();
        updatePreview();
      }
    }

    function handleVisualStyleUpdate(id, prop, value) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(loadedHtmlContent, 'text/html');
      const el = doc.getElementById(id);
      if (el) {
        el.style[prop] = value;
        // Clean up auto height for IMG if resizing width
        if (el.tagName === 'IMG' && prop === 'width') el.style.height = 'auto';

        loadedHtmlContent = '<!DOCTYPE html>\n' + doc.documentElement.outerHTML;
        saveToHistory();
      }
    }

    function handleVisualLayoutUpdate(id, mode) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(loadedHtmlContent, 'text/html');
      const el = doc.getElementById(id);
      if (el) {
        if (mode === 'block') {
          // "Direkt unten drunter mittig" -> Block + Auto Margins
          el.style.display = 'block';
          el.style.marginLeft = 'auto';
          el.style.marginRight = 'auto';
        } else {
          // "Nebeneinander" -> Inline-Block
          el.style.display = 'inline-block';
          el.style.marginLeft = '0.5rem';
          el.style.marginRight = '0.5rem';
          el.style.verticalAlign = 'top';
        }
        loadedHtmlContent = '<!DOCTYPE html>\n' + doc.documentElement.outerHTML;
        saveToHistory();
      }
    }

    function handleVisualDelete(id) {
      if (!confirm("Element wirklich löschen?")) return;
      const parser = new DOMParser();
      const doc = parser.parseFromString(loadedHtmlContent, 'text/html');
      const el = doc.getElementById(id);
      if (el) {
        el.remove();
        loadedHtmlContent = '<!DOCTYPE html>\n' + doc.documentElement.outerHTML;
        saveToHistory();
        updatePreview();
      }
    }

    function handleVisualDuplicate(id) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(loadedHtmlContent, 'text/html');
      const el = doc.getElementById(id);
      if (el) {
        const clone = el.cloneNode(true);
        // Clean up clone IDs to avoid duplicates if necessary, or just let it be for now
        // A better way is to assign a new unique ID
        const newId = id + '-copy-' + Math.floor(Math.random() * 1000);
        clone.id = newId;
        clone.querySelectorAll('[id]').forEach(child => child.id += '-copy-' + Math.floor(Math.random() * 1000));
        el.after(clone);
        loadedHtmlContent = '<!DOCTYPE html>\n' + doc.documentElement.outerHTML;
        saveToHistory();
        updatePreview();
      }
    }

    function handleVisualPaddingUpdate(id, padding) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(loadedHtmlContent, 'text/html');
      const el = doc.getElementById(id);
      if (el) {
        el.style.paddingBottom = padding;
        loadedHtmlContent = '<!DOCTYPE html>\n' + doc.documentElement.outerHTML;
        saveToHistory();
      }
    }

    function handleVisualTextUpdate(id, value) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(loadedHtmlContent, 'text/html');
      const el = doc.getElementById(id);
      if (el) {
        // Sanitize value: remove any accidental toolbar HTML if it leaked through
        let cleanValue = value;
        if (typeof value === 'string' && value.includes('cms-toolbar')) {
          const temp = document.createElement('div');
          temp.innerHTML = value;
          const toolbars = temp.querySelectorAll('.cms-toolbar, .cms-size-handle');
          toolbars.forEach(t => t.remove());
          cleanValue = temp.innerHTML.trim();
        }

        if (id.includes('-p') || id.includes('-span') || id.includes('-li') || el.tagName === 'P') {
          el.innerHTML = cleanValue;
        } else {
          // For headings/buttons, we usually want text only
          const temp = document.createElement('div');
          temp.innerHTML = cleanValue;
          el.innerText = temp.innerText.trim();
        }

        loadedHtmlContent = '<!DOCTYPE html>\n' + doc.documentElement.outerHTML;

        // Update input in sidebar if visible
        const input = document.getElementById('field-' + id) || document.getElementById('dyn-' + id);
        if (input) input.value = el.innerText || el.innerHTML;

        saveToHistory();
      }
    }

    function handleVisualClick(elementId) {
      // Find which tab/section this ID belongs to
      let targetTab = null;
      let isDynamic = false;
      let parentSectionId = null;

      // Check standard sections
      for (const [tab, fields] of Object.entries(SECTIONS)) {
        if (fields.some(f => f.id === elementId)) {
          targetTab = tab;
          break;
        }
      }

      // Check for dynamic sections
      if (!targetTab && (elementId.startsWith('cms-sec-') || elementId.includes('-h2') || elementId.includes('-p') ||
        elementId.includes('-img') || elementId.includes('-span') || elementId.includes('-li') || elementId.includes('-h3') ||
        elementId.includes('-h4'))) {
        targetTab = 'sections';
        isDynamic = true;
        // Identify the parent section ID (e.g., cms-sec-123)
        if (elementId.startsWith('cms-sec-')) {
          parentSectionId = elementId.split('-').slice(0, 3).join('-');
        }
      }

      if (targetTab) {
        // If we are already editing THIS dynamic section, don't reset the view, just focus the field
        if (isDynamic && currentlyEditingSection === parentSectionId && currentTab === 'sections') {
          // Do nothing, just highlight
          const input = document.getElementById('field-' + elementId) || document.getElementById('dyn-' + elementId);
          if (input) focusAndHighlight(input);
          return;
        }

        // Optimization: If going to dynamic section, handle tab switch manually to avoid "List -> Editor" flash
        if (isDynamic && targetTab === 'sections') {
          // Manually show the tab elements without rendering the full list
          currentTab = 'sections';
          document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
          const navItem = Array.from(document.querySelectorAll('.nav-item')).find(el => el.getAttribute('onclick')?.includes('sections'));
          if (navItem) navItem.classList.add('active');

          document.getElementById('tab-bookings').classList.add('hidden');
          document.getElementById('tab-cms').classList.remove('hidden');

          // Directly open editor
          const sectionId = parentSectionId || elementId.split('-').slice(0, 3).join('-');
          editDynamicSection(sectionId);

          setTimeout(() => {
            const dynInput = document.getElementById('dyn-' + elementId);
            if (dynInput) focusAndHighlight(dynInput);
          }, 100);
          return;
        }

        switchTab(targetTab);

        // Wait a bit for the DOM to render the fields
        setTimeout(() => {
          let input = document.getElementById('field-' + elementId) || document.getElementById('dyn-' + elementId);
          if (!input && isDynamic) {
            // If it's a dynamic section, we need to open the editor first
            const sectionId = parentSectionId || elementId.split('-').slice(0, 3).join('-');
            editDynamicSection(sectionId);
            setTimeout(() => {
              const dynInput = document.getElementById('dyn-' + elementId);
              if (dynInput) focusAndHighlight(dynInput);
            }, 100);
          } else if (input) {
            focusAndHighlight(input);
          }
        }, isDynamic ? 150 : 50);
      }
    }

    function focusAndHighlight(el) {
      if (!el) return;

      // Scroll the element into the center of the viewport smoothly
      el.scrollIntoView({ behavior: 'smooth', block: 'center' });

      // Focus the input to allow immediate editing
      el.focus();

      // Apply the premium highlight animation class
      el.classList.add('field-highlight');

      // Remove the highlight effect after a short delay
      setTimeout(() => {
        el.classList.remove('field-highlight');
      }, 3000);
    }

    function highlightInPreview(elementId) {
      const iframe = document.getElementById('livePreview');
      if (iframe && iframe.contentWindow) {
        iframe.contentWindow.postMessage({ type: 'highlight-element', id: elementId }, '*');
      }
    }

    function setPreviewSize(mode) {
      const area = document.querySelector('.preview-area');
      if (mode === 'mobile') area.classList.add('preview-mobile');
      else area.classList.remove('preview-mobile');
    }

    function toggleSidebar() {
      document.body.classList.toggle('sidebar-collapsed');
    }

    function toggleZenMode() {
      const isZen = document.body.classList.toggle('zen-mode');
      const btn = document.getElementById('zenToggleBtn');
      const saveBtn = document.getElementById('floatUpdateBtn');

      if (isZen) {
        if (btn) btn.innerHTML = '<i class="fas fa-compress-arrows-alt"></i> Dashboard';
        if (saveBtn) saveBtn.style.display = 'block';
        showNotification("Vollbild-Editor aktiv. Bearbeite Texte & Bilder direkt in der Vorschau!", "success");
      } else {
        if (btn) btn.innerHTML = '<i class="fas fa-expand-arrows-alt"></i> Vollbild Bearbeiten';
        if (saveBtn) saveBtn.style.display = 'none';
      }

      // Update the float button position if needed
      const updateBtn = document.querySelector('.update-badge');
      if (updateBtn) {
        updateBtn.style.left = isZen ? '20px' : '300px';
      }
    }

    function changePreviewSize(state) {
      document.body.classList.remove('preview-collapsed', 'preview-narrow');
      const area = document.querySelector('.preview-area');

      // Reset inline styles to ensure classes work
      area.style.width = '';

      if (state === 'none') {
        document.body.classList.add('preview-collapsed');
      } else if (state === 'narrow') {
        document.body.classList.add('preview-narrow');
        area.style.width = '450px';
      } else if (state === 'wide') {
        // Standard: 50/50 split for seeing everything
        area.style.width = '50%';
      }
    }

    // --- GALLERY MANAGER ---
    function renderGalleryItems() {
      const body = document.querySelector('#galleryTable tbody');
      body.innerHTML = '';
      if (!loadedHtmlContent) return;

      const parser = new DOMParser();
      const doc = parser.parseFromString(loadedHtmlContent, 'text/html');
      const grid = doc.getElementById('cms-gallery-grid');
      if (!grid) return;

      // Update Mode Select
      const container = grid.parentElement; // .gallery-perspective
      let currentMode = '3d';
      if (container.classList.contains('gallery-mode-grid')) currentMode = 'grid';
      else if (container.classList.contains('gallery-mode-slider')) currentMode = 'slider';

      const modeSelect = document.getElementById('galleryModeSelect');
      if (modeSelect) modeSelect.value = currentMode;

      // Update Music Path
      const music = doc.getElementById('gallery-music');
      if (music) {
        const source = music.querySelector('source');
        const path = source ? source.getAttribute('src') : music.getAttribute('src');
        const musicInput = document.getElementById('galleryMusicPath');
        if (musicInput) musicInput.value = path || '';
      }

      const items = grid.querySelectorAll('.gallery-item');
      items.forEach((item, index) => {
        const mediaEl = item.querySelector('img, video');
        const media = mediaEl ? mediaEl.getAttribute('src') : '';
        const isVideo = media.match(/\.(mp4|webm|ogg)$/i);

        const titleEl = item.querySelector('h4');
        const title = titleEl ? titleEl.innerText : '';

        const subEl = item.querySelector('p');
        const sub = subEl ? subEl.innerText : '';

        const tr = document.createElement('tr');
        tr.className = 'draggable-row';
        tr.setAttribute('draggable', 'true');
        tr.setAttribute('data-index', index);
        tr.setAttribute('data-type', 'gallery');

        tr.addEventListener('dragstart', handleGalleryDragStart);
        tr.addEventListener('dragover', handleGalleryDragOver);
        tr.addEventListener('drop', handleGalleryDrop);
        tr.addEventListener('dragend', handleDragEnd);

        tr.innerHTML = `
          <td>
            <div style="display:flex; align-items:center; gap:1rem;">
              <span class="drag-handle"><i class="fas fa-grip-vertical"></i></span>
              ${isVideo ?
            `<div class="gallery-preview" style="display:flex; align-items:center; justify-content:center; background:#000; color:#fff;"><i class="fas fa-video"></i></div>` :
            `<img src="${media}" class="gallery-preview">`
          }
            </div>
          </td>
          <td>
            <div style="display: flex; gap: 0.5rem;">
              <input type="text" id="gallery-src-${index}" value="${media}"
                onchange="updateGalleryItem(${index}, 'src', this.value)" readonly
                onclick="triggerFilePicker('gallery-src-${index}', null, 'video/*,image/*')" placeholder="Datei wählen..." style="cursor:pointer">
              <button onclick="triggerFilePicker('gallery-src-${index}', null, 'video/*,image/*')" class="btn btn-ghost"
                style="padding: 0.3rem; font-size: 0.8rem;">📁</button>
            </div>
          </td>
          <td><input type="text" value="${title}" placeholder="Titel (optional)" onchange="updateGalleryItem(${index}, 'title', this.value)"></td>
          <td><input type="text" value="${sub}" placeholder="Beschreibung (optional)" onchange="updateGalleryItem(${index}, 'sub', this.value)"></td>
          <td><button class="btn btn-ghost" style="color:var(--accent-danger)" onclick="removeGalleryItem(${index})"><i class="fas fa-trash"></i></button></td>
        `;
        body.appendChild(tr);
      });
    }

    let galleryDragSrcIndex = null;

    function handleGalleryDragStart(e) {
      galleryDragSrcIndex = this.getAttribute('data-index');
      e.dataTransfer.effectAllowed = 'move';
      this.classList.add('dragging');
    }

    function handleGalleryDragOver(e) {
      if (e.preventDefault) e.preventDefault();
      this.classList.add('over');
      return false;
    }

    function handleGalleryDrop(e) {
      if (e.stopPropagation) e.stopPropagation();
      this.classList.remove('over');

      const targetIndex = this.getAttribute('data-index');
      if (galleryDragSrcIndex !== targetIndex) {
        reorderGalleryItems(parseInt(galleryDragSrcIndex), parseInt(targetIndex));
      }
      return false;
    }

    function reorderGalleryItems(srcIdx, targetIdx) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(loadedHtmlContent, 'text/html');
      const grid = doc.getElementById('cms-gallery-grid');
      const items = Array.from(grid.querySelectorAll('.gallery-item'));

      const itemToMove = items[srcIdx];
      items.splice(srcIdx, 1);
      items.splice(targetIdx, 0, itemToMove);

      grid.innerHTML = '';
      items.forEach(item => grid.appendChild(item));

      loadedHtmlContent = '<!DOCTYPE html>\n' + doc.documentElement.outerHTML;
      renderGalleryItems();
      updatePreview();
      saveToHistory();
    }

    function updateGalleryItem(index, type, value) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(loadedHtmlContent, 'text/html');
      const grid = doc.getElementById('cms-gallery-grid');
      const items = grid.querySelectorAll('.gallery-item');
      const item = items[index];

      if (!item) return;

      if (type === 'src') {
        const img = item.querySelector('img');
        const vid = item.querySelector('video');
        const isVideo = value.match(/\.(mp4|webm|ogg)$/i);

        if (isVideo) {
          if (img) {
            const newVid = doc.createElement('video');
            newVid.src = value;
            newVid.muted = true; newVid.loop = true;
            newVid.style.cssText = img.style.cssText || "width:100%; height:100%; object-fit:cover;";
            img.replaceWith(newVid);
          } else if (vid) {
            vid.src = value;
          }
        } else {
          if (vid) {
            const newImg = doc.createElement('img');
            newImg.src = value;
            newImg.style.cssText = vid.style.cssText || "width:100%; height:100%; object-fit:cover;";
            vid.replaceWith(newImg);
          } else if (img) {
            img.src = value;
          }
        }
      }

      if (type === 'title' || type === 'sub') {
        let overlay = item.querySelector('.gallery-overlay');
        if (!overlay && value) {
          overlay = doc.createElement('div');
          overlay.className = 'gallery-overlay';
          item.appendChild(overlay);
        }

        if (overlay) {
          if (type === 'title') {
            let h4 = overlay.querySelector('h4');
            if (!h4) { h4 = doc.createElement('h4'); overlay.prepend(h4); }
            h4.innerText = value;
          }
          if (type === 'sub') {
            let p = overlay.querySelector('p');
            if (!p) { p = doc.createElement('p'); overlay.appendChild(p); }
            p.innerText = value;
          }
        }
      }

      loadedHtmlContent = '<!DOCTYPE html>\n' + doc.documentElement.outerHTML;

      renderGalleryItems();
      updatePreview();
    }

    function addGalleryItem() {
      triggerFilePicker(null, (fileName) => {
        const parser = new DOMParser();
        const doc = parser.parseFromString(loadedHtmlContent, 'text/html');
        const grid = doc.getElementById('cms-gallery-grid');
        if (!grid) return;

        const isVideo = fileName.match(/\.(mp4|webm|ogg)$/i);
        const div = doc.createElement('div');
        div.className = 'gallery-item';
        div.setAttribute('onclick', 'openLightbox(this)');

        if (isVideo) {
          div.innerHTML = `
<video src="${fileName}" muted loop style="width:100%; height:100%; object-fit:cover;"></video>
<div class="gallery-overlay">
  <h4>Neues Video</h4>
  <p>Beschreibung hier</p>
</div>
`;
        } else {
          div.innerHTML = `
<img src="${fileName}" alt="EisFavorite Event">
<div class="gallery-overlay">
  <h4>Neues Bild</h4>
  <p>Beschreibung hier</p>
</div>
`;
        }

        grid.appendChild(div);
        loadedHtmlContent = '<!DOCTYPE html>\n' + doc.documentElement.outerHTML;
        renderGalleryItems();
        updatePreview();
        saveToHistory();
      }, 'video/*,image/*');
    }

    function removeGalleryItem(index) {
      if (!confirm('Bild aus der Galerie entfernen?')) return;
      const parser = new DOMParser();
      const doc = parser.parseFromString(loadedHtmlContent, 'text/html');
      const grid = doc.getElementById('cms-gallery-grid');
      const items = grid.querySelectorAll('.gallery-item');
      items[index].remove();

      loadedHtmlContent = '<!DOCTYPE html>\n' + doc.documentElement.outerHTML;
      renderGalleryItems();
      updatePreview();
      saveToHistory();
    }

    // --- CODE GENERATION / SAVE ---
    document.getElementById('saveAllBtn').addEventListener('click', () => {
      if (window.showSaveFilePicker) {
        saveDirectly();
      } else {
        if (!loadedHtmlContent) {
          showNotification("Bitte zuerst index.html einlesen!", "error");
          return;
        }
        document.getElementById('finalCodeArea').value = loadedHtmlContent;
        document.getElementById('exportArea').classList.remove('hidden');
        document.getElementById('exportArea').scrollIntoView({ behavior: 'smooth' });
      }
    });

    document.getElementById('copyCodeBtn').addEventListener('click', () => {
      const area = document.getElementById('finalCodeArea');
      area.select();
      document.execCommand('copy');
      alert('Code kopiert! Ersetze den Inhalt deiner index.html und speichere die Datei.');
    });

    // --- DATA LOADING ---
    async function tryAutoLoad() {
      try {
        const response = await fetch('index.html');
        if (response.ok) {
          loadedHtmlContent = await response.text();
          saveToHistory(); // Initialize history
          document.getElementById('fileLoadWarning').classList.add('hidden');
          if (currentTab !== 'bookings') renderCMSFields(currentTab);
          updatePreview();
        }
      } catch (e) {
        console.warn("Auto-load blocked by CORS");
      }
    }

    async function openFile() {
      try {
        if (!window.showOpenFilePicker) {
          document.getElementById('manualTextareaOption').style.display = 'block';
          showNotification("Dein Browser unterstützt das direkte Öffnen nicht. Bitte nutze die manuelle Eingabe.", "error");
          return;
        }
        const [handle] = await window.showOpenFilePicker({
          types: [{ description: 'HTML Datei', accept: { 'text/html': ['.html'] } }],
        });
        fileHandle = handle;
        const file = await fileHandle.getFile();
        loadedHtmlContent = await file.text();

        ensureGlobalCmsIds(); // Add IDs to everything immediately
        saveToHistory();
        document.getElementById('fileLoadWarning').classList.add('hidden');
        if (currentTab !== 'bookings') renderCMSFields(currentTab);
        updatePreview();
      } catch (err) {
        if (err.name !== 'AbortError') console.error(err);
      }
    }

    document.getElementById('filePickerBtn').addEventListener('click', openFile);

    document.getElementById('manualLoadBtn').addEventListener('click', () => {
      const code = document.getElementById('manualHtmlInput').value;
      if (code.trim()) {
        loadedHtmlContent = code;
        ensureGlobalCmsIds(); // Add IDs to everything immediately
        saveToHistory();
        document.getElementById('fileLoadWarning').classList.add('hidden');
        if (currentTab !== 'bookings') renderCMSFields(currentTab);
        updatePreview();
        showNotification("index.html erfolgreich eingelesen!");
      }
    });

    // Handle showOpenFilePicker support UI
    if (!window.showOpenFilePicker) {
      document.getElementById('manualTextareaOption').style.display = 'block';
    }

    // --- LOGIN ---
    document.getElementById('loginForm').addEventListener('submit', (e) => {
      e.preventDefault();
      if (document.getElementById('adminPassword').value === ADMIN_PASSWORD) {
        document.getElementById('loginCard').classList.add('hidden');
        document.getElementById('dashboard').classList.remove('hidden');
        sessionStorage.setItem('adminAuth', 'true');

        // Try to enter fullscreen
        if (document.documentElement.requestFullscreen) {
          document.documentElement.requestFullscreen().catch(e => console.log("Fullscreen blocked or not supported"));
        }

        tryAutoLoad();
        switchTab('bookings');
        updatePreview();
      } else {
        document.getElementById('loginError').textContent = "Falsches Passwort";
      }
    });

    document.getElementById('logoutBtn').addEventListener('click', () => {
      sessionStorage.removeItem('adminAuth');
      location.reload();
    });

    // --- BOOKINGS LOGIC (Simple version for space) ---
    function getBookings() {
      return JSON.parse(localStorage.getItem(ACTIVE_KEY) || '[]');
    }

    function renderCalendar() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      const monthName = currentDate.toLocaleDateString('de-DE', { month: 'long', year: 'numeric' });

      const bookings = getBookings();

      // Days in current month
      const daysInMonth = new Date(year, month + 1, 0).getDate();

      // Days in previous month
      const daysInPrevMonth = new Date(year, month, 0).getDate();

      const firstWeekday = new Date(year, month, 1).getDay();
      // Adjust standard JS day (0=Sun) to German (0=Mon... actually 1=Mon, 0=Sun in standard, but we want Mon start)
      // JS: Sun=0, Mon=1, Tue=2...
      // Target: Mon=0, Tue=1 ... Sun=6
      const startOffset = firstWeekday === 0 ? 6 : firstWeekday - 1;

      let html = `
       <div class="calendar-container">
         <div class="calendar-header">
           <button class="calendar-nav-btn" onclick="changeMonth(-1)"><i class="fas fa-chevron-left"></i></button>
           <h3>${monthName}</h3>
           <button class="calendar-nav-btn" onclick="changeMonth(1)"><i class="fas fa-chevron-right"></i></button>
         </div>
         <div class="calendar-grid">
           <div class="calendar-day-header">Mo</div>
           <div class="calendar-day-header">Di</div>
           <div class="calendar-day-header">Mi</div>
           <div class="calendar-day-header">Do</div>
           <div class="calendar-day-header">Fr</div>
           <div class="calendar-day-header">Sa</div>
           <div class="calendar-day-header">So</div>
     `;

      // Previous Month Days
      for (let i = 0; i < startOffset; i++) {
        const day = daysInPrevMonth - startOffset + i + 1;
        html += `
          <div class="calendar-day other-month" style="background:#f9fafb; color:#ccc; pointer-events:none;">
            <div class="calendar-date">${day}</div>
          </div>
        `;
      }

      // Current Month Days
      const todayStr = new Date().toISOString().split('T')[0];

      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

        // Removed weekend highlighting logic to treat all days same
        const dayBookings = bookings.filter(b => b.date === dateStr);
        const isToday = dateStr === todayStr;

        html += `
          <div class="calendar-day ${isToday ? 'today' : ''}" onclick="openBookingModal('${dateStr}')" style="min-height: 60px;">
            <div class="calendar-date">${day}</div>
            <div class="calendar-bookings">
              ${dayBookings.map(b => `
                <div class="booking-dot ${b.status || 'pending'}">
                  ${b.name.split(' ')[0]}
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }

      // Next Month Days
      const totalCells = startOffset + daysInMonth;
      const remaining = 42 - totalCells; // Fixed 6 rows grid

      for (let i = 1; i <= remaining; i++) {
        html += `
          <div class="calendar-day other-month" style="background:#f9fafb; color:#ccc; pointer-events:none;">
            <div class="calendar-date">${i}</div>
          </div>
        `;
      }

      html += `</div></div>`;

      const wrapper = document.getElementById('calendar-wrapper');
      if (wrapper) wrapper.innerHTML = html;
    }

    window.changeMonth = function (delta) {
      currentDate.setMonth(currentDate.getMonth() + delta);
      renderCalendar();
    }

    window.openBookingModal = function (dateStr = null) {
      document.getElementById('bookingModalTitle').innerHTML = dateStr ?
        `<i class="fas fa-calendar-plus"></i> Buchung für ${dateStr}` :
        '<i class="fas fa-calendar-plus"></i> Neue Buchung';

      document.getElementById('manualBookingForm').reset();
      document.getElementById('m_id').value = '';
      if (dateStr) {
        document.getElementById('m_date').value = dateStr;
      } else {
        document.getElementById('m_date').value = new Date().toISOString().split('T')[0];
      }
      document.getElementById('manualBookingModal').classList.remove('hidden');
    }

    // --- BOOKINGS LOGIC ---
    let currentFilter = 'all';

    function setFilter(filter) {
      currentFilter = filter;
      renderBookings();

      // Update active state of buttons
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.filter === filter);
        btn.style.background = btn.dataset.filter === filter ? '#000' : '#f1f5f9';
        btn.style.color = btn.dataset.filter === filter ? '#fff' : '#000';
      });
    }

    function getBookings() {
      return JSON.parse(localStorage.getItem(ACTIVE_KEY) || '[]');
    }

    // ... renderCalendar stays same ...

    function renderBookings() {
      const list = document.getElementById('bookingsList');
      let bookings = getBookings().sort((a, b) => b.id - a.id);
      const isMobile = window.innerWidth < 768;

      // Filter logic
      if (currentFilter !== 'all') {
        bookings = bookings.filter(b => b.status === currentFilter);
      }

      if (bookings.length === 0) {
        list.innerHTML = `<div style="text-align:center; padding: 2rem; color:#999;">
          <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 1rem; opacity:0.3"></i><br>
          Keine Anfragen in dieser Kategorie.
        </div>`;
        return;
      }

      if (isMobile) {
        // MOBILE CARD VIEW
        list.innerHTML = bookings.map(b => {
          const statusColor = b.status === 'confirmed' ? '#10b981' : (b.status === 'rejected' ? '#ef4444' : '#f59e0b');
          const statusBg = b.status === 'confirmed' ? '#d1fae5' : (b.status === 'rejected' ? '#fee2e2' : '#fef3c7');
          const statusText = b.status === 'confirmed' ? 'Bestätigt' : (b.status === 'rejected' ? 'Abgesagt' : 'Offen');

          return `
            <div class="card" style="padding: 1rem; margin-bottom: 0.5rem; border-left: 4px solid ${statusColor}; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); background: #fff;">
              <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                <div>
                  <h4 style="margin: 0; font-size: 1.1rem; color: #000;">${b.name}</h4>
                  <div style="font-size: 0.85rem; color: #666; margin-top: 2px;">
                    <i class="fas fa-calendar-alt"></i> ${b.date}
                    ${b.guestCount ? ` | <i class="fas fa-users"></i> ${b.guestCount}` : ''}
                  </div>
                </div>
                <span style="background: ${statusBg}; color: black; padding: 2px 10px; border-radius: 15px; font-size: 0.75rem; font-weight: 700; border: 1px solid ${statusColor};">
                  ${statusText}
                </span>
              </div>
              
              ${b.message ? `<p style="margin: 0.5rem 0 1.25rem; font-size: 0.85rem; line-height: 1.4; color: #444; background: #f8fafc; padding: 8px; border-radius: 8px; border: 1px dashed #cbd5e1;">"${b.message}"</p>` : ''}
              
              <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">
                <button onclick="toggleBookingStatus(${b.id})" class="btn" style="background: #f1f5f9; font-size: 0.75rem; padding: 8px 4px; border: none; border-radius: 8px; font-weight: 600;">
                  <i class="fas fa-sync-alt"></i> Status
                </button>
                <button onclick="editBooking(${b.id})" class="btn" style="background: #f1f5f9; font-size: 0.75rem; padding: 8px 4px; border: none; border-radius: 8px; font-weight: 600;">
                  <i class="fas fa-edit"></i> Bearb.
                </button>
                <button onclick="deleteBooking(${b.id})" class="btn" style="background: #fee2e2; color: #ef4444; font-size: 0.75rem; padding: 8px 4px; border: none; border-radius: 8px; font-weight: 600;">
                  <i class="fas fa-trash"></i> Löschen
                </button>
              </div>
            </div>
          `;
        }).join('');
      } else {
        // DESKTOP TABLE VIEW
        let tableHtml = `
          <div style="overflow-x: auto; border: 1px solid var(--border); border-radius: 8px; background: white;">
            <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
              <thead>
                <tr style="background: #f8fafc; border-bottom: 1px solid var(--border); text-align: left;">
                  <th style="padding: 0.75rem 1rem; color: var(--text-muted);">Name</th>
                  <th style="padding: 0.75rem 1rem; color: var(--text-muted);">Datum</th>
                  <th style="padding: 0.75rem 1rem; color: var(--text-muted);">Gäste</th>
                  <th style="padding: 0.75rem 1rem; color: var(--text-muted);">Status</th>
                  <th style="padding: 0.75rem 1rem; color: var(--text-muted); text-align: right;">Aktionen</th>
                </tr>
              </thead>
              <tbody>
        `;

        tableHtml += bookings.map((b, idx) => {
          const statusColor = b.status === 'confirmed' ? '#10b981' : (b.status === 'rejected' ? '#ef4444' : '#f59e0b');
          const statusBg = b.status === 'confirmed' ? '#d1fae5' : (b.status === 'rejected' ? '#fee2e2' : '#fef3c7');
          const statusText = b.status === 'confirmed' ? 'Bestätigt' : (b.status === 'rejected' ? 'Abgesagt' : 'Offen');

          return `
            <tr style="border-bottom: 1px solid #eee; transition: background 0.2s;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
              <td style="padding: 0.75rem 1rem; font-weight: 600;">
                ${b.name}
                ${b.message ? `<div style="font-weight:400; color:#888; font-size:0.75rem; max-width:200px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${b.message}</div>` : ''}
              </td>
              <td style="padding: 0.75rem 1rem; white-space: nowrap;">${b.date}</td>
              <td style="padding: 0.75rem 1rem;">${b.guestCount || '-'}</td>
              <td style="padding: 0.75rem 1rem;">
                <span style="background: ${statusBg}; color: black; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; border: 1px solid ${statusColor};">
                  ${statusText}
                </span>
              </td>
              <td style="padding: 0.75rem 1rem; text-align: right;">
                 <div style="display: flex; gap: 0.25rem; justify-content: flex-end;">
                   <button onclick="toggleBookingStatus(${b.id})" class="btn btn-ghost btn-icon" title="Status" style="width:24px; height:24px; padding:0;"><i class="fas fa-sync-alt" style="font-size:0.8rem;"></i></button>
                   <button onclick="editBooking(${b.id})" class="btn btn-ghost btn-icon" title="Edit" style="width:24px; height:24px; padding:0;"><i class="fas fa-edit" style="font-size:0.8rem;"></i></button>
                   <button onclick="deleteBooking(${b.id})" class="btn btn-ghost btn-icon" title="Del" style="width:24px; height:24px; padding:0; color:#ef4444;"><i class="fas fa-trash" style="font-size:0.8rem;"></i></button>
                 </div>
              </td>
            </tr>
          `;
        }).join('');

        tableHtml += `</tbody></table></div>`;
        list.innerHTML = tableHtml;
      }
    }

    function toggleBookingStatus(id) {
      const bookings = getBookings();
      const b = bookings.find(x => x.id === id);
      if (!b) return;
      const states = ['pending', 'confirmed', 'rejected'];
      const currentIdx = states.indexOf(b.status || 'pending');
      b.status = states[(currentIdx + 1) % states.length];
      localStorage.setItem(ACTIVE_KEY, JSON.stringify(bookings));
      renderBookings();
      renderCalendar();
    }

    function deleteBooking(id) {
      if (!confirm('Buchung wirklich löschen?')) return;
      const bookings = getBookings().filter(x => x.id !== id);
      localStorage.setItem(ACTIVE_KEY, JSON.stringify(bookings));
      renderBookings();
      renderCalendar();
    }

    // --- DOWNLOAD & DIRECT SAVE ---
    let fileHandle = null;

    async function saveDirectly() {
      if (!loadedHtmlContent) {
        showNotification("Bitte zuerst index.html einlesen!", "error");
        return;
      }

      try {
        if (!fileHandle) {
          if (!window.showSaveFilePicker) {
            showNotification("Browser unterstützt das direkte Speichern nicht.", "error");
            return;
          }
          fileHandle = await window.showSaveFilePicker({
            suggestedName: 'index.html',
            types: [{ description: 'HTML Datei', accept: { 'text/html': ['.html'] } }],
          });
        }

        const writable = await fileHandle.createWritable();
        await writable.write(loadedHtmlContent);
        await writable.close();

        const btn = document.getElementById('saveDirectlyBtn');
        if (btn) {
          btn.innerHTML = "✅ Gespeichert";
          btn.style.background = "#28a745";
          setTimeout(() => {
            btn.innerHTML = '<i class="fas fa-save"></i> Speichern';
            btn.style.background = ""; // Reset
          }, 2000);
        }
        showNotification("Erfolgreich gespeichert!");

      } catch (err) {
        if (err.name !== 'AbortError') {
          console.error(err);
          showNotification("Fehler beim Speichern. Bitte nutze den Download.", "error");
        }
      }
    }

    // Attempt to re-bind save button if exists (global scope)
    const saveBtn = document.getElementById('saveDirectlyBtn');
    if (saveBtn) saveBtn.addEventListener('click', saveDirectly);

    document.getElementById('downloadBtn').addEventListener('click', () => {
      if (!loadedHtmlContent) {
        showNotification("Bitte zuerst index.html einlesen!", "error");
        return;
      }
      const blob = new Blob([loadedHtmlContent], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'index.html';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showNotification("index.html wurde heruntergeladen!");
    });

    // Check support
    if (window.showSaveFilePicker && saveBtn) {
      saveBtn.style.display = 'flex';
    }

    function editBooking(id) {
      const bookings = getBookings();
      const b = bookings.find(x => x.id === id);
      if (!b) return;

      document.getElementById('bookingModalTitle').innerHTML = '<i class="fas fa-edit"></i> Buchung bearbeiten';
      document.getElementById('m_id').value = b.id;
      document.getElementById('m_name').value = b.name || '';
      document.getElementById('m_email').value = b.email || '';
      document.getElementById('m_phone').value = b.phone || '';
      document.getElementById('m_event').value = b.eventType || '';
      document.getElementById('m_date').value = b.date || '';
      document.getElementById('m_guests').value = b.guestCount || '';
      document.getElementById('m_address').value = b.address || '';
      document.getElementById('m_message').value = b.message || '';

      document.getElementById('manualBookingModal').classList.remove('hidden');
    }

    document.getElementById('manualBookingForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const id = document.getElementById('m_id').value;
      const bookings = getBookings();

      const bookingData = {
        name: document.getElementById('m_name').value,
        email: document.getElementById('m_email').value,
        phone: document.getElementById('m_phone').value,
        eventType: document.getElementById('m_event').value,
        date: document.getElementById('m_date').value,
        guestCount: document.getElementById('m_guests').value,
        address: document.getElementById('m_address').value,
        message: document.getElementById('m_message').value
      };

      if (id) {
        // Update
        const index = bookings.findIndex(b => b.id == id);
        if (index !== -1) {
          bookings[index] = { ...bookings[index], ...bookingData };
        }
      } else {
        // New
        bookings.push({
          id: Date.now(),
          ...bookingData,
          status: 'confirmed',
          time: new Date().toLocaleString('de-DE')
        });
      }

      localStorage.setItem(ACTIVE_KEY, JSON.stringify(bookings));
      document.getElementById('manualBookingModal').classList.add('hidden');
      document.getElementById('manualBookingForm').reset();
      renderBookings();
      renderCalendar();
      showNotification(id ? "Buchung aktualisiert!" : "Buchung hinzugefügt!");
    });

    function createNewProject() {
      if (loadedHtmlContent && !confirm("Möchtest du wirklich neu anfangen? Ungespeicherte Änderungen gehen verloren."))
        return;

      loadedHtmlContent = `
<!DOCTYPE html>
<html lang="de">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Neues Projekt</title>
  <style id="cms-theme-style">
    :root {
      --font-heading: 'Plus Jakarta Sans', sans-serif;
      --font-body: 'Plus Jakarta Sans', sans-serif;
      --size-h1: 3.5rem;
      --size-h2: 2.2rem;
      --size-p: 1.1rem;
      --primary: #000000;
      --accent: #d4af37;
      --bg-body: #ffffff;
      --text-main: #111111;
      --text-muted: #666666;
    }

    * {
      box-sizing: border-box;
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      margin: 0;
      font-family: var(--font-body);
      background: var(--bg-body);
      color: var(--text-main);
      line-height: 1.6;
    }

    h1,
    h2,
    h3 {
      font-family: var(--font-heading);
      line-height: 1.2;
    }

    h1 {
      font-size: var(--size-h1);
    }

    h2 {
      font-size: var(--size-h2);
    }

    p {
      font-size: var(--size-p);
      color: var(--text-muted);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 2rem;
    }

    .btn {
      display: inline-block;
      padding: 1rem 2rem;
      border-radius: 50px;
      text-decoration: none;
      font-weight: bold;
      transition: 0.3s;
    }

    img {
      max-width: 100%;
      height: auto;
      display: block;
    }

    /* Floating Add Section Button */
    /* 3D Gallery & Animations */
    .gallery-perspective {
      perspective: 1200px;
      height: 600px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      background: #000; /* Dark background for Highlight effect */
    }
    
    .gallery-spinner {
      position: relative;
      width: 320px;
      height: 220px;
      transform-style: preserve-3d;
      animation: spin 30s linear infinite;
    }
    
    .gallery-spinner:hover {
      animation-play-state: paused;
    }
    
    @keyframes spin {
      from { transform: rotateY(0deg); }
      to { transform: rotateY(-360deg); }
    }
    
    .gallery-item {
       position: absolute;
       top: 0;
       left: 0;
       width: 100%;
       height: 100%;
       border-radius: 12px;
       overflow: hidden;
       box-shadow: 0 5px 20px rgba(0,0,0,0.5);
       background: #fff;
       /* Transform is handled by JS */
    }

    .floating-add-btn {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      width: 60px;
      height: 60px;
      background: var(--primary);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
      z-index: 999;
      border: none;
    }

    .floating-add-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 30px rgba(0, 0, 0, 0.3);
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700;800&display=swap"
    rel="stylesheet">
</head>

<body>
  <header id="cms-header"
    style="padding: 1.5rem 0; border-bottom: 1px solid #eee; background: white; position: sticky; top: 0; z-index: 100;">
    <div class="container" style="display: flex; justify-content: space-between; align-items: center;">
      <div id="cms-logo-container" style="display: flex; align-items: center; gap: 1rem;">
        <img id="cms-logo-img" src="logo.png" alt="Logo" style="height: 40px; width: auto;">
        <div id="cms-logo-text" style="font-weight: 800; font-size: 1.5rem;">Neues Projekt</div>
      </div>
      <nav id="cms-nav" style="display: flex; gap: 2rem; font-weight: 600; align-items: center;">
        <a id="cms-nav-home" href="#hero" style="color: var(--text-main); text-decoration: none;">Start</a>
        <a id="cms-nav-services" href="#services" style="color: var(--text-main); text-decoration: none;">Leistungen</a>
        <a id="cms-nav-gallery" href="#gallery" style="color: var(--text-main); text-decoration: none;">Galerie</a>
        <a id="cms-nav-contact" href="#contact" style="color: var(--text-main); text-decoration: none;">Kontakt</a>
        <a id="cms-nav-cta" href="#contact" class="btn"
          style="background: var(--primary); color: white; padding: 0.5rem 1.25rem; font-size: 0.9rem;">Jetzt Buchen</a>
      </nav>
    </div>
  </header>

  <main id="cms-main-content">
    <!-- Hero Section -->
    <section id="hero" style="padding: 10rem 0; text-align: center; background: #f9f9f9;">
      <div class="container">
        <h1 id="cms-hero-h1">Bereit für dein Projekt?</h1>
        <p id="cms-hero-p">Gestalte deine Seite jetzt mit dem Sektions-Manager.</p>
        <a href="#services" class="btn" style="background: var(--primary); color: white;">Mehr erfahren</a>
      </div>
    </section>

    <!-- Services Section -->
    <section id="services" style="padding: 8rem 0; background: white;">
      <div class="container">
        <h2 id="cms-services-h2" style="text-align: center; margin-bottom: 3rem;">Unsere Leistungen</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
          <div style="padding: 2rem; border: 1px solid #eee; border-radius: 12px; text-align: center;">
            <h3 id="cms-service1-h3">Leistung 1</h3>
            <p id="cms-service1-p">Kurze Beschreibung deiner ersten tollen Leistung.</p>
          </div>
          <div style="padding: 2rem; border: 1px solid #eee; border-radius: 12px; text-align: center;">
            <h3 id="cms-service2-h3">Leistung 2</h3>
            <p id="cms-service2-p">Eine weitere wichtige Dienstleistung für deine Kunden.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Gallery Section -->
    <section id="gallery" style="padding: 8rem 0; background: #f9f9f9;">
      <div class="container">
        <h2 id="cms-gallery-h2" style="text-align: center; margin-bottom: 3rem;">Galerie</h2>
        <h2 id="cms-gallery-h2" style="text-align: center; margin-bottom: 3rem;">Galerie Highlights</h2>
        <div class="gallery-perspective">
          <div id="cms-gallery-grid" class="gallery-spinner">
            <div class="gallery-item"><img id="cms-gal1" src="img1.jpg" style="width: 100%; height: 100%; object-fit: cover;"></div>
            <div class="gallery-item"><img id="cms-gal2" src="img2.jpg" style="width: 100%; height: 100%; object-fit: cover;"></div>
            <div class="gallery-item"><img id="cms-gal3" src="img3.jpg" style="width: 100%; height: 100%; object-fit: cover;"></div>
            <div class="gallery-item"><img id="cms-gal4" src="img1.jpg" style="width: 100%; height: 100%; object-fit: cover;"></div>
            <div class="gallery-item"><img id="cms-gal5" src="img2.jpg" style="width: 100%; height: 100%; object-fit: cover;"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Contact Section -->
    <section id="contact" style="padding: 8rem 0; background: white;">
      <div class="container" style="text-align: center; max-width: 800px;">
        <h2 id="cms-contact-h2">Kontakt / Buchung</h2>
        <p id="cms-contact-p">Haben Sie Fragen? Schreiben Sie uns eine Nachricht oder buchen Sie direkt.</p>
        <div style="margin-top: 3rem; background: #f9f9f9; padding: 3rem; border-radius: 20px; border: 1px solid #eee;">
          <p><b>E-Mail:</b> info@beispiel.de</p>
          <p><b>Telefon:</b> +49 123 456789</p>
          <a href="mailto:info@beispiel.de" class="btn"
            style="background: var(--primary); color: white; margin-top: 1rem;">E-Mail schreiben</a>
        </div>
      </div>
    </section>
  </main>

  <footer id="cms-footer" style="padding: 4rem 0; background: #111; color: #fff;">
    <div class="container" style="text-align: center;">
      <div id="cms-footer-address">
        <b>Ihr Unternehmen</b><br>
        Musterstraße 1, 12345 Stadt
      </div>
      <p id="cms-footer-bottom" style="margin-top: 2rem; opacity: 0.5;">© 2026 Neues Projekt - Alle Rechte vorbehalten.
      </p>
    </div>
  </footer>

  <!-- Floating Add Section Button (visual only in preview) -->
  <button class="floating-add-btn" title="Neue Sektion hinzufügen">+</button>
</body>

</html>`;

      saveToHistory();
      renderCMSFields(currentTab);
      updatePreview();
      showNotification("Neues Projekt wurde initialisiert!");
      switchTab('design');
    }

    // Migrate old leads to bookings if any
    const oldLeads = localStorage.getItem('eisfavorite_leads');
    if (oldLeads) {
      try {
        const leads = JSON.parse(oldLeads);
        const currentBookings = JSON.parse(localStorage.getItem(ACTIVE_KEY) || '[]');
        leads.forEach(l => {
          if (!currentBookings.find(b => b.name === l.name && b.date === l.date)) {
            currentBookings.push({
              id: Date.now() + Math.random(),
              name: l.name,
              email: l.email,
              phone: l.phone,
              date: l.date,
              guestCount: l.guests,
              eventType: l.type,
              address: l.location,
              message: l.message,
              status: 'pending',
              time: l.timestamp ? new Date(l.timestamp).toLocaleString('de-DE') : new Date().toLocaleString('de-DE')
            });
          }
        });
        localStorage.setItem(ACTIVE_KEY, JSON.stringify(currentBookings));
        localStorage.removeItem('eisfavorite_leads');
      } catch (e) { console.error("Migration error:", e); }
    }

    // Auto refresh on storage change
    window.addEventListener('storage', (e) => {
      if (e.key === ACTIVE_KEY) {
        renderBookings();
        renderCalendar();
      }
    });




    /* ... Existing logic ... */

    // Initial check (Password Enforcement)
    if (sessionStorage.getItem('adminAuth') === 'true') {
      document.getElementById('loginCard').classList.add('hidden');
      document.getElementById('dashboard').classList.remove('hidden');
      tryAutoLoad();
      switchTab('bookings'); // Go directly to bookings
    } else {
      document.getElementById('loginCard').classList.remove('hidden');
      document.getElementById('dashboard').classList.add('hidden');
    }

    // --- THEME TOGGLE ---
    function toggleTheme() {
      document.body.classList.toggle('dark-mode');
      updateThemeIcon();
      localStorage.setItem('adminTheme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
    }

    function updateThemeIcon() {
      const icon = document.getElementById('themeIcon');
      if (icon) {
        icon.className = document.body.classList.contains('dark-mode') ? 'fas fa-moon' : 'fas fa-sun';
      }
    }

    // --- EXPORT / IMPORT BOOKINGS ---
    function exportBookings() {
      const bookings = localStorage.getItem(ACTIVE_KEY);
      if (!bookings || bookings === '[]') {
        showNotification("Keine Buchungen vorhanden.", "error");
        return;
      }
      const blob = new Blob([bookings], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `bookings_export_${new Date().toISOString().slice(0, 10)}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      showNotification("Buchungen exportiert!");
    }

    function importBookings(input) {
      const file = input.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        try {
          const json = JSON.parse(e.target.result);
          if (Array.isArray(json)) {
            const current = JSON.parse(localStorage.getItem(ACTIVE_KEY) || '[]');
            let addedCount = 0;
            let updatedCount = 0;

            json.forEach(newItem => {
              const existingIndex = current.findIndex(existing => existing.id === newItem.id);
              if (existingIndex === -1) {
                current.push(newItem);
                addedCount++;
              } else {
                // Optional: Update existing if newer? For now just skip or maybe overwrite logic if needed.
                // adhering to "Import" usually implies bringing in missing data. 
                // But if I want to "restore" a backup, I might want to overwrite.
                // Let's safe-guard: only add if new ID.
              }
            });
            localStorage.setItem(ACTIVE_KEY, JSON.stringify(current));
            renderBookings();
            renderCalendar();
            showNotification(`${addedCount} neue Buchungen importiert!`);
          } else {
            showNotification("Ungültiges Format (kein Array).", "error");
          }
        } catch (err) {
          showNotification("Fehler beim Lesen der Datei.", "error");
          console.error(err);
        }
      };
      reader.readAsText(file);
      input.value = ''; // Reset
    }

    function resetVisitorCounter() {
      if (!confirm("Möchtest du den Besucherzähler wirklich auf NULL zurücksetzen? Dies ändert den Tracking-Pfad.")) return;

      const newTimestamp = new Date().getTime();
      const basePath = "agnellobaden.github.io/snackoase247";
      // We append a timestamp to the path to reset the counter on the server side (logic: new path = new counter)
      const newPath = `${basePath}_${newTimestamp}`;
      const newUrl = `https://api.visitorbadge.io/api/visitors?path=${newPath}&label=BESUCHER&countColor=%2300f2ff&style=flat`;

      // 1. Update Sidebar Image
      const sidebarImg = document.getElementById('sidebar-visitor-img');
      if (sidebarImg) {
        sidebarImg.src = newUrl;
      }

      // 2. Update Index.html Content (if loaded)
      if (loadedHtmlContent) {
        // Regex to find the visitor badge image src. 
        // We look for the standard part of the URL.
        const regex = /https:\/\/api\.visitorbadge\.io\/api\/visitors\?path=[^"']+/g;
        if (regex.test(loadedHtmlContent)) {
          loadedHtmlContent = loadedHtmlContent.replace(regex, newUrl);
          updatePreview();
          showNotification("Zähler zurückgesetzt! Bitte index.html speichern.", "success");
        } else {
          showNotification("Zähler-Code in index.html nicht gefunden. Füge ihn neu hinzu oder lade index.html neu.", "warning");
        }
      } else {
        showNotification("Bitte zuerst index.html laden, um den Zähler dort zu aktualisieren.", "info");
      }
    }

    // Init Theme
    if (localStorage.getItem('adminTheme') === 'dark') {
      document.body.classList.add('dark-mode');
      updateThemeIcon();
    }
  </script>
  <script src="admin_gallery_mode.js"></script>
</body>

</html>